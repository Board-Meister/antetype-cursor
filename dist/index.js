var G=(f=>(f.CALC="antetype.cursor.calc",f.POSITION="antetype.cursor.position",f.DOWN="antetype.cursor.on.down",f.UP="antetype.cursor.on.up",f.MOVE="antetype.cursor.on.move",f.SLIP="antetype.cursor.on.slip",f.RESIZED="antetype.cursor.on.resized",f))(G||{}),L="selection";var R={INIT:"antetype.init",CLOSE:"antetype.close",DRAW:"antetype.draw",CALC:"antetype.calc",RECALC_FINISHED:"antetype.recalc.finished",MODULES:"antetype.modules",SETTINGS:"antetype.settings.definition",TYPE_DEFINITION:"antetype.layer.type.definition",FONTS_LOADED:"antetype.font.loaded"};var ue="core",fe="0.0.5",Ie=class{#e;#t=null;#r=null;static inject={marshal:"boardmeister/marshal",herald:"boardmeister/herald"};inject(e){this.#e=e}async loadModules(e,t){return(await this.#o()).loadModules(e,t)}register(e){let{registration:t}=e.detail;t[ue]={load:async()=>(this.#t??=(await this.#n("core.js")).default,(o,s)=>this.#t({canvas:s,modules:o,herald:this.#e.herald})),version:fe}}static subscriptions={[R.MODULES]:"register"};#n(e){return import(this.#e.marshal.getResourceUrl(this,e))}async#o(){return this.#r??=(await this.#n("helper.js")).default,new this.#r(this.#e.herald)}};var N=(e=>(e.SAVE="antetype.memento.save",e))(N||{}),oe={INIT:"antetype.init",CLOSE:"antetype.close",DRAW:"antetype.draw",CALC:"antetype.calc",RECALC_FINISHED:"antetype.recalc.finished",MODULES:"antetype.modules",SETTINGS:"antetype.settings.definition",TYPE_DEFINITION:"antetype.layer.type.definition",FONTS_LOADED:"antetype.font.loaded"},de="core",pe="0.0.5",we=class{#e;#t=null;#r=null;static inject={marshal:"boardmeister/marshal",herald:"boardmeister/herald"};inject(e){this.#e=e}async loadModules(e,t){return(await this.#o()).loadModules(e,t)}register(e){let{registration:t}=e.detail;t[de]={load:async()=>(this.#t??=(await this.#n("core.js")).default,(o,s)=>this.#t({canvas:s,modules:o,herald:this.#e.herald})),version:pe}}static subscriptions={[oe.MODULES]:"register"};#n(e){return import(this.#e.marshal.getResourceUrl(this,e))}async#o(){return this.#r??=(await this.#n("helper.js")).default,new this.#r(this.#e.herald)}};var me="memento",ve="0.0.4",ge=class{#e;#t=null;static inject={marshal:"boardmeister/marshal",herald:"boardmeister/herald"};inject(e){this.#e=e}register(e){let{registration:t}=e.detail;t[me]={load:async()=>{if(!this.#t){let o=this.#e.marshal.getResourceUrl(this,"module.js");this.#t=(await import(o)).default}return(o,s)=>this.#t({canvas:s,modules:o,herald:this.#e.herald})},version:ve}}static subscriptions={[oe.MODULES]:"register"}};function A(){let e=new WeakMap,t=[],o=[],s=new WeakMap,i={get[Symbol.toStringTag](){return"IterableWeakMap"},get:r=>e.get(r),set:(r,n)=>(e.has(r)||(e.set(r,n),s.set(r,t.length),t.push(r),o.push(n)),i),delete:r=>!e.has(r)&&s.has(r)?!1:(e.has(r)&&e.delete(r),s.has(r)&&(t.splice(s.get(r),1),o.splice(s.get(r),1),s.delete(r),t.forEach((n,f)=>{s.set(n,f)})),!0),first:()=>o[0]??null,last:()=>o.slice(-1)[0]??null,firstKey:()=>t[0]??null,lastKey:()=>t.slice(-1)[0]??null,has:r=>e.has(r),keys:()=>[...t],values:()=>[...o],empty:()=>o.length==0,reset:function(){e=new WeakMap,s=new WeakMap,t=[],o=[]},clone:()=>{let r=A();return t.forEach(n=>{r.set(n,i.get(n))}),r}};return Object.freeze(i)}var K=(e,t)=>{let o=new CustomEvent("antetype.cursor.calc",{detail:{values:t}});return e.dispatchSync(o),o.detail.values},Y=e=>{let t=0,o=0,s=0,i=0;if((e.size||e.area?.size)&&({w:t,h:o}=e.area?.size??e.size),(e.start||e.area?.start)&&({x:s,y:i}=e.area?.start??e.start),e.hierarchy?.parent){let{start:r}=Y(e.hierarchy.parent);s+=r.x,i+=r.y}return{size:{w:t,h:o},start:{x:s,y:i}}},ye=(e,t,{x:o,y:s},{w:i,h:r})=>e>=o&&e<=i+o&&t>=s&&t<=r+s,q=(e,t,o,s=!0,i=!1)=>{for(let r=e.length-1;r>=0;r--){let n=e[r];if(s&&n.type===L)continue;let{size:f=null,start:d=null}=Y(n);if(!(!f||!d)&&ye(t,o,d,f)){if(i&&n.layout){let h=q(n.layout,t,o,s,!0);if(h)return h}return n}}return null},ae=(e,t,o,s=!0)=>{let i=[];for(let r=e.length-1;r>=0;r--){let n=e[r];if(s&&n.type===L)continue;let{size:f,start:d}=Y(n);!f||!n||!(t>=d.x&&t<=f.w+d.x&&o>=d.y&&o<=f.h+d.y)||i.push(n)}return i},P=e=>typeof e=="number"&&isNaN(e)||typeof e>"u",k=(e,t,o,s)=>{t=e.core.clone.getClone(t),t.area&&(P(t.area.start.x)||(t.area.start.x+=o),P(t.area.start.y)||(t.area.start.y+=s)),t.start&&(P(t.start.x)||(t.start.x+=o),P(t.start.y)||(t.start.y+=s));let i=e.core.clone.getOriginal(t);if(e.workspace){let n=e.workspace;i.start&&(P(i.start.x)||(i.start.x=n.toRelative(t.start.x)),P(i.start.y)||(i.start.y=n.toRelative(t.start.y,"y")));return}let r=t.area?.start??t.start;r&&i.start&&(P(i.start.x)||(i.start.x=r.x),P(i.start.y)||(i.start.y=r.y)),r&&i.area?.start&&(P(i.area.start.x)||(i.area.start.x=r.x),P(i.area.start.y)||(i.area.start.y=r.y))};function Q(e){return e.type===L?e.selection.layer:e}function $({modules:e,herald:t},o){let s=A(),i={layers:[]},r=!1,n=!1,f=!1,d=0,h=0,I=A(),S=e.core,x={moveBuffer:5},T=()=>o.select?.disabled??!1,v=()=>{for(;!s.empty();)s.delete(s.firstKey())},E=()=>{I=A()},b=y=>{let M=S.clone.getOriginal(y);return s.has(M)?M:!1},D=y=>{for(let M of y){let w=S.clone.getOriginal(M);if(s.has(w))return w}return!1},O=()=>{let y=s.keys(),M=[];y.forEach(w=>{let a=e.core.clone.getClone(w);M.push({origin:"cursor.move",layer:w,data:{x:a.area.start.x,y:a.area.start.y,after:{x:0,y:0}},undo:(c,l)=>{let u=e.core.clone.getClone(c);l.after.x=u.area.start.x,l.after.y=u.area.start.y,k(e,c,l.x-u.area.start.x,l.y-u.area.start.y)},redo:(c,l)=>{k(e,c,l.after.x-l.x,l.after.y-l.y)}})}),M.length>0&&t.dispatch(new CustomEvent(N.SAVE,{detail:{state:M}}))},C=y=>{if(!f)return!1;let{origin:{movementX:M,movementY:w}}=y.detail;return d+=M,h+=w,Math.abs(d)>x.moveBuffer||Math.abs(h)>x.moveBuffer?(f=!1,!1):!0},z=y=>{if(y.defaultPrevented||!r||C(y))return;let M=!n;n=!0;let{target:{down:w,hover:{mY:a,mX:c,layer:l}}}=y.detail;if(w.layers.length===0){!w.shiftKey&&!w.ctrlKey&&(v(),F());return}!(l&&D([l]))&&!w.shiftKey&&!w.ctrlKey&&v();let p=S.clone.getOriginal(w.layers[0]);s.set(p,!0),M&&O(),s.keys().forEach(m=>{if(m.hierarchy?.parent!==e.core.meta.document)return;let g=e.workspace?e.workspace.getScale():1;k(e,m,c/g,a/g)}),F()},B=y=>{if(y.defaultPrevented||y.detail.origin.button!==0)return;if(d=0,h=0,f=!0,r=!1,n){n=!1;return}let{target:{down:M}}=y.detail,{shiftKey:w,ctrlKey:a}=M;!w&&!a&&v();let c=!0,l=!1;for(let u of M.layers){let p=e.core.clone.getOriginal(u);if(s.has(p)&&a){s.delete(p);break}if(!I.has(p)){s.set(p,!0),l=!0,c&&E(),I.set(p,!0);break}c=!1}l||(I=A()),F()},F=()=>{for(let y of i.layers)S.manage.removeVolatile(y);i.layers=[];for(let y of s.keys()){let{size:M,start:w}=Y(S.clone.getClone(y)),a={type:L,size:M,start:w,selection:{layer:y}};i.layers.push(a),S.manage.addVolatile(a)}S.view.redraw()},H=y=>{y.defaultPrevented||y.detail.origin.button!==0||(r=!0,f=!1)},Z=t.batch([{event:"antetype.cursor.on.down",subscription:y=>{T()||H(y)}},{event:"antetype.cursor.on.up",subscription:y=>{T()||B(y)}},{event:"antetype.cursor.on.move",subscription:y=>{T()||z(y)}},{event:R.CLOSE,subscription:{method:()=>{Z()}}}]);return{selected:s,selection:i,isSelected:b,showSelected:F,resetSeeThroughStackMap:E}}function ee({herald:e,modules:{core:t},canvas:o},s,i){let r={selected:s,isDown:!1,wasMoved:!1,down:{layers:[],x:0,y:0,shiftKey:!1,ctrlKey:!1},hover:{layer:null,deep:null,x:0,y:0,mX:0,mY:0}},n=()=>i.detect?.disabled??!1,f=async(v,E)=>{let b=o.getBoundingClientRect();v-=b.left,E-=b.top;let D=new CustomEvent("antetype.cursor.position",{detail:{x:v,y:E}});return await e.dispatch(D),D.detail},d=async v=>{if(n())return;r.isDown=!0,r.wasMoved=!1;let{clientX:E,clientY:b}=v,{shiftKey:D,ctrlKey:O}=v,C=t.meta.document.layout;({x:E,y:b}=await f(E,b)),await S(v,C,E,b,0,0),r.down.x=E,r.down.y=b,r.down.shiftKey=D,r.down.ctrlKey=O,r.down.layers=ae(C,E,b),e.dispatch(new CustomEvent("antetype.cursor.on.down",{detail:{origin:v,target:r},cancelable:!0}))},h=async v=>{n()||(r.isDown=!1,await e.dispatch(new CustomEvent("antetype.cursor.on.up",{detail:{origin:v,target:r},cancelable:!0})),x(),await I(v))},I=async v=>{if(n())return;r.wasMoved=!0;let E=t.meta.document.layout,{clientX:b,clientY:D,movementX:O,movementY:C}=v;({x:b,y:D}=await f(b,D)),{movementX:O,movementY:C}=K(e,{movementX:O,movementY:C}),await S(v,E,b,D,O,C),await e.dispatch(new CustomEvent("antetype.cursor.on.move",{detail:{origin:v,target:r},cancelable:!0}))},S=async(v,E,b,D,O,C)=>{let z=q(E,b,D,!0),B=q(E,b,D,!0,!0);r.hover.x=b,r.hover.y=D,r.hover.mY=C,r.hover.mX=O,z!==r.hover.layer&&await e.dispatch(new CustomEvent("antetype.cursor.on.slip",{detail:{origin:v,target:r,from:r.hover.layer,to:z},cancelable:!0})),r.hover.layer=z,r.hover.deep=B},x=()=>{r.down.x=0,r.down.y=0,r.down.shiftKey=!1,r.down.ctrlKey=!1,r.down.layers=[]};return{onDown:d,onUp:h,onMove:I,onOut:async v=>{await e.dispatch(new CustomEvent("antetype.cursor.on.slip",{detail:{origin:v,target:r,from:r.hover.layer,to:null},cancelable:!0})),r.hover.layer=null,r.hover.deep=null}}}function te(e,t){let o=(i,r,n,f,d,h)=>{t.save(),t.beginPath(),t.moveTo(i,r),t.lineTo(i+n,r),t.lineTo(i+n,r+f),t.lineTo(i,r+f),t.closePath(),t.lineWidth=d,t.strokeStyle=h,t.stroke(),t.restore()};return{drawSelection:({start:{x:i,y:r},size:{w:n,h:f}})=>{let d=K(e,{unit:1}).unit;o(i-d*2,r-d*2,n+d*4,f+d*4,d,"#FFF"),o(i-d,r-d,n+d*2,f+d*2,d,"#1e272e")}}}function re({herald:e,canvas:t,modules:o},s,i,r){let n=8,f=!1,d=!1,h=!1,I={waiting:!1,layout:null,movement:null},S=a=>{if(!a.hover.layer)return null;let c=o.core.clone.getOriginal;for(let l of r.layers)if(c(a.hover.layer)===c(Q(l)))return l;return null},x=()=>i.resize?.disabled??!1,T=(a,c)=>{if(!a||a.selection.layer.hierarchy?.parent!==o.core.meta.document)return n=8,"default";let{start:{x:l,y:u},size:{h:p,w:m}}=a,{x:g,y:j}=c.hover,W=K(e,{bufferTop:i.resize?.buffer??10}).bufferTop,U=0,_=j<=u+W&&j>=u-U,X=g<=l+U+m&&g>=l-W+m,J=j<=u+U+p&&j>=u-W+p,V=g<=l+W&&g>=l-U;return _&&V||J&&X?(n=_&&V?6:5,"nwse-resize"):_&&X||J&&V?(n=_&&X?4:7,"nesw-resize"):_||J?(n=_?0:1,"ns-resize"):V||X?(n=V?3:2,"ew-resize"):(v(),"pointer")},v=()=>{n=8},E=a=>{if(f)return;let c=S(a.detail.target);if(c){let l=Q(o.core.clone.getClone(c));if(!o.core.clone.getOriginal(l)?.size)return}F(a),b(a)},b=a=>{let{target:c}=a.detail,l=c.selected.keys();if(l.length===0||n===8||!c.isDown)return;let{hover:{mX:u,mY:p}}=c;(n===3||n===2)&&(p=0),(n===0||n===1)&&(u=0);let m=o.workspace?o.workspace.getScale():1;if(u/=m,p/=m,d){I.waiting=!0,I.movement={x:u,y:p},I.layout=l;return}C(l),D(l,u,p)},D=(a,c,l)=>{let u=m=>{if(d=!1,I.waiting){let{layout:g,movement:j}=I,{x:W,y:U}=j;B(),D(g,W,U)}else e.dispatch(new CustomEvent("antetype.cursor.on.resized",{detail:{layout:a,success:m}}))};d=!0;let p=[];try{for(let g of a)p.push(O(g,c,l));let m=Promise.all(p);return m.then(()=>{u(!0)}).catch(()=>{u(!1)}),m}catch(m){throw u(!1),m}},O=(a,c,l)=>{let u=o.core.clone.getClone(a);if(u.hierarchy?.parent===o.core.meta.document)return n!==5&&n!==2&&n!==1&&k(o,u,n===4?0:c,n===7?0:l),(n===0||n===6||n===4)&&(l*=-1),(n===3||n===6||n===7)&&(c*=-1),z(u,c,l)},C=a=>{if(h)return;h=!0;let c=[];a.forEach(l=>{let u=o.core.clone.getClone(l);c.push({origin:"cursor.move",layer:l,data:{x:u.start.x,y:u.start.y,w:u.size.w,h:u.size.h,after:{w:0,h:0,x:0,y:0}},undo:async(p,m)=>{let g=o.core.clone.getClone(p);m.after.x=g.start.x,m.after.y=g.start.y,k(o,p,m.x-g.start.x,m.y-g.start.y),m.after.w=g.size.w,m.after.h=g.size.h,await z(p,m.w-g.size.w,m.h-g.size.h)},redo:async(p,m)=>{k(o,p,m.after.x-m.x,m.after.y-m.y),await z(p,m.after.w-m.w,m.after.h-m.h)}})}),c.length>0&&e.dispatch(new CustomEvent(N.SAVE,{detail:{state:c}}))},z=async(a,c,l)=>{if(!a.size)return;let u=o.core.clone.getClone(a);if(P(u.size.w)||(u.size.w+=c),P(u.size.h)||(u.size.h+=l),u.area&&(P(u.area.size.w)||(u.area.size.w+=c),P(u.area.size.h)||(u.area.size.h+=l)),a=o.core.clone.getOriginal(u),o.workspace){let p=o.workspace;a.size.w=p.toRelative(u.area.size.w),a.size.h=p.toRelative(u.area.size.h,"y")}else{let p=u.area?.size??u.size;a.size.w=p.w,a.size.h=p.h,a.area&&(a.area.size.w=p.w,a.area.size.h=p.h)}await o.core.view.resize(a,a.size),s(),o.core.view.redraw()},B=()=>{I.waiting=!1,I.movement=null,I.layout=null},F=a=>{let{target:c}=a.detail;if(n!==8&&(a.preventDefault(),c.isDown))return;let l=S(c);l?.type===L?t.style.cursor=T(l,c):(H(),v())},H=()=>{t.style.cursor="default"},Z=a=>{let{from:c,target:{isDown:l}}=a.detail;l&&n!==8||(v(),c?.type===L&&H())},y=a=>{let{target:c}=a.detail,l=S(c);if(l?.type===L?t.style.cursor=T(l,c):v(),n===8){f=!0;return}a.preventDefault()},M=a=>{h=!1,f=!1;let{target:c}=a.detail,l=S(c);n!==8&&a.preventDefault(),v(),l?.type===L?t.style.cursor=T(l,c):H()},w=e.batch([{event:"antetype.cursor.on.move",subscription:{method:a=>{x()||E(a)},priority:-10}},{event:"antetype.cursor.on.slip",subscription:{method:a=>{x()||Z(a)}}},{event:"antetype.cursor.on.down",subscription:{method:a=>{x()||y(a)},priority:-10}},{event:"antetype.cursor.on.up",subscription:{method:a=>{x()||M(a)},priority:-10}},{event:R.CLOSE,subscription:{method:()=>{w()}}}])}function ne({modules:e,herald:t,canvas:o},s,i){o.setAttribute("tabindex","0");let r=()=>i.delete?.disabled??!1,n=async h=>{h.forEach(I=>{e.core.manage.remove(I),s.delete(I)}),d(h),await e.core.view.recalculate(),e.core.view.redraw()},f=async h=>{h.target!==o&&h.target!==document.body||r()||(h.code==="Delete"||h.code==="Backspace")&&await n(s.keys())},d=h=>{let I=[];h.forEach(S=>{let x=e.core.clone.getOriginal(S);I.push({origin:"cursor.delete",layer:x,data:{},undo:async T=>{e.core.manage.add(T,T.hierarchy?.parent??null,T.hierarchy?.position??null),await e.core.view.recalculate()},redo:async T=>{e.core.manage.remove(T),await e.core.view.recalculate()}})}),I.length>0&&t.dispatch(new CustomEvent(N.SAVE,{detail:{state:I}}))};return{onKeyUp:f,remove:n}}function se(e){let{canvas:t,herald:o,modules:s}=e;if(!t)throw new Error("[Antetype Cursor] Canvas is empty!");let i=t.getContext("2d");s.core.setting.has("cursor")||s.core.setting.set("cursor",{});let r=new Proxy({},{get(O,C){return s.core.setting.get("cursor")[C]},set(O,C,z){let B=s.core.setting.get("cursor");return B[C]=z,!0}}),{drawSelection:n}=te(o,i),{selected:f,showSelected:d,isSelected:h,resetSeeThroughStackMap:I,selection:S}=$(e,r),{onDown:x,onUp:T,onMove:v,onOut:E}=ee(e,f,r);re(e,d,r,S);let{onKeyUp:b}=ne(e,f,r);t.addEventListener("mousedown",x,!1),t.addEventListener("mouseup",T,!1),t.addEventListener("mousemove",v,!1),t.addEventListener("mouseout",E,!1),t.addEventListener("keyup",b,!1);let D=o.batch([{event:R.CLOSE,subscription:()=>{t.removeEventListener("mousedown",x,!1),t.removeEventListener("mouseup",T,!1),t.removeEventListener("mousemove",v,!1),t.removeEventListener("mouseout",E,!1),t.removeEventListener("keyup",b,!1),D()}},{event:R.DRAW,subscription:O=>{let{element:C}=O.detail,B={selection:n}[C.type];typeof B=="function"&&B(C)}}]);return{drawSelection:n,selected:f,showSelected:d,isSelected:h,resetSeeThroughStackMap:I}}var le="cursor",ce="0.0.5",ie=class{#e;#t=null;static inject={marshal:"boardmeister/marshal",herald:"boardmeister/herald"};inject(t){this.#e=t}register(t){let{registration:o}=t.detail;o[le]={load:async()=>{if(!this.#t){let s=this.#e.marshal.getResourceUrl(this,"module.js");this.#t=(await import(s)).default}return(s,i)=>this.#t({canvas:i,modules:s,herald:this.#e.herald})},version:ce}}static subscriptions={[R.MODULES]:"register"}};export{se as Cursor,G as Event,le as ID,ce as VERSION,L as selectionType};
