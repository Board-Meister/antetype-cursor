var G=(d=>(d.CALC="antetype.cursor.calc",d.POSITION="antetype.cursor.position",d.DOWN="antetype.cursor.on.down",d.UP="antetype.cursor.on.up",d.MOVE="antetype.cursor.on.move",d.SLIP="antetype.cursor.on.slip",d.RESIZED="antetype.cursor.on.resized",d))(G||{}),R="selection";var L={INIT:"antetype.init",CLOSE:"antetype.close",DRAW:"antetype.draw",CALC:"antetype.calc",RECALC_FINISHED:"antetype.recalc.finished",MODULES:"antetype.modules",SETTINGS:"antetype.settings.definition",TYPE_DEFINITION:"antetype.layer.type.definition",FONTS_LOADED:"antetype.font.loaded",CANVAS_CHANGE:"antetype.canvas.change"};var ue="core",fe="0.0.5",Ie=class{#e;#t=null;#r=null;static inject={marshal:"boardmeister/marshal",herald:"boardmeister/herald"};inject(e){this.#e=e}async loadModules(e){return(await this.#o()).loadModules(e)}register(e){let{registration:t}=e.detail;t[ue]={load:async()=>(this.#t??=(await this.#n("core.js")).default,l=>this.#t({modules:l,herald:this.#e.herald})),version:fe}}static subscriptions={[L.MODULES]:"register"};#n(e){return import(this.#e.marshal.getResourceUrl(this,e))}async#o(){return this.#r??=(await this.#n("helper.js")).default,new this.#r(this.#e.herald)}};var A=(e=>(e.SAVE="antetype.memento.save",e))(A||{}),oe={INIT:"antetype.init",CLOSE:"antetype.close",DRAW:"antetype.draw",CALC:"antetype.calc",RECALC_FINISHED:"antetype.recalc.finished",MODULES:"antetype.modules",SETTINGS:"antetype.settings.definition",TYPE_DEFINITION:"antetype.layer.type.definition",FONTS_LOADED:"antetype.font.loaded"},de="core",ve="0.0.5",ge=class{#e;#t=null;#r=null;static inject={marshal:"boardmeister/marshal",herald:"boardmeister/herald"};inject(e){this.#e=e}async loadModules(e,t){return(await this.#o()).loadModules(e,t)}register(e){let{registration:t}=e.detail;t[de]={load:async()=>(this.#t??=(await this.#n("core.js")).default,(l,s)=>this.#t({canvas:s,modules:l,herald:this.#e.herald})),version:ve}}static subscriptions={[oe.MODULES]:"register"};#n(e){return import(this.#e.marshal.getResourceUrl(this,e))}async#o(){return this.#r??=(await this.#n("helper.js")).default,new this.#r(this.#e.herald)}};var pe="memento",me="0.0.4",we=class{#e;#t=null;static inject={marshal:"boardmeister/marshal",herald:"boardmeister/herald"};inject(e){this.#e=e}register(e){let{registration:t}=e.detail;t[pe]={load:async()=>{if(!this.#t){let l=this.#e.marshal.getResourceUrl(this,"module.js");this.#t=(await import(l)).default}return(l,s)=>this.#t({canvas:s,modules:l,herald:this.#e.herald})},version:me}}static subscriptions={[oe.MODULES]:"register"}};function F(){let e=new WeakMap,t=[],l=[],s=new WeakMap,r={get[Symbol.toStringTag](){return"IterableWeakMap"},get:o=>e.get(o),set:(o,n)=>(e.has(o)||(e.set(o,n),s.set(o,t.length),t.push(o),l.push(n)),r),delete:o=>!e.has(o)&&s.has(o)?!1:(e.has(o)&&e.delete(o),s.has(o)&&(t.splice(s.get(o),1),l.splice(s.get(o),1),s.delete(o),t.forEach((n,d)=>{s.set(n,d)})),!0),first:()=>l[0]??null,last:()=>l.slice(-1)[0]??null,firstKey:()=>t[0]??null,lastKey:()=>t.slice(-1)[0]??null,has:o=>e.has(o),keys:()=>[...t],values:()=>[...l],empty:()=>l.length==0,reset:function(){e=new WeakMap,s=new WeakMap,t=[],l=[]},clone:()=>{let o=F();return t.forEach(n=>{o.set(n,r.get(n))}),o}};return Object.freeze(r)}var U=(e,t)=>{let l=new CustomEvent("antetype.cursor.calc",{detail:{values:t}});return e.dispatchSync(l),l.detail.values},Y=e=>{let t=0,l=0,s=0,r=0;if((e.size||e.area?.size)&&({w:t,h:l}=e.area?.size??e.size),(e.start||e.area?.start)&&({x:s,y:r}=e.area?.start??e.start),e.hierarchy?.parent){let{start:o}=Y(e.hierarchy.parent);s+=o.x,r+=o.y}return{size:{w:t,h:l},start:{x:s,y:r}}},ye=(e,t,{x:l,y:s},{w:r,h:o})=>e>=l&&e<=r+l&&t>=s&&t<=o+s,q=(e,t,l,s=!0,r=!1)=>{for(let o=e.length-1;o>=0;o--){let n=e[o];if(s&&n.type===R)continue;let{size:d=null,start:f=null}=Y(n);if(!(!d||!f)&&ye(t,l,f,d)){if(r&&n.layout){let E=q(n.layout,t,l,s,!0);if(E)return E}return n}}return null},ae=(e,t,l,s=!0)=>{let r=[];for(let o=e.length-1;o>=0;o--){let n=e[o];if(s&&n.type===R)continue;let{size:d,start:f}=Y(n);!d||!n||!(t>=f.x&&t<=d.w+f.x&&l>=f.y&&l<=d.h+f.y)||r.push(n)}return r},P=e=>typeof e=="number"&&isNaN(e)||typeof e>"u",N=(e,t,l,s)=>{t=e.core.clone.getClone(t),t.area&&(P(t.area.start.x)||(t.area.start.x+=l),P(t.area.start.y)||(t.area.start.y+=s)),t.start&&(P(t.start.x)||(t.start.x+=l),P(t.start.y)||(t.start.y+=s));let r=e.core.clone.getOriginal(t);if(e.workspace){let n=e.workspace;r.start&&(P(r.start.x)||(r.start.x=n.toRelative(t.start.x)),P(r.start.y)||(r.start.y=n.toRelative(t.start.y,"y")));return}let o=t.area?.start??t.start;o&&r.start&&(P(r.start.x)||(r.start.x=o.x),P(r.start.y)||(r.start.y=o.y)),o&&r.area?.start&&(P(r.area.start.x)||(r.area.start.x=o.x),P(r.area.start.y)||(r.area.start.y=o.y))};function Q(e){return e.type===R?e.selection.layer:e}function $({modules:e,herald:t},l){let s=F(),r={layers:[]},o=!1,n=!1,d=!1,f=0,E=0,b=F(),m=e.core,T={moveBuffer:5},z=()=>l.select?.disabled??!1,h=()=>{for(;!s.empty();)s.delete(s.firstKey())},w=()=>{b=F()},g=I=>{let M=m.clone.getOriginal(I);return s.has(M)?M:!1},C=I=>{for(let M of I){let S=m.clone.getOriginal(M);if(s.has(S))return S}return!1},x=()=>{let I=s.keys(),M=[];I.forEach(S=>{let a=e.core.clone.getClone(S);M.push({origin:"cursor.move",layer:S,data:{x:a.area.start.x,y:a.area.start.y,after:{x:0,y:0}},undo:(u,c)=>{let i=e.core.clone.getClone(u);c.after.x=i.area.start.x,c.after.y=i.area.start.y,N(e,u,c.x-i.area.start.x,c.y-i.area.start.y)},redo:(u,c)=>{N(e,u,c.after.x-c.x,c.after.y-c.y)}})}),M.length>0&&t.dispatch(new CustomEvent(A.SAVE,{detail:{state:M}}))},y=I=>{if(!d)return!1;let{origin:{movementX:M,movementY:S}}=I.detail;return f+=M,E+=S,Math.abs(f)>T.moveBuffer||Math.abs(E)>T.moveBuffer?(d=!1,!1):!0},O=I=>{if(I.defaultPrevented||!o||y(I))return;let M=!n;n=!0;let{target:{down:S,hover:{mY:a,mX:u,layer:c}}}=I.detail;if(S.layers.length===0){!S.shiftKey&&!S.ctrlKey&&(h(),B());return}!(c&&C([c]))&&!S.shiftKey&&!S.ctrlKey&&h();let v=m.clone.getOriginal(S.layers[0]);s.set(v,!0),M&&x(),s.keys().forEach(p=>{if(p.hierarchy?.parent!==e.core.meta.document)return;let D=e.workspace?e.workspace.getScale():1;N(e,p,u/D,a/D)}),B()},k=I=>{if(I.defaultPrevented||I.detail.origin.button!==0)return;if(f=0,E=0,d=!0,o=!1,n){n=!1;return}let{target:{down:M}}=I.detail,{shiftKey:S,ctrlKey:a}=M;!S&&!a&&h();let u=!0,c=!1;for(let i of M.layers){let v=e.core.clone.getOriginal(i);if(s.has(v)&&a){s.delete(v);break}if(!b.has(v)){s.set(v,!0),c=!0,u&&w(),b.set(v,!0);break}u=!1}c||(b=F()),B()},B=()=>{for(let I of r.layers)m.manage.removeVolatile(I);r.layers=[];for(let I of s.keys()){let{size:M,start:S}=Y(m.clone.getClone(I)),a={type:R,size:M,start:S,selection:{layer:I}};r.layers.push(a),m.manage.addVolatile(a)}m.view.redraw()},K=I=>{I.defaultPrevented||I.detail.origin.button!==0||(o=!0,d=!1)},Z=t.batch([{event:"antetype.cursor.on.down",subscription:I=>{z()||K(I)}},{event:"antetype.cursor.on.up",subscription:I=>{z()||k(I)}},{event:"antetype.cursor.on.move",subscription:I=>{z()||O(I)}},{event:L.CLOSE,subscription:{method:()=>{Z()}}}]);return{selected:s,selection:r,isSelected:g,showSelected:B,resetSeeThroughStackMap:w}}function ee({herald:e,modules:{core:t}},l,s){let r={selected:l,isDown:!1,wasMoved:!1,down:{layers:[],x:0,y:0,shiftKey:!1,ctrlKey:!1},hover:{layer:null,deep:null,x:0,y:0,mX:0,mY:0}},o=()=>t.meta.getCanvas(),n=()=>s.detect?.disabled??!1,d=async(h,w)=>{let g=o();if(g instanceof HTMLCanvasElement){let x=g.getBoundingClientRect();h-=x.left,w-=x.top}let C=new CustomEvent("antetype.cursor.position",{detail:{x:h,y:w}});return await e.dispatch(C),C.detail},f=async h=>{if(n())return;r.isDown=!0,r.wasMoved=!1;let{clientX:w,clientY:g}=h,{shiftKey:C,ctrlKey:x}=h,y=t.meta.document.layout;({x:w,y:g}=await d(w,g)),await m(h,y,w,g,0,0),r.down.x=w,r.down.y=g,r.down.shiftKey=C,r.down.ctrlKey=x,r.down.layers=ae(y,w,g),e.dispatch(new CustomEvent("antetype.cursor.on.down",{detail:{origin:h,target:r},cancelable:!0}))},E=async h=>{n()||(r.isDown=!1,await e.dispatch(new CustomEvent("antetype.cursor.on.up",{detail:{origin:h,target:r},cancelable:!0})),T(),await b(h))},b=async h=>{if(n())return;r.wasMoved=!0;let w=t.meta.document.layout,{clientX:g,clientY:C,movementX:x,movementY:y}=h;({x:g,y:C}=await d(g,C)),{movementX:x,movementY:y}=U(e,{movementX:x,movementY:y}),await m(h,w,g,C,x,y),await e.dispatch(new CustomEvent("antetype.cursor.on.move",{detail:{origin:h,target:r},cancelable:!0}))},m=async(h,w,g,C,x,y)=>{let O=q(w,g,C,!0),k=q(w,g,C,!0,!0);r.hover.x=g,r.hover.y=C,r.hover.mY=y,r.hover.mX=x,O!==r.hover.layer&&await e.dispatch(new CustomEvent("antetype.cursor.on.slip",{detail:{origin:h,target:r,from:r.hover.layer,to:O},cancelable:!0})),r.hover.layer=O,r.hover.deep=k},T=()=>{r.down.x=0,r.down.y=0,r.down.shiftKey=!1,r.down.ctrlKey=!1,r.down.layers=[]};return{onDown:f,onUp:E,onMove:b,onOut:async h=>{await e.dispatch(new CustomEvent("antetype.cursor.on.slip",{detail:{origin:h,target:r,from:r.hover.layer,to:null},cancelable:!0})),r.hover.layer=null,r.hover.deep=null}}}function te(e,t){let l=(r,o,n,d,f,E)=>{let b=t.meta.getCanvas();if(!b)return;let m=b.getContext("2d");m.save(),m.beginPath(),m.moveTo(r,o),m.lineTo(r+n,o),m.lineTo(r+n,o+d),m.lineTo(r,o+d),m.closePath(),m.lineWidth=f,m.strokeStyle=E,m.stroke(),m.restore()};return{drawSelection:({start:{x:r,y:o},size:{w:n,h:d}})=>{let f=U(e,{unit:1}).unit;l(r-f*2,o-f*2,n+f*4,d+f*4,f,"#FFF"),l(r-f,o-f,n+f*2,d+f*2,f,"#1e272e")}}}function re({herald:e,modules:t},l,s,r){let o=()=>t.core.meta.getCanvas(),n=8,d=!1,f=!1,E=!1,b={waiting:!1,layout:null,movement:null},m=a=>{if(!a.hover.layer)return null;let u=t.core.clone.getOriginal;for(let c of r.layers)if(u(a.hover.layer)===u(Q(c)))return c;return null},T=()=>s.resize?.disabled??!1,z=(a,u)=>{if(!a||a.selection.layer.hierarchy?.parent!==t.core.meta.document)return n=8,"default";let{start:{x:c,y:i},size:{h:v,w:p}}=a,{x:D,y:H}=u.hover,j=U(e,{bufferTop:s.resize?.buffer??10}).bufferTop,W=0,_=H<=i+j&&H>=i-W,X=D<=c+W+p&&D>=c-j+p,J=H<=i+W+v&&H>=i-j+v,V=D<=c+j&&D>=c-W;return _&&V||J&&X?(n=_&&V?6:5,"nwse-resize"):_&&X||J&&V?(n=_&&X?4:7,"nesw-resize"):_||J?(n=_?0:1,"ns-resize"):V||X?(n=V?3:2,"ew-resize"):(h(),"pointer")},h=()=>{n=8},w=a=>{if(d)return;let u=m(a.detail.target);if(u){let c=Q(t.core.clone.getClone(u));if(!t.core.clone.getOriginal(c)?.size)return}B(a),g(a)},g=a=>{let{target:u}=a.detail,c=u.selected.keys();if(c.length===0||n===8||!u.isDown)return;let{hover:{mX:i,mY:v}}=u;(n===3||n===2)&&(v=0),(n===0||n===1)&&(i=0);let p=t.workspace?t.workspace.getScale():1;if(i/=p,v/=p,f){b.waiting=!0,b.movement={x:i,y:v},b.layout=c;return}y(c),C(c,i,v)},C=(a,u,c)=>{let i=p=>{if(f=!1,b.waiting){let{layout:D,movement:H}=b,{x:j,y:W}=H;k(),C(D,j,W)}else e.dispatch(new CustomEvent("antetype.cursor.on.resized",{detail:{layout:a,success:p}}))};f=!0;let v=[];try{for(let D of a)v.push(x(D,u,c));let p=Promise.all(v);return p.then(()=>{i(!0)}).catch(()=>{i(!1)}),p}catch(p){throw i(!1),p}},x=(a,u,c)=>{let i=t.core.clone.getClone(a);if(i.hierarchy?.parent===t.core.meta.document)return n!==5&&n!==2&&n!==1&&N(t,i,n===4?0:u,n===7?0:c),(n===0||n===6||n===4)&&(c*=-1),(n===3||n===6||n===7)&&(u*=-1),O(i,u,c)},y=a=>{if(E)return;E=!0;let u=[];a.forEach(c=>{let i=t.core.clone.getClone(c);u.push({origin:"cursor.move",layer:c,data:{x:i.start.x,y:i.start.y,w:i.size.w,h:i.size.h,after:{w:0,h:0,x:0,y:0}},undo:async(v,p)=>{let D=t.core.clone.getClone(v);p.after.x=D.start.x,p.after.y=D.start.y,N(t,v,p.x-D.start.x,p.y-D.start.y),p.after.w=D.size.w,p.after.h=D.size.h,await O(v,p.w-D.size.w,p.h-D.size.h)},redo:async(v,p)=>{N(t,v,p.after.x-p.x,p.after.y-p.y),await O(v,p.after.w-p.w,p.after.h-p.h)}})}),u.length>0&&e.dispatch(new CustomEvent(A.SAVE,{detail:{state:u}}))},O=async(a,u,c)=>{if(!a.size)return;let i=t.core.clone.getClone(a);if(P(i.size.w)||(i.size.w+=u),P(i.size.h)||(i.size.h+=c),i.area&&(P(i.area.size.w)||(i.area.size.w+=u),P(i.area.size.h)||(i.area.size.h+=c)),a=t.core.clone.getOriginal(i),t.workspace){let v=t.workspace;a.size.w=v.toRelative(i.area.size.w),a.size.h=v.toRelative(i.area.size.h,"y")}else{let v=i.area?.size??i.size;a.size.w=v.w,a.size.h=v.h,a.area&&(a.area.size.w=v.w,a.area.size.h=v.h)}await t.core.view.resize(a,a.size),l(),t.core.view.redraw()},k=()=>{b.waiting=!1,b.movement=null,b.layout=null},B=a=>{let{target:u}=a.detail;if(n!==8&&(a.preventDefault(),u.isDown))return;let c=m(u);if(c?.type===R){let i=o();i instanceof HTMLCanvasElement&&(i.style.cursor=z(c,u))}else K(),h()},K=()=>{let a=o();a instanceof HTMLCanvasElement&&(a.style.cursor="default")},Z=a=>{let{from:u,target:{isDown:c}}=a.detail;c&&n!==8||(h(),u?.type===R&&K())},I=a=>{let{target:u}=a.detail,c=m(u);if(c?.type===R){let i=o();i instanceof HTMLCanvasElement&&(i.style.cursor=z(c,u))}else h();if(n===8){d=!0;return}a.preventDefault()},M=a=>{E=!1,d=!1;let{target:u}=a.detail,c=m(u);if(n!==8&&a.preventDefault(),h(),c?.type===R){let i=o();i instanceof HTMLCanvasElement&&(i.style.cursor=z(c,u))}else K()},S=e.batch([{event:"antetype.cursor.on.move",subscription:{method:a=>{T()||w(a)},priority:-10}},{event:"antetype.cursor.on.slip",subscription:{method:a=>{T()||Z(a)}}},{event:"antetype.cursor.on.down",subscription:{method:a=>{T()||I(a)},priority:-10}},{event:"antetype.cursor.on.up",subscription:{method:a=>{T()||M(a)},priority:-10}},{event:L.CLOSE,subscription:{method:()=>{S()}}}])}function ne({modules:e,herald:t},l,s){let r=()=>s.delete?.disabled??!1,o=async f=>{f.forEach(E=>{e.core.manage.remove(E),l.delete(E)}),d(f),await e.core.view.recalculate(),e.core.view.redraw()},n=async f=>{let E=e.core.meta.getCanvas();f.target!==E&&f.target!==document.body||r()||(f.code==="Delete"||f.code==="Backspace")&&await o(l.keys())},d=f=>{let E=[];f.forEach(b=>{let m=e.core.clone.getOriginal(b);E.push({origin:"cursor.delete",layer:m,data:{},undo:async T=>{e.core.manage.add(T,T.hierarchy?.parent??null,T.hierarchy?.position??null),await e.core.view.recalculate()},redo:async T=>{e.core.manage.remove(T),await e.core.view.recalculate()}})}),E.length>0&&t.dispatch(new CustomEvent(A.SAVE,{detail:{state:E}}))};return{onKeyUp:n,remove:o,events:[{event:L.CANVAS_CHANGE,subscription:({detail:{current:f}})=>{f instanceof HTMLCanvasElement&&f.setAttribute("tabindex","0")}}]}}function se(e){let{herald:t,modules:l}=e;l.core.setting.has("cursor")||l.core.setting.set("cursor",{});let s=new Proxy({},{get(y,O){return l.core.setting.get("cursor")[O]},set(y,O,k){let B=l.core.setting.get("cursor");return B[O]=k,!0}}),{drawSelection:r}=te(t,l.core),{selected:o,showSelected:n,isSelected:d,resetSeeThroughStackMap:f,selection:E}=$(e,s),{onDown:b,onUp:m,onMove:T,onOut:z}=ee(e,o,s);re(e,n,s,E);let{onKeyUp:h,events:w}=ne(e,o,s),g=y=>{y instanceof HTMLCanvasElement&&(y.addEventListener("mousedown",b,!1),y.addEventListener("mouseup",m,!1),y.addEventListener("mousemove",T,!1),y.addEventListener("mouseout",z,!1),y.addEventListener("keyup",h,!1))},C=y=>{y instanceof HTMLCanvasElement&&(y.removeEventListener("mousedown",b,!1),y.removeEventListener("mouseup",m,!1),y.removeEventListener("mousemove",T,!1),y.removeEventListener("mouseout",z,!1),y.removeEventListener("keyup",h,!1))},x=t.batch([{event:L.CANVAS_CHANGE,subscription:({detail:{previous:y,current:O}})=>{C(y),g(O)}},{event:L.CLOSE,subscription:()=>{C(l.core.meta.getCanvas()),x()}},{event:L.DRAW,subscription:y=>{let{element:O}=y.detail,B={selection:r}[O.type];typeof B=="function"&&B(O)}},...w]);return{drawSelection:r,selected:o,showSelected:n,isSelected:d,resetSeeThroughStackMap:f}}var le="cursor",ce="0.0.5",ie=class{#e;#t=null;static inject={marshal:"boardmeister/marshal",herald:"boardmeister/herald"};inject(t){this.#e=t}register(t){let{registration:l}=t.detail;l[le]={load:async()=>{if(!this.#t){let s=this.#e.marshal.getResourceUrl(this,"module.js");this.#t=(await import(s)).default}return s=>this.#t({modules:s,herald:this.#e.herald})},version:ce}}static subscriptions={[L.MODULES]:"register"}};export{se as Cursor,G as Event,le as ID,ce as VERSION,R as selectionType};
