var G=(d=>(d.CALC="antetype.cursor.calc",d.POSITION="antetype.cursor.position",d.DOWN="antetype.cursor.on.down",d.UP="antetype.cursor.on.up",d.MOVE="antetype.cursor.on.move",d.SLIP="antetype.cursor.on.slip",d.RESIZED="antetype.cursor.on.resized",d))(G||{}),B="selection";var k={INIT:"antetype.init",CLOSE:"antetype.close",DRAW:"antetype.draw",CALC:"antetype.calc",RECALC_FINISHED:"antetype.recalc.finished",MODULES:"antetype.modules",SETTINGS:"antetype.settings.definition",TYPE_DEFINITION:"antetype.layer.type.definition",FONTS_LOADED:"antetype.font.loaded",CANVAS_CHANGE:"antetype.canvas.change"},he=Symbol("original"),Ie=Symbol("clone");var Ee=Symbol("layer");var ce="core",ue="0.0.5",ge=class{#e;#t=null;#r=!1;#n=null;static inject={marshal:"boardmeister/marshal",herald:"boardmeister/herald"};inject(e){this.#e=e}async loadModules(e){return(await this.#o()).loadModules(e)}register(e){let{registration:r}=e.detail;r[ce]={load:async()=>(!this.#t&&!this.#r&&(this.#r=new Promise(i=>{this.#a("core.js").then(a=>{this.#t=a.default,this.#r=!1,i()})})),this.#r&&await this.#r,console.log("load module3",this.#t),i=>this.#t({modules:i,herald:this.#e.herald})),version:ue}}static subscriptions={[k.MODULES]:"register"};#a(e){return import(this.#e.marshal.getResourceUrl(this,e))}async#o(){return this.#n??=(await this.#a("helper.js")).default,new this.#n(this.#e.herald)}};var H=(e=>(e.SAVE="antetype.memento.save",e))(H||{}),ne={INIT:"antetype.init",CLOSE:"antetype.close",DRAW:"antetype.draw",CALC:"antetype.calc",RECALC_FINISHED:"antetype.recalc.finished",MODULES:"antetype.modules",SETTINGS:"antetype.settings.definition",TYPE_DEFINITION:"antetype.layer.type.definition",FONTS_LOADED:"antetype.font.loaded"},fe="core",de="0.0.5",Ce=class{#e;#t=null;#r=null;static inject={marshal:"boardmeister/marshal",herald:"boardmeister/herald"};inject(e){this.#e=e}async loadModules(e,r){return(await this.#a()).loadModules(e,r)}register(e){let{registration:r}=e.detail;r[fe]={load:async()=>(this.#t??=(await this.#n("core.js")).default,(i,a)=>this.#t({canvas:a,modules:i,herald:this.#e.herald})),version:de}}static subscriptions={[ne.MODULES]:"register"};#n(e){return import(this.#e.marshal.getResourceUrl(this,e))}async#a(){return this.#r??=(await this.#n("helper.js")).default,new this.#r(this.#e.herald)}};var ve="memento",me="0.0.4",Se=class{#e;#t=null;static inject={marshal:"boardmeister/marshal",herald:"boardmeister/herald"};inject(e){this.#e=e}register(e){let{registration:r}=e.detail;r[ve]={load:async()=>{if(!this.#t){let i=this.#e.marshal.getResourceUrl(this,"module.js");this.#t=(await import(i)).default}return(i,a)=>this.#t({canvas:a,modules:i,herald:this.#e.herald})},version:me}}static subscriptions={[ne.MODULES]:"register"}};function F(){let e=new WeakMap,r=[],i=[],a=new WeakMap,t={get[Symbol.toStringTag](){return"IterableWeakMap"},get:o=>e.get(o),set:(o,n)=>(e.has(o)||(e.set(o,n),a.set(o,r.length),r.push(o),i.push(n)),t),delete:o=>!e.has(o)&&a.has(o)?!1:(e.has(o)&&e.delete(o),a.has(o)&&(r.splice(a.get(o),1),i.splice(a.get(o),1),a.delete(o),r.forEach((n,d)=>{a.set(n,d)})),!0),first:()=>i[0]??null,last:()=>i.slice(-1)[0]??null,firstKey:()=>r[0]??null,lastKey:()=>r.slice(-1)[0]??null,has:o=>e.has(o),keys:()=>[...r],values:()=>[...i],empty:()=>i.length==0,reset:function(){e=new WeakMap,a=new WeakMap,r=[],i=[]},clone:()=>{let o=F();return r.forEach(n=>{o.set(n,t.get(n))}),o}};return Object.freeze(t)}var K=(e,r)=>{let i=new CustomEvent("antetype.cursor.calc",{detail:{values:r}});return e.dispatchSync(i),i.detail.values},Y=e=>{let r=0,i=0,a=0,t=0;if((e.size||e.area?.size)&&({w:r,h:i}=e.area?.size??e.size),(e.start||e.area?.start)&&({x:a,y:t}=e.area?.start??e.start),e.hierarchy?.parent){let{start:o}=Y(e.hierarchy.parent);a+=o.x,t+=o.y}return{size:{w:r,h:i},start:{x:a,y:t}}},pe=(e,r,{x:i,y:a},{w:t,h:o})=>e>=i&&e<=t+i&&r>=a&&r<=o+a,q=(e,r,i,a=!0,t=!1)=>{for(let o=e.length-1;o>=0;o--){let n=e[o];if(a&&n.type===B)continue;let{size:d=null,start:f=null}=Y(n);if(!(!d||!f)&&pe(r,i,f,d)){if(t&&n.layout){let g=q(n.layout,r,i,a,!0);if(g)return g}return n}}return null},ae=(e,r,i,a=!0)=>{let t=[];for(let o=e.length-1;o>=0;o--){let n=e[o];if(a&&n.type===B)continue;let{size:d,start:f}=Y(n);!d||!n||!(r>=f.x&&r<=d.w+f.x&&i>=f.y&&i<=d.h+f.y)||t.push(n)}return t},P=e=>typeof e=="number"&&isNaN(e)||typeof e>"u",A=(e,r,i,a)=>{r=e.core.clone.getClone(r),r.area&&(P(r.area.start.x)||(r.area.start.x+=i),P(r.area.start.y)||(r.area.start.y+=a)),r.start&&(P(r.start.x)||(r.start.x+=i),P(r.start.y)||(r.start.y+=a));let t=e.core.clone.getOriginal(r);if(e.workspace){let n=e.workspace;t.start&&(P(t.start.x)||(t.start.x=n.toRelative(r.start.x)),P(t.start.y)||(t.start.y=n.toRelative(r.start.y,"y")));return}let o=r.area?.start??r.start;o&&t.start&&(P(t.start.x)||(t.start.x=o.x),P(t.start.y)||(t.start.y=o.y)),o&&t.area?.start&&(P(t.area.start.x)||(t.area.start.x=o.x),P(t.area.start.y)||(t.area.start.y=o.y))};function J(e){return e.type===B?e.selection.layer:e}function Q({modules:e},r,i){let a=F(),t={layers:[]},o=!1,n=!1,d=!1,f=0,g=0,b=F(),I=e.core,T={moveBuffer:5},R=()=>r.select?.disabled??!1,E=()=>{for(;!a.empty();)a.delete(a.firstKey())},C=()=>{b=F()},w=v=>{let p=I.clone.getOriginal(v);return a.has(p)?p:!1},D=v=>{for(let p of v){let S=I.clone.getOriginal(p);if(a.has(S))return S}return!1},x=()=>{let v=a.keys(),p=[];v.forEach(S=>{let s=e.core.clone.getClone(S);p.push({origin:"cursor.move",layer:S,data:{x:s.area.start.x,y:s.area.start.y,after:{x:0,y:0}},undo:(c,u)=>{let l=e.core.clone.getClone(c);u.after.x=l.area.start.x,u.after.y=l.area.start.y,A(e,c,u.x-l.area.start.x,u.y-l.area.start.y)},redo:(c,u)=>{A(e,c,u.after.x-u.x,u.after.y-u.y)}})}),p.length>0&&i.dispatch(new CustomEvent(H.SAVE,{detail:{state:p}}))},L=v=>{if(!d)return!1;let{origin:{movementX:p,movementY:S}}=v.detail;return f+=p,g+=S,Math.abs(f)>T.moveBuffer||Math.abs(g)>T.moveBuffer?(d=!1,!1):!0},z=v=>{if(v.defaultPrevented||!o||L(v))return;let p=!n;n=!0;let{target:{down:S,hover:{mY:s,mX:c,layer:u}}}=v.detail;if(S.layers.length===0){!S.shiftKey&&!S.ctrlKey&&(E(),m());return}!(u&&D([u]))&&!S.shiftKey&&!S.ctrlKey&&E();let y=I.clone.getOriginal(S.layers[0]);a.set(y,!0),p&&x(),a.keys().forEach(h=>{if(h.hierarchy?.parent!==e.core.meta.document)return;let M=e.workspace?e.workspace.getScale():1;A(e,h,c/M,s/M)}),m()},N=v=>{if(v.defaultPrevented||v.detail.origin.button!==0)return;if(f=0,g=0,d=!0,o=!1,n){n=!1;return}let{target:{down:p}}=v.detail,{shiftKey:S,ctrlKey:s}=p;!S&&!s&&E();let c=!0,u=!1;for(let l of p.layers){let y=e.core.clone.getOriginal(l);if(a.has(y)&&s){a.delete(y);break}if(!b.has(y)){a.set(y,!0),u=!0,c&&C(),b.set(y,!0);break}c=!1}u||(b=F()),m()},m=()=>{for(let v of t.layers)I.manage.removeVolatile(v);t.layers=[];for(let v of a.keys()){let{size:p,start:S}=Y(I.clone.getClone(v)),s={type:B,size:p,start:S,selection:{layer:v}};t.layers.push(s),I.manage.addVolatile(s)}I.view.redraw()},O=v=>{v.defaultPrevented||v.detail.origin.button!==0||(o=!0,d=!1)};return{selected:a,selection:t,isSelected:w,showSelected:m,resetSeeThroughStackMap:C,events:(v=null)=>[{event:"antetype.cursor.on.down",subscription:p=>{R()||O(p)},anchor:v},{event:"antetype.cursor.on.up",subscription:p=>{R()||N(p)},anchor:v},{event:"antetype.cursor.on.move",subscription:p=>{R()||z(p)},anchor:v}]}}function $({modules:{core:e}},r,i,a){let t={selected:r,isDown:!1,wasMoved:!1,down:{layers:[],x:0,y:0,shiftKey:!1,ctrlKey:!1},hover:{layer:null,deep:null,x:0,y:0,mX:0,mY:0}},o=()=>e.meta.getCanvas(),n=()=>i.detect?.disabled??!1,d=async(E,C)=>{let w=o();if(w instanceof HTMLCanvasElement){let x=w.getBoundingClientRect();E-=x.left,C-=x.top}let D=new CustomEvent("antetype.cursor.position",{detail:{x:E,y:C}});return await a.dispatch(D),D.detail},f=async E=>{if(n())return;t.isDown=!0,t.wasMoved=!1;let{clientX:C,clientY:w}=E,{shiftKey:D,ctrlKey:x}=E,L=e.meta.document.layout;({x:C,y:w}=await d(C,w)),await I(E,L,C,w,0,0),t.down.x=C,t.down.y=w,t.down.shiftKey=D,t.down.ctrlKey=x,t.down.layers=ae(L,C,w),a.dispatch(new CustomEvent("antetype.cursor.on.down",{detail:{origin:E,target:t},cancelable:!0}))},g=async E=>{n()||(t.isDown=!1,await a.dispatch(new CustomEvent("antetype.cursor.on.up",{detail:{origin:E,target:t},cancelable:!0})),T(),await b(E))},b=async E=>{if(n())return;t.wasMoved=!0;let C=e.meta.document.layout,{clientX:w,clientY:D,movementX:x,movementY:L}=E;({x:w,y:D}=await d(w,D)),{movementX:x,movementY:L}=K(a,{movementX:x,movementY:L}),await I(E,C,w,D,x,L),await a.dispatch(new CustomEvent("antetype.cursor.on.move",{detail:{origin:E,target:t},cancelable:!0}))},I=async(E,C,w,D,x,L)=>{let z=q(C,w,D,!0),N=q(C,w,D,!0,!0);t.hover.x=w,t.hover.y=D,t.hover.mY=L,t.hover.mX=x,z!==t.hover.layer&&await a.dispatch(new CustomEvent("antetype.cursor.on.slip",{detail:{origin:E,target:t,from:t.hover.layer,to:z},cancelable:!0})),t.hover.layer=z,t.hover.deep=N},T=()=>{t.down.x=0,t.down.y=0,t.down.shiftKey=!1,t.down.ctrlKey=!1,t.down.layers=[]};return{onDown:f,onUp:g,onMove:b,onOut:async E=>{await a.dispatch(new CustomEvent("antetype.cursor.on.slip",{detail:{origin:E,target:t,from:t.hover.layer,to:null},cancelable:!0})),t.hover.layer=null,t.hover.deep=null}}}function ee(e,r){let i=(t,o,n,d,f,g)=>{let b=r.meta.getCanvas();if(!b)return;let I=b.getContext("2d");I.save(),I.beginPath(),I.moveTo(t,o),I.lineTo(t+n,o),I.lineTo(t+n,o+d),I.lineTo(t,o+d),I.closePath(),I.lineWidth=f,I.strokeStyle=g,I.stroke(),I.restore()};return{drawSelection:({start:{x:t,y:o},size:{w:n,h:d}})=>{let f=K(e,{unit:1}).unit;i(t-f*2,o-f*2,n+f*4,d+f*4,f,"#FFF"),i(t-f,o-f,n+f*2,d+f*2,f,"#1e272e")}}}function te({modules:e},r,i,a,t){let o=()=>e.core.meta.getCanvas(),n=8,d=!1,f=!1,g=!1,b={waiting:!1,layout:null,movement:null},I=s=>{if(!s.hover.layer)return null;let c=e.core.clone.getOriginal;for(let u of a.layers)if(c(s.hover.layer)===c(J(u)))return u;return null},T=()=>i.resize?.disabled??!1,R=(s,c)=>{if(!s||s.selection.layer.hierarchy?.parent!==e.core.meta.document)return n=8,"default";let{start:{x:u,y:l},size:{h:y,w:h}}=s,{x:M,y:_}=c.hover,j=K(t,{bufferTop:i.resize?.buffer??10}).bufferTop,W=0,U=_<=l+j&&_>=l-W,X=M<=u+W+h&&M>=u-j+h,Z=_<=l+W+y&&_>=l-j+y,V=M<=u+j&&M>=u-W;return U&&V||Z&&X?(n=U&&V?6:5,"nwse-resize"):U&&X||Z&&V?(n=U&&X?4:7,"nesw-resize"):U||Z?(n=U?0:1,"ns-resize"):V||X?(n=V?3:2,"ew-resize"):(E(),"pointer")},E=()=>{n=8},C=s=>{if(d)return;let c=I(s.detail.target);if(c){let u=J(e.core.clone.getClone(c));if(!e.core.clone.getOriginal(u)?.size)return}m(s),w(s)},w=s=>{let{target:c}=s.detail,u=c.selected.keys();if(u.length===0||n===8||!c.isDown)return;let{hover:{mX:l,mY:y}}=c;(n===3||n===2)&&(y=0),(n===0||n===1)&&(l=0);let h=e.workspace?e.workspace.getScale():1;if(l/=h,y/=h,f){b.waiting=!0,b.movement={x:l,y},b.layout=u;return}L(u),D(u,l,y)},D=(s,c,u)=>{let l=h=>{if(f=!1,b.waiting){let{layout:M,movement:_}=b,{x:j,y:W}=_;N(),D(M,j,W)}else t.dispatch(new CustomEvent("antetype.cursor.on.resized",{detail:{layout:s,success:h}}))};f=!0;let y=[];try{for(let M of s)y.push(x(M,c,u));let h=Promise.all(y);return h.then(()=>{l(!0)}).catch(()=>{l(!1)}),h}catch(h){throw l(!1),h}},x=(s,c,u)=>{let l=e.core.clone.getClone(s);if(l.hierarchy?.parent===e.core.meta.document)return n!==5&&n!==2&&n!==1&&A(e,l,n===4?0:c,n===7?0:u),(n===0||n===6||n===4)&&(u*=-1),(n===3||n===6||n===7)&&(c*=-1),z(l,c,u)},L=s=>{if(g)return;g=!0;let c=[];s.forEach(u=>{let l=e.core.clone.getClone(u);c.push({origin:"cursor.move",layer:u,data:{x:l.start.x,y:l.start.y,w:l.size.w,h:l.size.h,after:{w:0,h:0,x:0,y:0}},undo:async(y,h)=>{let M=e.core.clone.getClone(y);h.after.x=M.start.x,h.after.y=M.start.y,A(e,y,h.x-M.start.x,h.y-M.start.y),h.after.w=M.size.w,h.after.h=M.size.h,await z(y,h.w-M.size.w,h.h-M.size.h)},redo:async(y,h)=>{A(e,y,h.after.x-h.x,h.after.y-h.y),await z(y,h.after.w-h.w,h.after.h-h.h)}})}),c.length>0&&t.dispatch(new CustomEvent(H.SAVE,{detail:{state:c}}))},z=async(s,c,u)=>{if(!s.size)return;let l=e.core.clone.getClone(s);if(P(l.size.w)||(l.size.w+=c),P(l.size.h)||(l.size.h+=u),l.area&&(P(l.area.size.w)||(l.area.size.w+=c),P(l.area.size.h)||(l.area.size.h+=u)),s=e.core.clone.getOriginal(l),e.workspace){let y=e.workspace;s.size.w=y.toRelative(l.area.size.w),s.size.h=y.toRelative(l.area.size.h,"y")}else{let y=l.area?.size??l.size;s.size.w=y.w,s.size.h=y.h,s.area&&(s.area.size.w=y.w,s.area.size.h=y.h)}await e.core.view.resize(s,s.size),r(),e.core.view.redraw()},N=()=>{b.waiting=!1,b.movement=null,b.layout=null},m=s=>{let{target:c}=s.detail;if(n!==8&&(s.preventDefault(),c.isDown))return;let u=I(c);if(u?.type===B){let l=o();l instanceof HTMLCanvasElement&&(l.style.cursor=R(u,c))}else O(),E()},O=()=>{let s=o();s instanceof HTMLCanvasElement&&(s.style.cursor="default")},v=s=>{let{from:c,target:{isDown:u}}=s.detail;u&&n!==8||(E(),c?.type===B&&O())},p=s=>{let{target:c}=s.detail,u=I(c);if(u?.type===B){let l=o();l instanceof HTMLCanvasElement&&(l.style.cursor=R(u,c))}else E();if(n===8){d=!0;return}s.preventDefault()},S=s=>{g=!1,d=!1;let{target:c}=s.detail,u=I(c);if(n!==8&&s.preventDefault(),E(),u?.type===B){let l=o();l instanceof HTMLCanvasElement&&(l.style.cursor=R(u,c))}else O()};return{events:(s=null)=>[{event:"antetype.cursor.on.move",subscription:{method:c=>{T()||C(c)},priority:-10},anchor:s},{event:"antetype.cursor.on.slip",subscription:{method:c=>{T()||v(c)}},anchor:s},{event:"antetype.cursor.on.down",subscription:{method:c=>{T()||p(c)},priority:-10},anchor:s},{event:"antetype.cursor.on.up",subscription:{method:c=>{T()||S(c)},priority:-10},anchor:s}]}}function re({modules:e},r,i,a){let t=()=>i.delete?.disabled??!1,o=async f=>{f.forEach(g=>{e.core.manage.remove(g),r.delete(g)}),d(f),await e.core.view.recalculate(),e.core.view.redraw()},n=async f=>{let g=e.core.meta.getCanvas();f.target!==g&&f.target!==document.body||t()||(f.code==="Delete"||f.code==="Backspace")&&await o(r.keys())},d=f=>{let g=[];f.forEach(b=>{let I=e.core.clone.getOriginal(b);g.push({origin:"cursor.delete",layer:I,data:{},undo:async T=>{e.core.manage.add(T,T.hierarchy?.parent??null,T.hierarchy?.position??null),await e.core.view.recalculate()},redo:async T=>{e.core.manage.remove(T),await e.core.view.recalculate()}})}),g.length>0&&a.dispatch(new CustomEvent(H.SAVE,{detail:{state:g}}))};return{onKeyUp:n,remove:o,events:(f=null)=>[{event:k.CANVAS_CHANGE,subscription:({detail:{current:g}})=>{g instanceof HTMLCanvasElement&&g.setAttribute("tabindex","0")},anchor:f}]}}function oe(e){let{herald:r,modules:i}=e,a={_canvas:()=>i.core.meta.getCanvas(),dispatch:(m,O={})=>r.dispatch(m,{origin:a._canvas(),...O}),dispatchSync:(m,O={})=>{r.dispatchSync(m,{origin:a._canvas(),...O})}};i.core.setting.has("cursor")||i.core.setting.set("cursor",{});let t=new Proxy({},{get(m,O){return i.core.setting.get("cursor")[O]},set(m,O,v){let p=i.core.setting.get("cursor");return p[O]=v,!0}}),{drawSelection:o}=ee(r,i.core),{selected:n,showSelected:d,isSelected:f,resetSeeThroughStackMap:g,selection:b,events:I}=Q(e,t,a),{onDown:T,onUp:R,onMove:E,onOut:C}=$(e,n,t,a),{events:w}=te(e,d,t,b,a),{onKeyUp:D,events:x}=re(e,n,t,a),L=m=>{m instanceof HTMLCanvasElement&&(m.addEventListener("mousedown",T,!1),m.addEventListener("mouseup",R,!1),m.addEventListener("mousemove",E,!1),m.addEventListener("mouseout",C,!1),m.addEventListener("keyup",D,!1))},z=m=>{m instanceof HTMLCanvasElement&&(m.removeEventListener("mousedown",T,!1),m.removeEventListener("mouseup",R,!1),m.removeEventListener("mousemove",E,!1),m.removeEventListener("mouseout",C,!1),m.removeEventListener("keyup",D,!1))},N=(m=null)=>{m??=i.core.meta.getCanvas();let O=r.batch([{event:k.CANVAS_CHANGE,subscription:({detail:{previous:v,current:p}})=>{z(v),L(p),O(),N(p)},anchor:m},{event:k.CLOSE,subscription:()=>{z(i.core.meta.getCanvas()),O()},anchor:m},{event:k.DRAW,subscription:v=>{let{element:p}=v.detail,s={selection:o}[p.type];typeof s=="function"&&s(p)},anchor:m},...x(m),...I(m),...w(m)])};return N(),{drawSelection:o,selected:n,showSelected:d,isSelected:f,resetSeeThroughStackMap:g}}var ie="cursor",le="0.0.5",se=class{#e;#t=null;static inject={marshal:"boardmeister/marshal",herald:"boardmeister/herald"};inject(r){this.#e=r}register(r){let{registration:i}=r.detail;i[ie]={load:async()=>{if(!this.#t){let a=this.#e.marshal.getResourceUrl(this,"module.js");this.#t=(await import(a)).default}return a=>this.#t({modules:a,herald:this.#e.herald})},version:le}}static subscriptions={[k.MODULES]:"register"}};export{oe as Cursor,G as Event,ie as ID,le as VERSION,B as selectionType};
