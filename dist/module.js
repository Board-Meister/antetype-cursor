var K=(e=>(e.STRUCTURE="antetype.structure",e.MIDDLE="antetype.structure.middle",e.BAR_BOTTOM="antetype.structure.bar.bottom",e.CENTER="antetype.structure.center",e.COLUMN_LEFT="antetype.structure.column.left",e.COLUMN_RIGHT="antetype.structure.column.right",e.BAR_TOP="antetype.structure.bar.top",e.MODULES="antetype.modules",e))(K||{});var X=(e=>(e.STRUCTURE="antetype.structure",e.MIDDLE="antetype.structure.middle",e.BAR_BOTTOM="antetype.structure.bar.bottom",e.CENTER="antetype.structure.center",e.COLUMN_LEFT="antetype.structure.column.left",e.COLUMN_RIGHT="antetype.structure.column.right",e.BAR_TOP="antetype.structure.bar.top",e.MODULES="antetype.modules",e))(X||{}),F=(e=>(e.INIT="antetype.init",e.DRAW="antetype.draw",e.CALC="antetype.calc",e))(F||{}),se=class{#t;#r=null;#e=null;static inject={minstrel:"boardmeister/minstrel",herald:"boardmeister/herald"};inject(e){this.#t=e}async#o(e,o){if(!this.#e){let r=this.#t.minstrel.getResourceUrl(this,"core.js");this.#r=(await import(r)).default,this.#e=this.#r({canvas:o,modules:e,injected:this.#t})}return this.#e}async register(e){let{modules:o,canvas:r}=e.detail;o.core=await this.#o(o,r)}async init(e){if(!this.#e)throw new Error("Instance not loaded, trigger registration event first");let{base:o,settings:r}=e.detail;for(let s in r)this.#e.setting.set(s,r[s]);let t=this.#e.meta.document;t.base=o;let a=[];return(this.#e.setting.get("fonts")??[]).forEach(s=>{a.push(this.#e.font.load(s))}),await Promise.all(a),t.layout=await this.#e.view.recalculate(t,t.base),await this.#e.view.redraw(t.layout),t}async cloneDefinitions(e){if(!this.#e)throw new Error("Instance not loaded, trigger registration event first");e.detail.element!==null&&(e.detail.element=await this.#e.clone.definitions(e.detail.element))}static subscriptions={[X.MODULES]:"register","antetype.init":"init","antetype.calc":[{method:"cloneDefinitions",priority:-255}]}};var Y=class{#t;#r=null;#e=null;static inject={minstrel:"boardmeister/minstrel",herald:"boardmeister/herald"};inject(o){this.#t=o}async register(o){let{modules:r,canvas:t}=o.detail;if(!this.#r){let a=this.#t.minstrel.getResourceUrl(this,"module.js");this.#r=(await import(a)).default}this.#e=r.transform=this.#r({canvas:t,modules:r,injected:this.#t})}draw(o){if(!this.#e)return;let{element:r}=o.detail,a={selection:this.#e.drawSelection}[r.type];typeof a=="function"&&a(r)}static subscriptions={[K.MODULES]:"register",[F.DRAW]:"draw"}};var J=(e=>(e.STRUCTURE="antetype.structure",e.MIDDLE="antetype.structure.middle",e.BAR_BOTTOM="antetype.structure.bar.bottom",e.CENTER="antetype.structure.center",e.COLUMN_LEFT="antetype.structure.column.left",e.COLUMN_RIGHT="antetype.structure.column.right",e.BAR_TOP="antetype.structure.bar.top",e.MODULES="antetype.modules",e))(J||{}),k=(e=>(e.SAVE="antetype.memento.save",e))(k||{}),ue=class{#t;#r=null;#e=null;static inject={minstrel:"boardmeister/minstrel",herald:"boardmeister/herald"};inject(e){this.#t=e}async register(e){let{modules:o,canvas:r}=e.detail;if(!this.#r){let t=this.#t.minstrel.getResourceUrl(this,"module.js");this.#r=(await import(t)).default}this.#e=o.transform=this.#r({canvas:r,modules:o,injected:this.#t})}save(e){this.#e&&this.#e.addToStack(e.detail.state)}static subscriptions={[J.MODULES]:"register","antetype.memento.save":"save"}};function C(){let e=new WeakMap,o=[],r=[],t=new WeakMap,a={get[Symbol.toStringTag](){return"IterableWeakMap"},get:s=>e.get(s),set:(s,l)=>(e.has(s)||(e.set(s,l),t.set(s,o.length),o.push(s),r.push(l)),a),delete:s=>!e.has(s)&&t.has(s)?!1:(e.has(s)&&e.delete(s),t.has(s)&&(o.splice(t.get(s),1),r.splice(t.get(s),1),t.delete(s),o.forEach((l,u)=>{t.set(l,u)})),!0),first:()=>r[0]??null,last:()=>r.slice(-1)[0]??null,firstKey:()=>o[0]??null,lastKey:()=>o.slice(-1)[0]??null,has:s=>e.has(s),keys:()=>[...o],values:()=>[...r],empty:()=>!!r.length,clone:()=>{let s=C();return o.forEach(l=>{s.set(l,a.get(l))}),s}};return Object.freeze(a)}var _=e=>{let o=e.area?.size??e.size,r=e.area?.start??e.start;return{size:o,start:r}},te=(e,o,{x:r,y:t},{w:a,h:s})=>e>=r&&e<=a+r&&o>=t&&o<=s+t,Q=(e,o,r,t=!0)=>{for(let a=e.length-1;a>=0;a--){let s=e[a];if(t&&s.type===S)continue;let{size:l=null,start:u=null}=_(s);if(!(!l||!u)&&te(o,r,u,l))return s}return null},Z=(e,o,r,t=!0)=>{let a=[];for(let s=e.length-1;s>=0;s--){let l=e[s];if(t&&l.type===S)continue;let{size:u,start:E}=_(l);!u||!l||!(o>=E.x&&o<=u.w+E.x&&r>=E.y&&r<=u.h+E.y)||a.push(l)}return a},b=e=>typeof e=="number"&&isNaN(e)||typeof e>"u",x=(e,o,r,t)=>{o=e.core.clone.getClone(o),o.area&&(b(o.area.start.x)||(o.area.start.x+=r),b(o.area.start.y)||(o.area.start.y+=t)),o.start&&(b(o.start.x)||(o.start.x+=r),b(o.start.y)||(o.start.y+=t));let a=e.core.clone.getOriginal(o);if(e.workspace){let l=e.workspace;a.start&&(b(a.start.x)||(a.start.x=l.toRelative(o.start.x)),b(a.start.y)||(a.start.y=l.toRelative(o.start.y,"y")));return}let s=o.area?.start??o.start;s&&a.start&&(b(a.start.x)||(a.start.x=s.x+r),b(a.start.y)||(a.start.y=s.y+t))};function ee(e){return e.type===S?e.selection.layer:e}function H({modules:e,injected:{herald:o}}){let r=C(),t=[],a=!1,s=!1,l=C(),u=e.core,E=()=>{for(;r.empty();)r.delete(r.firstKey())},d=()=>{l=C()},T=p=>{for(let y of r.keys())if(p===y)return p;return!1},h=p=>{for(let y of r.keys())if(p.includes(y))return y;return!1},g=()=>{let p=r.keys(),y=[];p.forEach(I=>{let M=e.core.clone.getOriginal(I);y.push({origin:"cursor.move",layer:M,data:{x:I.area.start.x,y:I.area.start.y,after:{x:0,y:0}},undo:(D,n)=>{let i=e.core.clone.getClone(D);n.after.x=i.area.start.x,n.after.y=i.area.start.y,x(e,D,n.x-i.area.start.x,n.y-i.area.start.y)},redo:(D,n)=>{x(e,D,n.after.x-n.x,n.after.y-n.y)}})}),y.length>0&&o.dispatch(new CustomEvent(k.SAVE,{detail:{state:y}}))},O=p=>{if(p.defaultPrevented||!a)return;let y=!s;s=!0;let{target:{down:I},origin:{movementX:M,movementY:D}}=p.detail;if(I.layers.length===0){!I.shiftKey&&!I.ctrlKey&&(E(),P());return}let n=I.layers[0],i=h(I.layers);!l.has(n)&&!i?(!I.shiftKey&&!I.ctrlKey&&E(),r.set(n,!0)):i&&r.set(i,!0),y&&g(),r.keys().forEach(c=>{x(e,c,M,D)}),P()},R=p=>{if(p.defaultPrevented)return;if(a=!1,s){s=!1;return}let{target:{down:y}}=p.detail,{shiftKey:I,ctrlKey:M}=y;!I&&!M&&E();let D=!0,n=!1;for(let i of y.layers){if(r.has(i)&&M){r.delete(i);break}if(!l.has(i)){r.set(i,!0),n=!0,D&&d(),l.set(i,!0);break}D=!1}n||(l=C()),P()},P=()=>{for(let p of t)u.manage.removeVolatile(p);t=[];for(let p of r.keys()){let{size:y,start:I}=_(p),M={type:S,size:y,start:I,selection:{layer:p}};t.push(M),u.manage.addVolatile(M)}u.view.redraw()},W=p=>{p.defaultPrevented||(a=!0)};return o.register("antetype.cursor.on.down",W),o.register("antetype.cursor.on.up",R),o.register("antetype.cursor.on.move",O),{selected:r,isSelected:T,showSelected:P}}function G({injected:{herald:e},modules:{core:o}},r){let t={selected:r,isDown:!1,down:{layers:[],x:0,y:0,shiftKey:!1,ctrlKey:!1},hover:{layer:null,x:0,y:0}},a=async(d,T)=>{let h=new CustomEvent("antetype.cursor.position",{detail:{x:d,y:T}});return await e.dispatch(h),h.detail},s=async d=>{t.isDown=!0;let{layerX:T,layerY:h}=d,{shiftKey:g,ctrlKey:O}=d,R=o.meta.document.layout;({x:T,y:h}=await a(T,h)),t.down.x=T,t.down.y=h,t.down.shiftKey=g,t.down.ctrlKey=O,t.down.layers=Z(R,T,h),e.dispatch(new CustomEvent("antetype.cursor.on.down",{detail:{origin:d,target:t},cancelable:!0}))},l=async d=>{t.isDown=!1,await e.dispatch(new CustomEvent("antetype.cursor.on.up",{detail:{origin:d,target:t},cancelable:!0})),E(),await u(d)},u=async d=>{let T=o.meta.document.layout,{layerX:h,layerY:g}=d;({x:h,y:g}=await a(h,g));let O=Q(T,h,g,!1);t.hover.x=h,t.hover.y=g,O!==t.hover.layer&&await e.dispatch(new CustomEvent("antetype.cursor.on.slip",{detail:{origin:d,target:t,from:t.hover.layer,to:O},cancelable:!0})),t.hover.layer=O,await e.dispatch(new CustomEvent("antetype.cursor.on.move",{detail:{origin:d,target:t},cancelable:!0}))},E=()=>{t.down.x=0,t.down.y=0,t.down.shiftKey=!1,t.down.ctrlKey=!1,t.down.layers=[]};return{onDown:s,onUp:l,onMove:u}}function V(e){return{drawSelection:({start:{x:r,y:t},size:{w:a,h:s}})=>{e.save(),e.beginPath(),e.moveTo(r,t),e.lineTo(r+a,t),e.lineTo(r+a,t+s),e.lineTo(r,t+s),e.closePath(),e.strokeStyle="#1e272e",e.stroke(),e.restore()}}}function q({injected:{herald:e},canvas:o,modules:r}){let t=8,a=!1,s=!1,l=!1,u={waiting:!1,layout:null,movement:null},E=(n,i)=>{let{start:{x:c,y:m},size:{h:v,w:f}}=n,{x:w,y:z}=i.hover,N=10,U=0,B=z<=m+N&&z>=m-U,j=w<=c+U+f&&w>=c-N+f,A=z<=m+U+v&&z>=m-N+v,L=w<=c+N&&w>=c-U;return B&&L||A&&j?(t=B&&L?6:5,"nwse-resize"):B&&j||A&&L?(t=B&&j?4:7,"nesw-resize"):B||A?(t=B?0:1,"ns-resize"):L||j?(t=L?3:2,"ew-resize"):(d(),"pointer")},d=()=>{t=8},T=n=>{if(a)return;let{target:{hover:{layer:i}}}=n.detail;i&&(i=ee(i),!r.core.clone.getOriginal(i)?.size)||(p(n),h(n))},h=n=>{let{target:i,origin:c}=n.detail,m=i.selected.keys();if(m.length===0||t===8||!i.isDown)return;let{movementY:v,movementX:f}=c;if((t===3||t===2)&&(v=0),(t===0||t===1)&&(f=0),s){u.waiting=!0,u.movement={x:f,y:v},u.layout=m;return}R(m),g(m,f,v)},g=(n,i,c)=>{for(let m of n)O(m,i,c)},O=(n,i,c)=>{t!==5&&t!==2&&t!==1&&x(r,n,t===4?0:i,t===7?0:c),(t===0||t===6||t===4)&&(c*=-1),(t===3||t===6||t===7)&&(i*=-1),P(n,i,c)},R=n=>{if(l)return;l=!0;let i=[];n.forEach(c=>{let m=r.core.clone.getOriginal(c);i.push({origin:"cursor.move",layer:m,data:{x:c.start.x,y:c.start.y,w:c.size.w,h:c.size.h,after:{w:0,h:0,x:0,y:0}},undo:async(v,f)=>{let w=r.core.clone.getClone(v);f.after.x=w.start.x,f.after.y=w.start.y,x(r,v,f.x-w.start.x,f.y-w.start.y),f.after.w=w.size.w,f.after.h=w.size.h,await P(v,f.w-w.size.w,f.h-w.size.h)},redo:async(v,f)=>{x(r,v,f.after.x-f.x,f.after.y-f.y),await P(v,f.after.w-f.w,f.after.h-f.h)}})}),i.length>0&&e.dispatch(new CustomEvent(k.SAVE,{detail:{state:i}}))},P=async(n,i,c)=>{if(!n.size)return;n=r.core.clone.getClone(n),n.area&&(b(n.area.size.w)||(n.area.size.w+=i),b(n.area.size.h)||(n.area.size.h+=c));let m=r.core.clone.getOriginal(n);if(r.workspace){let v=r.workspace;b(m.size.w)||(m.size.w=v.toRelative(n.area.size.w)),b(m.size.h)||(m.size.h=v.toRelative(n.area.size.h,"y"))}else{let v=n.area?.size??n.size;b(m.size?.w)||(m.size.w=v.w+i),b(m.size?.h)||(m.size.h=v.h+c)}if(s=!0,await r.core.manage.resize(m,n,m.size),r.core.view.redraw(),s=!1,u.waiting){let{layout:v,movement:f}=u,{x:w,y:z}=f;W(),g(v,w,z)}},W=()=>{u.waiting=!1,u.movement=null,u.layout=null},p=n=>{let{target:i}=n.detail;if(t!==8&&(n.preventDefault(),i.isDown))return;let c=i.hover.layer;c?.type===S?o.style.cursor=E(c,i):d()},y=()=>{o.style.cursor="default"},I=n=>{let{from:i,target:{isDown:c}}=n.detail;c&&t!==8||(d(),i?.type===S&&y())},M=n=>{if(t===8){a=!0;return}n.preventDefault()},D=n=>{l=!1,a=!1;let{target:i}=n.detail,c=i.hover.layer;t!==8&&n.preventDefault(),d(),c?.type===S?o.style.cursor=E(c,i):y()};e.register("antetype.cursor.on.move",{method:T,priority:-10}),e.register("antetype.cursor.on.slip",I),e.register("antetype.cursor.on.down",{method:M,priority:-10}),e.register("antetype.cursor.on.up",{method:D,priority:-10})}var S="selection";function re(e){let{canvas:o}=e;if(!o)throw new Error("[Antetype Cursor] Canvas is empty!");let r=o.getContext("2d"),{drawSelection:t}=V(r),{selected:a,showSelected:s,isSelected:l}=H(e),{onDown:u,onUp:E,onMove:d}=G(e,a);return q(e),o.addEventListener("mousedown",u,!1),o.addEventListener("mouseup",E,!1),o.addEventListener("mousemove",d,!1),{drawSelection:t,selected:a,showSelected:s,isSelected:l}}export{re as default,S as selectionType};
