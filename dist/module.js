var k={INIT:"antetype.init",CLOSE:"antetype.close",DRAW:"antetype.draw",CALC:"antetype.calc",RECALC_FINISHED:"antetype.recalc.finished",MODULES:"antetype.modules",SETTINGS:"antetype.settings.definition",TYPE_DEFINITION:"antetype.layer.type.definition",FONTS_LOADED:"antetype.font.loaded"};var se="core",ie="0.0.5",ve=class{#e;#t=null;#r=null;static inject={marshal:"boardmeister/marshal",herald:"boardmeister/herald"};inject(e){this.#e=e}async loadModules(e,r){return(await this.#o()).loadModules(e,r)}register(e){let{registration:r}=e.detail;r[se]={load:async()=>(this.#t??=(await this.#n("core.js")).default,(o,s)=>this.#t({canvas:s,modules:o,herald:this.#e.herald})),version:ie}}static subscriptions={[k.MODULES]:"register"};#n(e){return import(this.#e.marshal.getResourceUrl(this,e))}async#o(){return this.#r??=(await this.#n("helper.js")).default,new this.#r(this.#e.herald)}};var N=(e=>(e.SAVE="antetype.memento.save",e))(N||{}),oe={INIT:"antetype.init",CLOSE:"antetype.close",DRAW:"antetype.draw",CALC:"antetype.calc",RECALC_FINISHED:"antetype.recalc.finished",MODULES:"antetype.modules",SETTINGS:"antetype.settings.definition",TYPE_DEFINITION:"antetype.layer.type.definition",FONTS_LOADED:"antetype.font.loaded"},le="core",ce="0.0.5",he=class{#e;#t=null;#r=null;static inject={marshal:"boardmeister/marshal",herald:"boardmeister/herald"};inject(e){this.#e=e}async loadModules(e,r){return(await this.#o()).loadModules(e,r)}register(e){let{registration:r}=e.detail;r[le]={load:async()=>(this.#t??=(await this.#n("core.js")).default,(o,s)=>this.#t({canvas:s,modules:o,herald:this.#e.herald})),version:ce}}static subscriptions={[oe.MODULES]:"register"};#n(e){return import(this.#e.marshal.getResourceUrl(this,e))}async#o(){return this.#r??=(await this.#n("helper.js")).default,new this.#r(this.#e.herald)}};var ue="memento",fe="0.0.4",Ie=class{#e;#t=null;static inject={marshal:"boardmeister/marshal",herald:"boardmeister/herald"};inject(e){this.#e=e}register(e){let{registration:r}=e.detail;r[ue]={load:async()=>{if(!this.#t){let o=this.#e.marshal.getResourceUrl(this,"module.js");this.#t=(await import(o)).default}return(o,s)=>this.#t({canvas:s,modules:o,herald:this.#e.herald})},version:fe}}static subscriptions={[oe.MODULES]:"register"}};function A(){let e=new WeakMap,r=[],o=[],s=new WeakMap,i={get[Symbol.toStringTag](){return"IterableWeakMap"},get:t=>e.get(t),set:(t,n)=>(e.has(t)||(e.set(t,n),s.set(t,r.length),r.push(t),o.push(n)),i),delete:t=>!e.has(t)&&s.has(t)?!1:(e.has(t)&&e.delete(t),s.has(t)&&(r.splice(s.get(t),1),o.splice(s.get(t),1),s.delete(t),r.forEach((n,v)=>{s.set(n,v)})),!0),first:()=>o[0]??null,last:()=>o.slice(-1)[0]??null,firstKey:()=>r[0]??null,lastKey:()=>r.slice(-1)[0]??null,has:t=>e.has(t),keys:()=>[...r],values:()=>[...o],empty:()=>o.length==0,reset:function(){e=new WeakMap,s=new WeakMap,r=[],o=[]},clone:()=>{let t=A();return r.forEach(n=>{t.set(n,i.get(n))}),t}};return Object.freeze(i)}var L="selection";var j=(e,r)=>{let o=new CustomEvent("antetype.cursor.calc",{detail:{values:r}});return e.dispatchSync(o),o.detail.values},G=e=>{let r=0,o=0,s=0,i=0;if((e.size||e.area?.size)&&({w:r,h:o}=e.area?.size??e.size),(e.start||e.area?.start)&&({x:s,y:i}=e.area?.start??e.start),e.hierarchy?.parent){let{start:t}=G(e.hierarchy.parent);s+=t.x,i+=t.y}return{size:{w:r,h:o},start:{x:s,y:i}}},de=(e,r,{x:o,y:s},{w:i,h:t})=>e>=o&&e<=i+o&&r>=s&&r<=t+s,X=(e,r,o,s=!0,i=!1)=>{for(let t=e.length-1;t>=0;t--){let n=e[t];if(s&&n.type===L)continue;let{size:v=null,start:f=null}=G(n);if(!(!v||!f)&&de(r,o,f,v)){if(i&&n.layout){let h=X(n.layout,r,o,s,!0);if(h)return h}return n}}return null},ae=(e,r,o,s=!0)=>{let i=[];for(let t=e.length-1;t>=0;t--){let n=e[t];if(s&&n.type===L)continue;let{size:v,start:f}=G(n);!v||!n||!(r>=f.x&&r<=v.w+f.x&&o>=f.y&&o<=v.h+f.y)||i.push(n)}return i},P=e=>typeof e=="number"&&isNaN(e)||typeof e>"u",R=(e,r,o,s)=>{r=e.core.clone.getClone(r),r.area&&(P(r.area.start.x)||(r.area.start.x+=o),P(r.area.start.y)||(r.area.start.y+=s)),r.start&&(P(r.start.x)||(r.start.x+=o),P(r.start.y)||(r.start.y+=s));let i=e.core.clone.getOriginal(r);if(e.workspace){let n=e.workspace;i.start&&(P(i.start.x)||(i.start.x=n.toRelative(r.start.x)),P(i.start.y)||(i.start.y=n.toRelative(r.start.y,"y")));return}let t=r.area?.start??r.start;t&&i.start&&(P(i.start.x)||(i.start.x=t.x),P(i.start.y)||(i.start.y=t.y)),t&&i.area?.start&&(P(i.area.start.x)||(i.area.start.x=t.x),P(i.area.start.y)||(i.area.start.y=t.y))};function Q(e){return e.type===L?e.selection.layer:e}function $({modules:e,herald:r},o){let s=A(),i={layers:[]},t=!1,n=!1,v=!1,f=0,h=0,I=A(),S=e.core,x={moveBuffer:5},M=()=>o.select?.disabled??!1,m=()=>{for(;!s.empty();)s.delete(s.firstKey())},b=()=>{I=A()},E=y=>{let T=S.clone.getOriginal(y);return s.has(T)?T:!1},D=y=>{for(let T of y){let w=S.clone.getOriginal(T);if(s.has(w))return w}return!1},O=()=>{let y=s.keys(),T=[];y.forEach(w=>{let a=e.core.clone.getClone(w);T.push({origin:"cursor.move",layer:w,data:{x:a.area.start.x,y:a.area.start.y,after:{x:0,y:0}},undo:(c,l)=>{let u=e.core.clone.getClone(c);l.after.x=u.area.start.x,l.after.y=u.area.start.y,R(e,c,l.x-u.area.start.x,l.y-u.area.start.y)},redo:(c,l)=>{R(e,c,l.after.x-l.x,l.after.y-l.y)}})}),T.length>0&&r.dispatch(new CustomEvent(N.SAVE,{detail:{state:T}}))},C=y=>{if(!v)return!1;let{origin:{movementX:T,movementY:w}}=y.detail;return f+=T,h+=w,Math.abs(f)>x.moveBuffer||Math.abs(h)>x.moveBuffer?(v=!1,!1):!0},z=y=>{if(y.defaultPrevented||!t||C(y))return;let T=!n;n=!0;let{target:{down:w,hover:{mY:a,mX:c,layer:l}}}=y.detail;if(w.layers.length===0){!w.shiftKey&&!w.ctrlKey&&(m(),F());return}!(l&&D([l]))&&!w.shiftKey&&!w.ctrlKey&&m();let d=S.clone.getOriginal(w.layers[0]);s.set(d,!0),T&&O(),s.keys().forEach(p=>{if(p.hierarchy?.parent!==e.core.meta.document)return;let g=e.workspace?e.workspace.getScale():1;R(e,p,c/g,a/g)}),F()},B=y=>{if(y.defaultPrevented||y.detail.origin.button!==0)return;if(f=0,h=0,v=!0,t=!1,n){n=!1;return}let{target:{down:T}}=y.detail,{shiftKey:w,ctrlKey:a}=T;!w&&!a&&m();let c=!0,l=!1;for(let u of T.layers){let d=e.core.clone.getOriginal(u);if(s.has(d)&&a){s.delete(d);break}if(!I.has(d)){s.set(d,!0),l=!0,c&&b(),I.set(d,!0);break}c=!1}l||(I=A()),F()},F=()=>{for(let y of i.layers)S.manage.removeVolatile(y);i.layers=[];for(let y of s.keys()){let{size:T,start:w}=G(S.clone.getClone(y)),a={type:L,size:T,start:w,selection:{layer:y}};i.layers.push(a),S.manage.addVolatile(a)}S.view.redraw()},H=y=>{y.defaultPrevented||y.detail.origin.button!==0||(t=!0,v=!1)},q=r.batch([{event:"antetype.cursor.on.down",subscription:y=>{M()||H(y)}},{event:"antetype.cursor.on.up",subscription:y=>{M()||B(y)}},{event:"antetype.cursor.on.move",subscription:y=>{M()||z(y)}},{event:k.CLOSE,subscription:{method:()=>{q()}}}]);return{selected:s,selection:i,isSelected:E,showSelected:F,resetSeeThroughStackMap:b}}function ee({herald:e,modules:{core:r},canvas:o},s,i){let t={selected:s,isDown:!1,wasMoved:!1,down:{layers:[],x:0,y:0,shiftKey:!1,ctrlKey:!1},hover:{layer:null,deep:null,x:0,y:0,mX:0,mY:0}},n=()=>i.detect?.disabled??!1,v=async(m,b)=>{let E=o.getBoundingClientRect();m-=E.left,b-=E.top;let D=new CustomEvent("antetype.cursor.position",{detail:{x:m,y:b}});return await e.dispatch(D),D.detail},f=async m=>{if(n())return;t.isDown=!0,t.wasMoved=!1;let{clientX:b,clientY:E}=m,{shiftKey:D,ctrlKey:O}=m,C=r.meta.document.layout;({x:b,y:E}=await v(b,E)),await S(m,C,b,E,0,0),t.down.x=b,t.down.y=E,t.down.shiftKey=D,t.down.ctrlKey=O,t.down.layers=ae(C,b,E),e.dispatch(new CustomEvent("antetype.cursor.on.down",{detail:{origin:m,target:t},cancelable:!0}))},h=async m=>{n()||(t.isDown=!1,await e.dispatch(new CustomEvent("antetype.cursor.on.up",{detail:{origin:m,target:t},cancelable:!0})),x(),await I(m))},I=async m=>{if(n())return;t.wasMoved=!0;let b=r.meta.document.layout,{clientX:E,clientY:D,movementX:O,movementY:C}=m;({x:E,y:D}=await v(E,D)),{movementX:O,movementY:C}=j(e,{movementX:O,movementY:C}),await S(m,b,E,D,O,C),await e.dispatch(new CustomEvent("antetype.cursor.on.move",{detail:{origin:m,target:t},cancelable:!0}))},S=async(m,b,E,D,O,C)=>{let z=X(b,E,D,!0),B=X(b,E,D,!0,!0);t.hover.x=E,t.hover.y=D,t.hover.mY=C,t.hover.mX=O,z!==t.hover.layer&&await e.dispatch(new CustomEvent("antetype.cursor.on.slip",{detail:{origin:m,target:t,from:t.hover.layer,to:z},cancelable:!0})),t.hover.layer=z,t.hover.deep=B},x=()=>{t.down.x=0,t.down.y=0,t.down.shiftKey=!1,t.down.ctrlKey=!1,t.down.layers=[]};return{onDown:f,onUp:h,onMove:I,onOut:async m=>{await e.dispatch(new CustomEvent("antetype.cursor.on.slip",{detail:{origin:m,target:t,from:t.hover.layer,to:null},cancelable:!0})),t.hover.layer=null,t.hover.deep=null}}}function te(e,r){let o=(i,t,n,v,f,h)=>{r.save(),r.beginPath(),r.moveTo(i,t),r.lineTo(i+n,t),r.lineTo(i+n,t+v),r.lineTo(i,t+v),r.closePath(),r.lineWidth=f,r.strokeStyle=h,r.stroke(),r.restore()};return{drawSelection:({start:{x:i,y:t},size:{w:n,h:v}})=>{let f=j(e,{unit:1}).unit;o(i-f*2,t-f*2,n+f*4,v+f*4,f,"#FFF"),o(i-f,t-f,n+f*2,v+f*2,f,"#1e272e")}}}function re({herald:e,canvas:r,modules:o},s,i,t){let n=8,v=!1,f=!1,h=!1,I={waiting:!1,layout:null,movement:null},S=a=>{if(!a.hover.layer)return null;let c=o.core.clone.getOriginal;for(let l of t.layers)if(c(a.hover.layer)===c(Q(l)))return l;return null},x=()=>i.resize?.disabled??!1,M=(a,c)=>{if(!a||a.selection.layer.hierarchy?.parent!==o.core.meta.document)return n=8,"default";let{start:{x:l,y:u},size:{h:d,w:p}}=a,{x:g,y:W}=c.hover,U=j(e,{bufferTop:i.resize?.buffer??10}).bufferTop,_=0,K=W<=u+U&&W>=u-_,Y=g<=l+_+p&&g>=l-U+p,Z=W<=u+_+d&&W>=u-U+d,V=g<=l+U&&g>=l-_;return K&&V||Z&&Y?(n=K&&V?6:5,"nwse-resize"):K&&Y||Z&&V?(n=K&&Y?4:7,"nesw-resize"):K||Z?(n=K?0:1,"ns-resize"):V||Y?(n=V?3:2,"ew-resize"):(m(),"pointer")},m=()=>{n=8},b=a=>{if(v)return;let c=S(a.detail.target);if(c){let l=Q(o.core.clone.getClone(c));if(!o.core.clone.getOriginal(l)?.size)return}F(a),E(a)},E=a=>{let{target:c}=a.detail,l=c.selected.keys();if(l.length===0||n===8||!c.isDown)return;let{hover:{mX:u,mY:d}}=c;(n===3||n===2)&&(d=0),(n===0||n===1)&&(u=0);let p=o.workspace?o.workspace.getScale():1;if(u/=p,d/=p,f){I.waiting=!0,I.movement={x:u,y:d},I.layout=l;return}C(l),D(l,u,d)},D=(a,c,l)=>{let u=p=>{if(f=!1,I.waiting){let{layout:g,movement:W}=I,{x:U,y:_}=W;B(),D(g,U,_)}else e.dispatch(new CustomEvent("antetype.cursor.on.resized",{detail:{layout:a,success:p}}))};f=!0;let d=[];try{for(let g of a)d.push(O(g,c,l));let p=Promise.all(d);return p.then(()=>{u(!0)}).catch(()=>{u(!1)}),p}catch(p){throw u(!1),p}},O=(a,c,l)=>{let u=o.core.clone.getClone(a);if(u.hierarchy?.parent===o.core.meta.document)return n!==5&&n!==2&&n!==1&&R(o,u,n===4?0:c,n===7?0:l),(n===0||n===6||n===4)&&(l*=-1),(n===3||n===6||n===7)&&(c*=-1),z(u,c,l)},C=a=>{if(h)return;h=!0;let c=[];a.forEach(l=>{let u=o.core.clone.getClone(l);c.push({origin:"cursor.move",layer:l,data:{x:u.start.x,y:u.start.y,w:u.size.w,h:u.size.h,after:{w:0,h:0,x:0,y:0}},undo:async(d,p)=>{let g=o.core.clone.getClone(d);p.after.x=g.start.x,p.after.y=g.start.y,R(o,d,p.x-g.start.x,p.y-g.start.y),p.after.w=g.size.w,p.after.h=g.size.h,await z(d,p.w-g.size.w,p.h-g.size.h)},redo:async(d,p)=>{R(o,d,p.after.x-p.x,p.after.y-p.y),await z(d,p.after.w-p.w,p.after.h-p.h)}})}),c.length>0&&e.dispatch(new CustomEvent(N.SAVE,{detail:{state:c}}))},z=async(a,c,l)=>{if(!a.size)return;let u=o.core.clone.getClone(a);if(P(u.size.w)||(u.size.w+=c),P(u.size.h)||(u.size.h+=l),u.area&&(P(u.area.size.w)||(u.area.size.w+=c),P(u.area.size.h)||(u.area.size.h+=l)),a=o.core.clone.getOriginal(u),o.workspace){let d=o.workspace;a.size.w=d.toRelative(u.area.size.w),a.size.h=d.toRelative(u.area.size.h,"y")}else{let d=u.area?.size??u.size;a.size.w=d.w,a.size.h=d.h,a.area&&(a.area.size.w=d.w,a.area.size.h=d.h)}await o.core.view.resize(a,a.size),s(),o.core.view.redraw()},B=()=>{I.waiting=!1,I.movement=null,I.layout=null},F=a=>{let{target:c}=a.detail;if(n!==8&&(a.preventDefault(),c.isDown))return;let l=S(c);l?.type===L?r.style.cursor=M(l,c):(H(),m())},H=()=>{r.style.cursor="default"},q=a=>{let{from:c,target:{isDown:l}}=a.detail;l&&n!==8||(m(),c?.type===L&&H())},y=a=>{let{target:c}=a.detail,l=S(c);if(l?.type===L?r.style.cursor=M(l,c):m(),n===8){v=!0;return}a.preventDefault()},T=a=>{h=!1,v=!1;let{target:c}=a.detail,l=S(c);n!==8&&a.preventDefault(),m(),l?.type===L?r.style.cursor=M(l,c):H()},w=e.batch([{event:"antetype.cursor.on.move",subscription:{method:a=>{x()||b(a)},priority:-10}},{event:"antetype.cursor.on.slip",subscription:{method:a=>{x()||q(a)}}},{event:"antetype.cursor.on.down",subscription:{method:a=>{x()||y(a)},priority:-10}},{event:"antetype.cursor.on.up",subscription:{method:a=>{x()||T(a)},priority:-10}},{event:k.CLOSE,subscription:{method:()=>{w()}}}])}function ne({modules:e,herald:r,canvas:o},s,i){o.setAttribute("tabindex","0");let t=()=>i.delete?.disabled??!1,n=async h=>{h.forEach(I=>{e.core.manage.remove(I),s.delete(I)}),f(h),await e.core.view.recalculate(),e.core.view.redraw()},v=async h=>{h.target!==o&&h.target!==document.body||t()||(h.code==="Delete"||h.code==="Backspace")&&await n(s.keys())},f=h=>{let I=[];h.forEach(S=>{let x=e.core.clone.getOriginal(S);I.push({origin:"cursor.delete",layer:x,data:{},undo:async M=>{e.core.manage.add(M,M.hierarchy?.parent??null,M.hierarchy?.position??null),await e.core.view.recalculate()},redo:async M=>{e.core.manage.remove(M),await e.core.view.recalculate()}})}),I.length>0&&r.dispatch(new CustomEvent(N.SAVE,{detail:{state:I}}))};return{onKeyUp:v,remove:n}}function pe(e){let{canvas:r,herald:o,modules:s}=e;if(!r)throw new Error("[Antetype Cursor] Canvas is empty!");let i=r.getContext("2d");s.core.setting.has("cursor")||s.core.setting.set("cursor",{});let t=new Proxy({},{get(O,C){return s.core.setting.get("cursor")[C]},set(O,C,z){let B=s.core.setting.get("cursor");return B[C]=z,!0}}),{drawSelection:n}=te(o,i),{selected:v,showSelected:f,isSelected:h,resetSeeThroughStackMap:I,selection:S}=$(e,t),{onDown:x,onUp:M,onMove:m,onOut:b}=ee(e,v,t);re(e,f,t,S);let{onKeyUp:E}=ne(e,v,t);r.addEventListener("mousedown",x,!1),r.addEventListener("mouseup",M,!1),r.addEventListener("mousemove",m,!1),r.addEventListener("mouseout",b,!1),r.addEventListener("keyup",E,!1);let D=o.batch([{event:k.CLOSE,subscription:()=>{r.removeEventListener("mousedown",x,!1),r.removeEventListener("mouseup",M,!1),r.removeEventListener("mousemove",m,!1),r.removeEventListener("mouseout",b,!1),r.removeEventListener("keyup",E,!1),D()}},{event:k.DRAW,subscription:O=>{let{element:C}=O.detail,B={selection:n}[C.type];typeof B=="function"&&B(C)}}]);return{drawSelection:n,selected:v,showSelected:f,isSelected:h,resetSeeThroughStackMap:I}}export{pe as default};
