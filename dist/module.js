var k={INIT:"antetype.init",CLOSE:"antetype.close",DRAW:"antetype.draw",CALC:"antetype.calc",RECALC_FINISHED:"antetype.recalc.finished",MODULES:"antetype.modules",SETTINGS:"antetype.settings.definition",TYPE_DEFINITION:"antetype.layer.type.definition",FONTS_LOADED:"antetype.font.loaded"},le=class{#e;#t=null;static inject={minstrel:"boardmeister/minstrel",herald:"boardmeister/herald"};inject(e){this.#e=e}async#r(e,r){let n=this.#e.minstrel.getResourceUrl(this,"core.js");return this.#t=(await import(n)).default,this.#t({canvas:r,modules:e,herald:this.#e.herald})}async register(e){let{modules:r,canvas:n}=e.detail;r.core=await this.#r(r,n)}static subscriptions={[k.MODULES]:"register"}};var ne=class{#e;#t=null;static inject={minstrel:"boardmeister/minstrel",herald:"boardmeister/herald"};inject(r){this.#e=r}async register(r){let{modules:n,canvas:i}=r.detail;if(!this.#t){let a=this.#e.minstrel.getResourceUrl(this,"module.js");this.#t=(await import(a)).default}n.cursor=this.#t({canvas:i,modules:n,herald:this.#e.herald})}static subscriptions={[k.MODULES]:"register"}};var se=(e=>(e.INIT="antetype.init",e.CLOSE="antetype.close",e.DRAW="antetype.draw",e.CALC="antetype.calc",e.RECALC_FINISHED="antetype.recalc.finished",e.MODULES="antetype.modules",e.SETTINGS="antetype.settings.definition",e))(se||{}),N=(e=>(e.SAVE="antetype.memento.save",e))(N||{}),me=class{#e;#t=null;#r=null;static inject={minstrel:"boardmeister/minstrel",herald:"boardmeister/herald"};inject(e){this.#e=e}async register(e){let{modules:r,canvas:n}=e.detail;if(!this.#t){let i=this.#e.minstrel.getResourceUrl(this,"module.js");this.#t=(await import(i)).default}this.#r=r.memento=this.#t({canvas:n,modules:r,injected:this.#e})}save(e){this.#r&&this.#r.addToStack(e.detail.state)}static subscriptions={[se.MODULES]:"register","antetype.memento.save":"save"}};function W(){let e=new WeakMap,r=[],n=[],i=new WeakMap,a={get[Symbol.toStringTag](){return"IterableWeakMap"},get:t=>e.get(t),set:(t,o)=>(e.has(t)||(e.set(t,o),i.set(t,r.length),r.push(t),n.push(o)),a),delete:t=>!e.has(t)&&i.has(t)?!1:(e.has(t)&&e.delete(t),i.has(t)&&(r.splice(i.get(t),1),n.splice(i.get(t),1),i.delete(t),r.forEach((o,m)=>{i.set(o,m)})),!0),first:()=>n[0]??null,last:()=>n.slice(-1)[0]??null,firstKey:()=>r[0]??null,lastKey:()=>r.slice(-1)[0]??null,has:t=>e.has(t),keys:()=>[...r],values:()=>[...n],empty:()=>n.length==0,reset:function(){e=new WeakMap,i=new WeakMap,r=[],n=[]},clone:()=>{let t=W();return r.forEach(o=>{t.set(o,a.get(o))}),t}};return Object.freeze(a)}var j=(e,r)=>{let n=new CustomEvent("antetype.cursor.calc",{detail:{values:r}});return e.dispatchSync(n),n.detail.values},G=e=>{let r=0,n=0,i=0,a=0;if((e.size||e.area?.size)&&({w:r,h:n}=e.area?.size??e.size),(e.start||e.area?.start)&&({x:i,y:a}=e.area?.start??e.start),e.hierarchy?.parent){let{start:t}=G(e.hierarchy.parent);i+=t.x,a+=t.y}return{size:{w:r,h:n},start:{x:i,y:a}}},ie=(e,r,{x:n,y:i},{w:a,h:t})=>e>=n&&e<=a+n&&r>=i&&r<=t+i,X=(e,r,n,i=!0,a=!1)=>{for(let t=e.length-1;t>=0;t--){let o=e[t];if(i&&o.type===B)continue;let{size:m=null,start:f=null}=G(o);if(!(!m||!f)&&ie(r,n,f,m)){if(a&&o.layout){let I=X(o.layout,r,n,i,!0);if(I)return I}return o}}return null},ae=(e,r,n,i=!0)=>{let a=[];for(let t=e.length-1;t>=0;t--){let o=e[t];if(i&&o.type===B)continue;let{size:m,start:f}=G(o);!m||!o||!(r>=f.x&&r<=m.w+f.x&&n>=f.y&&n<=m.h+f.y)||a.push(o)}return a},x=e=>typeof e=="number"&&isNaN(e)||typeof e>"u",R=(e,r,n,i)=>{r=e.core.clone.getClone(r),r.area&&(x(r.area.start.x)||(r.area.start.x+=n),x(r.area.start.y)||(r.area.start.y+=i)),r.start&&(x(r.start.x)||(r.start.x+=n),x(r.start.y)||(r.start.y+=i));let a=e.core.clone.getOriginal(r);if(e.workspace){let o=e.workspace;a.start&&(x(a.start.x)||(a.start.x=o.toRelative(r.start.x)),x(a.start.y)||(a.start.y=o.toRelative(r.start.y,"y")));return}let t=r.area?.start??r.start;t&&a.start&&(x(a.start.x)||(a.start.x=t.x),x(a.start.y)||(a.start.y=t.y)),t&&a.area?.start&&(x(a.area.start.x)||(a.area.start.x=t.x),x(a.area.start.y)||(a.area.start.y=t.y))};function Q(e){return e.type===B?e.selection.layer:e}function $({modules:e,herald:r},n){let i=W(),a={layers:[]},t=!1,o=!1,m=!1,f=0,I=0,E=W(),g=e.core,C={moveBuffer:5},z=()=>n.select?.disabled??!1,p=()=>{for(;!i.empty();)i.delete(i.firstKey())},h=()=>{E=W()},b=y=>{let T=g.clone.getOriginal(y);return i.has(T)?T:!1},D=y=>{for(let T of y){let w=g.clone.getOriginal(T);if(i.has(w))return w}return!1},P=()=>{let y=i.keys(),T=[];y.forEach(w=>{let s=e.core.clone.getClone(w);T.push({origin:"cursor.move",layer:w,data:{x:s.area.start.x,y:s.area.start.y,after:{x:0,y:0}},undo:(l,c)=>{let u=e.core.clone.getClone(l);c.after.x=u.area.start.x,c.after.y=u.area.start.y,R(e,l,c.x-u.area.start.x,c.y-u.area.start.y)},redo:(l,c)=>{R(e,l,c.after.x-c.x,c.after.y-c.y)}})}),T.length>0&&r.dispatch(new CustomEvent(N.SAVE,{detail:{state:T}}))},M=y=>{if(!m)return!1;let{origin:{movementX:T,movementY:w}}=y.detail;return f+=T,I+=w,Math.abs(f)>C.moveBuffer||Math.abs(I)>C.moveBuffer?(m=!1,!1):!0},O=y=>{if(y.defaultPrevented||!t||M(y))return;let T=!o;o=!0;let{target:{down:w,hover:{mY:s,mX:l,layer:c}}}=y.detail;if(w.layers.length===0){!w.shiftKey&&!w.ctrlKey&&(p(),U());return}!(c&&D([c]))&&!w.shiftKey&&!w.ctrlKey&&p();let d=g.clone.getOriginal(w.layers[0]);i.set(d,!0),T&&P(),i.keys().forEach(v=>{if(v.hierarchy?.parent!==e.core.meta.document)return;let S=e.workspace?e.workspace.getScale():1;R(e,v,l/S,s/S)}),U()},L=y=>{if(y.defaultPrevented||y.detail.origin.button!==0)return;if(f=0,I=0,m=!0,t=!1,o){o=!1;return}let{target:{down:T}}=y.detail,{shiftKey:w,ctrlKey:s}=T;!w&&!s&&p();let l=!0,c=!1;for(let u of T.layers){let d=e.core.clone.getOriginal(u);if(i.has(d)&&s){i.delete(d);break}if(!E.has(d)){i.set(d,!0),c=!0,l&&h(),E.set(d,!0);break}l=!1}c||(E=W()),U()},U=()=>{for(let y of a.layers)g.manage.removeVolatile(y);a.layers=[];for(let y of i.keys()){let{size:T,start:w}=G(g.clone.getClone(y)),s={type:B,size:T,start:w,selection:{layer:y}};a.layers.push(s),g.manage.addVolatile(s)}g.view.redraw()},_=y=>{y.defaultPrevented||y.detail.origin.button!==0||(t=!0,m=!1)},q=r.batch([{event:"antetype.cursor.on.down",subscription:y=>{z()||_(y)}},{event:"antetype.cursor.on.up",subscription:y=>{z()||L(y)}},{event:"antetype.cursor.on.move",subscription:y=>{z()||O(y)}},{event:k.CLOSE,subscription:{method:()=>{q()}}}]);return{selected:i,selection:a,isSelected:b,showSelected:U,resetSeeThroughStackMap:h}}function ee({herald:e,modules:{core:r},canvas:n},i,a){let t={selected:i,isDown:!1,wasMoved:!1,down:{layers:[],x:0,y:0,shiftKey:!1,ctrlKey:!1},hover:{layer:null,deep:null,x:0,y:0,mX:0,mY:0}},o=()=>a.detect?.disabled??!1,m=async(p,h)=>{let b=n.getBoundingClientRect();p-=b.left,h-=b.top;let D=new CustomEvent("antetype.cursor.position",{detail:{x:p,y:h}});return await e.dispatch(D),D.detail},f=async p=>{if(o())return;t.isDown=!0,t.wasMoved=!1;let{clientX:h,clientY:b}=p,{shiftKey:D,ctrlKey:P}=p,M=r.meta.document.layout;({x:h,y:b}=await m(h,b)),await g(p,M,h,b,0,0),t.down.x=h,t.down.y=b,t.down.shiftKey=D,t.down.ctrlKey=P,t.down.layers=ae(M,h,b),e.dispatch(new CustomEvent("antetype.cursor.on.down",{detail:{origin:p,target:t},cancelable:!0}))},I=async p=>{o()||(t.isDown=!1,await e.dispatch(new CustomEvent("antetype.cursor.on.up",{detail:{origin:p,target:t},cancelable:!0})),C(),await E(p))},E=async p=>{if(o())return;t.wasMoved=!0;let h=r.meta.document.layout,{clientX:b,clientY:D,movementX:P,movementY:M}=p;({x:b,y:D}=await m(b,D)),{movementX:P,movementY:M}=j(e,{movementX:P,movementY:M}),await g(p,h,b,D,P,M),await e.dispatch(new CustomEvent("antetype.cursor.on.move",{detail:{origin:p,target:t},cancelable:!0}))},g=async(p,h,b,D,P,M)=>{let O=X(h,b,D,!0),L=X(h,b,D,!0,!0);t.hover.x=b,t.hover.y=D,t.hover.mY=M,t.hover.mX=P,O!==t.hover.layer&&await e.dispatch(new CustomEvent("antetype.cursor.on.slip",{detail:{origin:p,target:t,from:t.hover.layer,to:O},cancelable:!0})),t.hover.layer=O,t.hover.deep=L},C=()=>{t.down.x=0,t.down.y=0,t.down.shiftKey=!1,t.down.ctrlKey=!1,t.down.layers=[]};return{onDown:f,onUp:I,onMove:E,onOut:async p=>{await e.dispatch(new CustomEvent("antetype.cursor.on.slip",{detail:{origin:p,target:t,from:t.hover.layer,to:null},cancelable:!0})),t.hover.layer=null,t.hover.deep=null}}}function te(e,r){let n=(a,t,o,m,f,I)=>{r.save(),r.beginPath(),r.moveTo(a,t),r.lineTo(a+o,t),r.lineTo(a+o,t+m),r.lineTo(a,t+m),r.closePath(),r.lineWidth=f,r.strokeStyle=I,r.stroke(),r.restore()};return{drawSelection:({start:{x:a,y:t},size:{w:o,h:m}})=>{let f=j(e,{unit:1}).unit;n(a-f*2,t-f*2,o+f*4,m+f*4,f,"#FFF"),n(a-f,t-f,o+f*2,m+f*2,f,"#1e272e")}}}function re({herald:e,canvas:r,modules:n},i,a,t){let o=8,m=!1,f=!1,I=!1,E={waiting:!1,layout:null,movement:null},g=s=>{if(!s.hover.layer)return null;let l=n.core.clone.getOriginal;for(let c of t.layers)if(l(s.hover.layer)===l(Q(c)))return c;return null},C=()=>a.resize?.disabled??!1,z=(s,l)=>{if(!s||s.selection.layer.hierarchy?.parent!==n.core.meta.document)return o=8,"default";let{start:{x:c,y:u},size:{h:d,w:v}}=s,{x:S,y:A}=l.hover,K=j(e,{bufferTop:a.resize?.buffer??10}).bufferTop,F=0,H=A<=u+K&&A>=u-F,Y=S<=c+F+v&&S>=c-K+v,Z=A<=u+F+d&&A>=u-K+d,V=S<=c+K&&S>=c-F;return H&&V||Z&&Y?(o=H&&V?6:5,"nwse-resize"):H&&Y||Z&&V?(o=H&&Y?4:7,"nesw-resize"):H||Z?(o=H?0:1,"ns-resize"):V||Y?(o=V?3:2,"ew-resize"):(p(),"pointer")},p=()=>{o=8},h=s=>{if(m)return;let l=g(s.detail.target);if(l){let c=Q(n.core.clone.getClone(l));if(!n.core.clone.getOriginal(c)?.size)return}U(s),b(s)},b=s=>{let{target:l}=s.detail,c=l.selected.keys();if(c.length===0||o===8||!l.isDown)return;let{hover:{mX:u,mY:d}}=l;(o===3||o===2)&&(d=0),(o===0||o===1)&&(u=0);let v=n.workspace?n.workspace.getScale():1;if(u/=v,d/=v,f){E.waiting=!0,E.movement={x:u,y:d},E.layout=c;return}M(c),D(c,u,d)},D=(s,l,c)=>{let u=v=>{if(f=!1,E.waiting){let{layout:S,movement:A}=E,{x:K,y:F}=A;L(),D(S,K,F)}else e.dispatch(new CustomEvent("antetype.cursor.on.resized",{detail:{layout:s,success:v}}))};f=!0;let d=[];try{for(let S of s)d.push(P(S,l,c));let v=Promise.all(d);return v.then(()=>{u(!0)}).catch(()=>{u(!1)}),v}catch(v){throw u(!1),v}},P=(s,l,c)=>{let u=n.core.clone.getClone(s);if(u.hierarchy?.parent===n.core.meta.document)return o!==5&&o!==2&&o!==1&&R(n,u,o===4?0:l,o===7?0:c),(o===0||o===6||o===4)&&(c*=-1),(o===3||o===6||o===7)&&(l*=-1),O(u,l,c)},M=s=>{if(I)return;I=!0;let l=[];s.forEach(c=>{let u=n.core.clone.getClone(c);l.push({origin:"cursor.move",layer:c,data:{x:u.start.x,y:u.start.y,w:u.size.w,h:u.size.h,after:{w:0,h:0,x:0,y:0}},undo:async(d,v)=>{let S=n.core.clone.getClone(d);v.after.x=S.start.x,v.after.y=S.start.y,R(n,d,v.x-S.start.x,v.y-S.start.y),v.after.w=S.size.w,v.after.h=S.size.h,await O(d,v.w-S.size.w,v.h-S.size.h)},redo:async(d,v)=>{R(n,d,v.after.x-v.x,v.after.y-v.y),await O(d,v.after.w-v.w,v.after.h-v.h)}})}),l.length>0&&e.dispatch(new CustomEvent(N.SAVE,{detail:{state:l}}))},O=async(s,l,c)=>{if(!s.size)return;let u=n.core.clone.getClone(s);if(x(u.size.w)||(u.size.w+=l),x(u.size.h)||(u.size.h+=c),u.area&&(x(u.area.size.w)||(u.area.size.w+=l),x(u.area.size.h)||(u.area.size.h+=c)),s=n.core.clone.getOriginal(u),n.workspace){let d=n.workspace;s.size.w=d.toRelative(u.area.size.w),s.size.h=d.toRelative(u.area.size.h,"y")}else{let d=u.area?.size??u.size;s.size.w=d.w,s.size.h=d.h,s.area&&(s.area.size.w=d.w,s.area.size.h=d.h)}await n.core.view.resize(s,s.size),i(),n.core.view.redraw()},L=()=>{E.waiting=!1,E.movement=null,E.layout=null},U=s=>{let{target:l}=s.detail;if(o!==8&&(s.preventDefault(),l.isDown))return;let c=g(l);c?.type===B?r.style.cursor=z(c,l):(_(),p())},_=()=>{r.style.cursor="default"},q=s=>{let{from:l,target:{isDown:c}}=s.detail;c&&o!==8||(p(),l?.type===B&&_())},y=s=>{let{target:l}=s.detail,c=g(l);if(c?.type===B?r.style.cursor=z(c,l):p(),o===8){m=!0;return}s.preventDefault()},T=s=>{I=!1,m=!1;let{target:l}=s.detail,c=g(l);o!==8&&s.preventDefault(),p(),c?.type===B?r.style.cursor=z(c,l):_()},w=e.batch([{event:"antetype.cursor.on.move",subscription:{method:s=>{C()||h(s)},priority:-10}},{event:"antetype.cursor.on.slip",subscription:{method:s=>{C()||q(s)}}},{event:"antetype.cursor.on.down",subscription:{method:s=>{C()||y(s)},priority:-10}},{event:"antetype.cursor.on.up",subscription:{method:s=>{C()||T(s)},priority:-10}},{event:k.CLOSE,subscription:{method:()=>{w()}}}])}function oe({modules:e,herald:r,canvas:n},i,a){n.setAttribute("tabindex","0");let t=()=>a.delete?.disabled??!1,o=async f=>{if(!(f.target!==n&&f.target!==document.body||t())&&(f.code==="Delete"||f.code==="Backspace")){let I=i.keys();I.forEach(E=>{e.core.manage.remove(E),i.delete(E)}),m(I),await e.core.view.recalculate(),e.core.view.redraw()}},m=f=>{let I=[];f.forEach(E=>{let g=e.core.clone.getOriginal(E);I.push({origin:"cursor.delete",layer:g,data:{},undo:async C=>{e.core.manage.add(C,C.hierarchy?.parent??null,C.hierarchy?.position??null),await e.core.view.recalculate()},redo:async C=>{e.core.manage.remove(C),await e.core.view.recalculate()}})}),I.length>0&&r.dispatch(new CustomEvent(N.SAVE,{detail:{state:I}}))};return{onKeyUp:o}}var B="selection";function ce(e){let{canvas:r,herald:n,modules:i}=e;if(!r)throw new Error("[Antetype Cursor] Canvas is empty!");let a=r.getContext("2d");i.core.setting.has("cursor")||i.core.setting.set("cursor",{});let t=new Proxy({},{get(P,M){return i.core.setting.get("cursor")[M]},set(P,M,O){let L=i.core.setting.get("cursor");return L[M]=O,!0}}),{drawSelection:o}=te(n,a),{selected:m,showSelected:f,isSelected:I,resetSeeThroughStackMap:E,selection:g}=$(e,t),{onDown:C,onUp:z,onMove:p,onOut:h}=ee(e,m,t);re(e,f,t,g);let{onKeyUp:b}=oe(e,m,t);r.addEventListener("mousedown",C,!1),r.addEventListener("mouseup",z,!1),r.addEventListener("mousemove",p,!1),r.addEventListener("mouseout",h,!1),r.addEventListener("keyup",b,!1);let D=n.batch([{event:k.CLOSE,subscription:()=>{r.removeEventListener("mousedown",C,!1),r.removeEventListener("mouseup",z,!1),r.removeEventListener("mousemove",p,!1),r.removeEventListener("mouseout",h,!1),r.removeEventListener("keyup",b,!1),D()}},{event:k.DRAW,subscription:P=>{let{element:M}=P.detail,L={selection:o}[M.type];typeof L=="function"&&L(M)}}]);return{drawSelection:o,selected:m,showSelected:f,isSelected:I,resetSeeThroughStackMap:E}}export{ce as default,B as selectionType};
