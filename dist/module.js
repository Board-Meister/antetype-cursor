var O={INIT:"antetype.init",CLOSE:"antetype.close",DRAW:"antetype.draw",CALC:"antetype.calc",RECALC_FINISHED:"antetype.recalc.finished",MODULES:"antetype.modules",SETTINGS:"antetype.settings.definition",TYPE_DEFINITION:"antetype.layer.type.definition",FONTS_LOADED:"antetype.font.loaded"},ie=class{#e;#t=null;static inject={minstrel:"boardmeister/minstrel",herald:"boardmeister/herald"};inject(t){this.#e=t}async#r(t,r){let o=this.#e.minstrel.getResourceUrl(this,"core.js");return this.#t=(await import(o)).default,this.#t({canvas:r,modules:t,herald:this.#e.herald})}async register(t){let{modules:r,canvas:o}=t.detail;r.core=await this.#r(r,o)}static subscriptions={[O.MODULES]:"register"}};var te=class{#e;#t=null;static inject={minstrel:"boardmeister/minstrel",herald:"boardmeister/herald"};inject(r){this.#e=r}async register(r){let{modules:o,canvas:i}=r.detail;if(!this.#t){let s=this.#e.minstrel.getResourceUrl(this,"module.js");this.#t=(await import(s)).default}o.cursor=this.#t({canvas:i,modules:o,herald:this.#e.herald})}static subscriptions={[O.MODULES]:"register"}};var re=(t=>(t.INIT="antetype.init",t.CLOSE="antetype.close",t.DRAW="antetype.draw",t.CALC="antetype.calc",t.RECALC_FINISHED="antetype.recalc.finished",t.MODULES="antetype.modules",t.SETTINGS="antetype.settings.definition",t))(re||{}),N=(t=>(t.SAVE="antetype.memento.save",t))(N||{}),ve=class{#e;#t=null;#r=null;static inject={minstrel:"boardmeister/minstrel",herald:"boardmeister/herald"};inject(t){this.#e=t}async register(t){let{modules:r,canvas:o}=t.detail;if(!this.#t){let i=this.#e.minstrel.getResourceUrl(this,"module.js");this.#t=(await import(i)).default}this.#r=r.memento=this.#t({canvas:o,modules:r,injected:this.#e})}save(t){this.#r&&this.#r.addToStack(t.detail.state)}static subscriptions={[re.MODULES]:"register","antetype.memento.save":"save"}};function W(){let t=new WeakMap,r=[],o=[],i=new WeakMap,s={get[Symbol.toStringTag](){return"IterableWeakMap"},get:e=>t.get(e),set:(e,l)=>(t.has(e)||(t.set(e,l),i.set(e,r.length),r.push(e),o.push(l)),s),delete:e=>!t.has(e)&&i.has(e)?!1:(t.has(e)&&t.delete(e),i.has(e)&&(r.splice(i.get(e),1),o.splice(i.get(e),1),i.delete(e),r.forEach((l,m)=>{i.set(l,m)})),!0),first:()=>o[0]??null,last:()=>o.slice(-1)[0]??null,firstKey:()=>r[0]??null,lastKey:()=>r.slice(-1)[0]??null,has:e=>t.has(e),keys:()=>[...r],values:()=>[...o],empty:()=>o.length==0,reset:function(){t=new WeakMap,i=new WeakMap,r=[],o=[]},clone:()=>{let e=W();return r.forEach(l=>{e.set(l,s.get(l))}),e}};return Object.freeze(s)}var F=(t,r)=>{let o=new CustomEvent("antetype.cursor.calc",{detail:{values:r}});return t.dispatchSync(o),o.detail.values},j=t=>{let r=0,o=0,i=0,s=0;if((t.size||t.area?.size)&&({w:r,h:o}=t.area?.size??t.size),(t.start||t.area?.start)&&({x:i,y:s}=t.area?.start??t.start),t.hierarchy?.parent){let{start:e}=j(t.hierarchy.parent);i+=e.x,s+=e.y}return{size:{w:r,h:o},start:{x:i,y:s}}},se=(t,r,{x:o,y:i},{w:s,h:e})=>t>=o&&t<=s+o&&r>=i&&r<=e+i,V=(t,r,o,i=!0,s=!1)=>{for(let e=t.length-1;e>=0;e--){let l=t[e];if(i&&l.type===P)continue;let{size:m=null,start:f=null}=j(l);if(!(!m||!f)&&se(r,o,f,m)){if(s&&l.layout){let y=V(l.layout,r,o,i,!0);if(y)return y}return l}}return null},oe=(t,r,o,i=!0)=>{let s=[];for(let e=t.length-1;e>=0;e--){let l=t[e];if(i&&l.type===P)continue;let{size:m,start:f}=j(l);!m||!l||!(r>=f.x&&r<=m.w+f.x&&o>=f.y&&o<=m.h+f.y)||s.push(l)}return s},T=t=>typeof t=="number"&&isNaN(t)||typeof t>"u",R=(t,r,o,i)=>{r=t.core.clone.getClone(r),r.area&&(T(r.area.start.x)||(r.area.start.x+=o),T(r.area.start.y)||(r.area.start.y+=i)),r.start&&(T(r.start.x)||(r.start.x+=o),T(r.start.y)||(r.start.y+=i));let s=t.core.clone.getOriginal(r);if(t.workspace){let l=t.workspace;s.start&&(T(s.start.x)||(s.start.x=l.toRelative(r.start.x)),T(s.start.y)||(s.start.y=l.toRelative(r.start.y,"y")));return}let e=r.area?.start??r.start;e&&s.start&&(T(s.start.x)||(s.start.x=e.x),T(s.start.y)||(s.start.y=e.y)),e&&s.area?.start&&(T(s.area.start.x)||(s.area.start.x=e.x),T(s.area.start.y)||(s.area.start.y=e.y))};function ne(t){return t.type===P?t.selection.layer:t}function Z({modules:t,herald:r},o){let i=W(),s=[],e=!1,l=!1,m=!0,f=0,y=0,D=W(),S=t.core,w={moveBuffer:5},x=()=>o.select?.disabled??!1,z=()=>{for(;!i.empty();)i.delete(i.firstKey())},I=()=>{D=W()},g=p=>{let n=S.clone.getOriginal(p);return i.has(n)?n:!1},h=p=>{for(let n of p){let a=S.clone.getOriginal(n);if(i.has(a))return a}return!1},b=()=>{let p=i.keys(),n=[];p.forEach(a=>{let u=t.core.clone.getClone(a);n.push({origin:"cursor.move",layer:a,data:{x:u.area.start.x,y:u.area.start.y,after:{x:0,y:0}},undo:(c,v)=>{let d=t.core.clone.getClone(c);v.after.x=d.area.start.x,v.after.y=d.area.start.y,R(t,c,v.x-d.area.start.x,v.y-d.area.start.y)},redo:(c,v)=>{R(t,c,v.after.x-v.x,v.after.y-v.y)}})}),n.length>0&&r.dispatch(new CustomEvent(N.SAVE,{detail:{state:n}}))},C=p=>{if(!m)return!1;let{origin:{movementX:n,movementY:a}}=p.detail;return f+=n,y+=a,Math.abs(f)>w.moveBuffer||Math.abs(y)>w.moveBuffer?(m=!1,!1):!0},M=p=>{if(p.defaultPrevented||!e||C(p))return;let n=!l;l=!0;let{target:{down:a,hover:{mY:u,mX:c}}}=p.detail;if(a.layers.length===0){!a.shiftKey&&!a.ctrlKey&&(z(),k());return}let v=S.clone.getOriginal(a.layers[0]);!h(a.layers)&&!a.shiftKey&&!a.ctrlKey&&z(),i.set(v,!0),n&&b(),i.keys().forEach(E=>{if(E.hierarchy?.parent!==t.core.meta.document)return;let B=t.workspace?t.workspace.getScale():1;R(t,E,c/B,u/B)}),k()},L=p=>{if(p.defaultPrevented||p.detail.origin.button!==0)return;if(f=0,y=0,m=!0,e=!1,l){l=!1;return}let{target:{down:n}}=p.detail,{shiftKey:a,ctrlKey:u}=n;!a&&!u&&z();let c=!0,v=!1;for(let d of n.layers){let E=t.core.clone.getOriginal(d);if(i.has(E)&&u){i.delete(E);break}if(!D.has(E)){i.set(E,!0),v=!0,c&&I(),D.set(E,!0);break}c=!1}v||(D=W()),k()},k=()=>{for(let p of s)S.manage.removeVolatile(p);s=[];for(let p of i.keys()){let{size:n,start:a}=j(S.clone.getClone(p)),u={type:P,size:n,start:a,selection:{layer:p}};s.push(u),S.manage.addVolatile(u)}S.view.redraw()},G=p=>{p.defaultPrevented||p.detail.origin.button!==0||(e=!0)},Y=r.batch([{event:"antetype.cursor.on.down",subscription:p=>{x()||G(p)}},{event:"antetype.cursor.on.up",subscription:p=>{x()||L(p)}},{event:"antetype.cursor.on.move",subscription:p=>{x()||M(p)}},{event:O.CLOSE,subscription:{method:()=>{Y()}}}]);return{selected:i,isSelected:g,showSelected:k,resetSeeThroughStackMap:I}}function J({herald:t,modules:{core:r},canvas:o},i,s){let e={selected:i,isDown:!1,wasMoved:!1,down:{layers:[],x:0,y:0,shiftKey:!1,ctrlKey:!1},hover:{layer:null,deep:null,x:0,y:0,mX:0,mY:0}},l=()=>s.detect?.disabled??!1,m=()=>s.detect?.move?.skipSelection??!1,f=async(I,g)=>{let h=o.getBoundingClientRect();I-=h.left,g-=h.top;let b=new CustomEvent("antetype.cursor.position",{detail:{x:I,y:g}});return await t.dispatch(b),b.detail},y=async I=>{if(l())return;e.isDown=!0,e.wasMoved=!1;let{clientX:g,clientY:h}=I,{shiftKey:b,ctrlKey:C}=I,M=r.meta.document.layout;({x:g,y:h}=await f(g,h)),await w(I,M,g,h,0,0),e.down.x=g,e.down.y=h,e.down.shiftKey=b,e.down.ctrlKey=C,e.down.layers=oe(M,g,h),t.dispatch(new CustomEvent("antetype.cursor.on.down",{detail:{origin:I,target:e},cancelable:!0}))},D=async I=>{l()||(e.isDown=!1,await t.dispatch(new CustomEvent("antetype.cursor.on.up",{detail:{origin:I,target:e},cancelable:!0})),x(),await S(I))},S=async I=>{if(l())return;e.wasMoved=!0;let g=r.meta.document.layout,{clientX:h,clientY:b,movementX:C,movementY:M}=I;({x:h,y:b}=await f(h,b)),{movementX:C,movementY:M}=F(t,{movementX:C,movementY:M}),await w(I,g,h,b,C,M),await t.dispatch(new CustomEvent("antetype.cursor.on.move",{detail:{origin:I,target:e},cancelable:!0}))},w=async(I,g,h,b,C,M)=>{let L=V(g,h,b,m()),k=V(g,h,b,m(),!0);e.hover.x=h,e.hover.y=b,e.hover.mY=M,e.hover.mX=C,L!==e.hover.layer&&await t.dispatch(new CustomEvent("antetype.cursor.on.slip",{detail:{origin:I,target:e,from:e.hover.layer,to:L},cancelable:!0})),e.hover.layer=L,e.hover.deep=k},x=()=>{e.down.x=0,e.down.y=0,e.down.shiftKey=!1,e.down.ctrlKey=!1,e.down.layers=[]};return{onDown:y,onUp:D,onMove:S,onOut:async I=>{await t.dispatch(new CustomEvent("antetype.cursor.on.slip",{detail:{origin:I,target:e,from:e.hover.layer,to:null},cancelable:!0})),e.hover.layer=null,e.hover.deep=null}}}function Q(t,r){let o=(s,e,l,m,f,y)=>{r.save(),r.beginPath(),r.moveTo(s,e),r.lineTo(s+l,e),r.lineTo(s+l,e+m),r.lineTo(s,e+m),r.closePath(),r.lineWidth=f,r.strokeStyle=y,r.stroke(),r.restore()};return{drawSelection:({start:{x:s,y:e},size:{w:l,h:m}})=>{let f=F(t,{unit:1}).unit;o(s-f*2,e-f*2,l+f*4,m+f*4,f,"#FFF"),o(s-f,e-f,l+f*2,m+f*2,f,"#1e272e")}}}function $({herald:t,canvas:r,modules:o},i,s){let e=8,l=!1,m=!1,f=!1,y={waiting:!1,layout:null,movement:null},D=()=>s.resize?.disabled??!1,S=(n,a)=>{if(!n||n.selection.layer.hierarchy?.parent!==o.core.meta.document)return e=8,"default";let{start:{x:u,y:c},size:{h:v,w:d}}=n,{x:E,y:B}=a.hover,U=F(t,{bufferTop:s.resize?.buffer??10}).bufferTop,A=0,K=B<=c+U&&B>=c-A,_=E<=u+A+d&&E>=u-U+d,X=B<=c+A+v&&B>=c-U+v,H=E<=u+U&&E>=u-A;return K&&H||X&&_?(e=K&&H?6:5,"nwse-resize"):K&&_||X&&H?(e=K&&_?4:7,"nesw-resize"):K||X?(e=K?0:1,"ns-resize"):H||_?(e=H?3:2,"ew-resize"):(w(),"pointer")},w=()=>{e=8},x=n=>{if(l)return;let{target:{hover:{layer:a}}}=n.detail;a&&(a=ne(o.core.clone.getClone(a)),!o.core.clone.getOriginal(a)?.size)||(M(n),z(n))},z=n=>{let{target:a}=n.detail,u=a.selected.keys();if(u.length===0||e===8||!a.isDown)return;let{hover:{mX:c,mY:v}}=a;(e===3||e===2)&&(v=0),(e===0||e===1)&&(c=0);let d=o.workspace?o.workspace.getScale():1;if(c/=d,v/=d,m){y.waiting=!0,y.movement={x:c,y:v},y.layout=u;return}h(u),I(u,c,v)},I=(n,a,u)=>{let c=d=>{if(m=!1,y.waiting){let{layout:E,movement:B}=y,{x:U,y:A}=B;C(),I(E,U,A)}else t.dispatch(new CustomEvent("antetype.cursor.on.resized",{detail:{layout:n,success:d}}))};m=!0;let v=[];try{for(let E of n)v.push(g(E,a,u));let d=Promise.all(v);return d.then(()=>{c(!0)}).catch(()=>{c(!1)}),d}catch(d){throw c(!1),d}},g=(n,a,u)=>{let c=o.core.clone.getClone(n);if(c.hierarchy?.parent===o.core.meta.document)return e!==5&&e!==2&&e!==1&&R(o,c,e===4?0:a,e===7?0:u),(e===0||e===6||e===4)&&(u*=-1),(e===3||e===6||e===7)&&(a*=-1),b(c,a,u)},h=n=>{if(f)return;f=!0;let a=[];n.forEach(u=>{let c=o.core.clone.getClone(u);a.push({origin:"cursor.move",layer:u,data:{x:c.start.x,y:c.start.y,w:c.size.w,h:c.size.h,after:{w:0,h:0,x:0,y:0}},undo:async(v,d)=>{let E=o.core.clone.getClone(v);d.after.x=E.start.x,d.after.y=E.start.y,R(o,v,d.x-E.start.x,d.y-E.start.y),d.after.w=E.size.w,d.after.h=E.size.h,await b(v,d.w-E.size.w,d.h-E.size.h)},redo:async(v,d)=>{R(o,v,d.after.x-d.x,d.after.y-d.y),await b(v,d.after.w-d.w,d.after.h-d.h)}})}),a.length>0&&t.dispatch(new CustomEvent(N.SAVE,{detail:{state:a}}))},b=async(n,a,u)=>{if(!n.size)return;let c=o.core.clone.getClone(n);if(T(c.size.w)||(c.size.w+=a),T(c.size.h)||(c.size.h+=u),c.area&&(T(c.area.size.w)||(c.area.size.w+=a),T(c.area.size.h)||(c.area.size.h+=u)),n=o.core.clone.getOriginal(c),o.workspace){let v=o.workspace;n.size.w=v.toRelative(c.area.size.w),n.size.h=v.toRelative(c.area.size.h,"y")}else{let v=c.area?.size??c.size;n.size.w=v.w,n.size.h=v.h,n.area&&(n.area.size.w=v.w,n.area.size.h=v.h)}await o.core.view.resize(n,n.size),i(),o.core.view.redraw()},C=()=>{y.waiting=!1,y.movement=null,y.layout=null},M=n=>{let{target:a}=n.detail;if(e!==8&&(n.preventDefault(),a.isDown))return;let u=a.hover.layer;u?.type===P?r.style.cursor=S(u,a):w()},L=()=>{r.style.cursor="default"},k=n=>{let{from:a,target:{isDown:u}}=n.detail;u&&e!==8||(w(),a?.type===P&&L())},G=n=>{let{target:a}=n.detail,u=a?.hover?.layer;if(u?.type===P?r.style.cursor=S(u,a):w(),e===8){l=!0;return}n.preventDefault()},Y=n=>{f=!1,l=!1;let{target:a}=n.detail,u=a.hover.layer;e!==8&&n.preventDefault(),w(),u?.type===P?r.style.cursor=S(u,a):L()},p=t.batch([{event:"antetype.cursor.on.move",subscription:{method:n=>{D()||x(n)},priority:-10}},{event:"antetype.cursor.on.slip",subscription:{method:n=>{D()||k(n)}}},{event:"antetype.cursor.on.down",subscription:{method:n=>{D()||G(n)},priority:-10}},{event:"antetype.cursor.on.up",subscription:{method:n=>{D()||Y(n)},priority:-10}},{event:O.CLOSE,subscription:{method:()=>{p()}}}])}function ee({modules:t,herald:r,canvas:o},i,s){o.setAttribute("tabindex","0");let e=()=>s.delete?.disabled??!1,l=async f=>{if(!(f.target!==o&&f.target!==document.body||e())&&(f.code==="Delete"||f.code==="Backspace")){let y=i.keys();y.forEach(D=>{t.core.manage.remove(D),i.delete(D)}),m(y),await t.core.view.recalculate(),t.core.view.redraw()}},m=f=>{let y=[];f.forEach(D=>{let S=t.core.clone.getOriginal(D);y.push({origin:"cursor.delete",layer:S,data:{},undo:async w=>{t.core.manage.add(w,w.hierarchy?.parent??null,w.hierarchy?.position??null),await t.core.view.recalculate()},redo:async w=>{t.core.manage.remove(w),await t.core.view.recalculate()}})}),y.length>0&&r.dispatch(new CustomEvent(N.SAVE,{detail:{state:y}}))};return{onKeyUp:l}}var P="selection";function ae(t){let{canvas:r,herald:o,modules:i}=t;if(!r)throw new Error("[Antetype Cursor] Canvas is empty!");let s=r.getContext("2d");i.core.setting.has("cursor")||i.core.setting.set("cursor",{});let e=new Proxy({},{get(h,b){return i.core.setting.get("cursor")[b]},set(h,b,C){let M=i.core.setting.get("cursor");return M[b]=C,!0}}),{drawSelection:l}=Q(o,s),{selected:m,showSelected:f,isSelected:y,resetSeeThroughStackMap:D}=Z(t,e),{onDown:S,onUp:w,onMove:x,onOut:z}=J(t,m,e);$(t,f,e);let{onKeyUp:I}=ee(t,m,e);r.addEventListener("mousedown",S,!1),r.addEventListener("mouseup",w,!1),r.addEventListener("mousemove",x,!1),r.addEventListener("mouseout",z,!1),r.addEventListener("keyup",I,!1);let g=o.batch([{event:O.CLOSE,subscription:()=>{r.removeEventListener("mousedown",S,!1),r.removeEventListener("mouseup",w,!1),r.removeEventListener("mousemove",x,!1),r.removeEventListener("mouseout",z,!1),r.removeEventListener("keyup",I,!1),g()}},{event:O.DRAW,subscription:h=>{let{element:b}=h.detail,M={selection:l}[b.type];typeof M=="function"&&M(b)}}]);return{drawSelection:l,selected:m,showSelected:f,isSelected:y,resetSeeThroughStackMap:D}}export{ae as default,P as selectionType};
