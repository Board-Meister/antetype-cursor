var k={INIT:"antetype.init",CLOSE:"antetype.close",DRAW:"antetype.draw",CALC:"antetype.calc",RECALC_FINISHED:"antetype.recalc.finished",MODULES:"antetype.modules",SETTINGS:"antetype.settings.definition",TYPE_DEFINITION:"antetype.layer.type.definition",FONTS_LOADED:"antetype.font.loaded"};var oe={INIT:"antetype.init",CLOSE:"antetype.close",DRAW:"antetype.draw",CALC:"antetype.calc",RECALC_FINISHED:"antetype.recalc.finished",MODULES:"antetype.modules",SETTINGS:"antetype.settings.definition",TYPE_DEFINITION:"antetype.layer.type.definition",FONTS_LOADED:"antetype.font.loaded"},ce=class{#e;#t=null;static inject={minstrel:"boardmeister/minstrel",herald:"boardmeister/herald"};inject(e){this.#e=e}async#r(e,r){let o=this.#e.minstrel.getResourceUrl(this,"core.js");return this.#t=(await import(o)).default,this.#t({canvas:r,modules:e,herald:this.#e.herald})}async register(e){let{modules:r,canvas:o}=e.detail;r.core=await this.#r(r,o)}static subscriptions={[oe.MODULES]:"register"}},N=(e=>(e.SAVE="antetype.memento.save",e))(N||{}),ue=class{#e;#t=null;static inject={minstrel:"boardmeister/minstrel",herald:"boardmeister/herald"};inject(e){this.#e=e}async register(e){let{modules:r,canvas:o}=e.detail;if(!this.#t){let l=this.#e.minstrel.getResourceUrl(this,"module.js");this.#t=(await import(l)).default}r.memento=this.#t({canvas:o,modules:r,herald:this.#e.herald})}static subscriptions={[oe.MODULES]:"register"}};function A(){let e=new WeakMap,r=[],o=[],l=new WeakMap,s={get[Symbol.toStringTag](){return"IterableWeakMap"},get:t=>e.get(t),set:(t,n)=>(e.has(t)||(e.set(t,n),l.set(t,r.length),r.push(t),o.push(n)),s),delete:t=>!e.has(t)&&l.has(t)?!1:(e.has(t)&&e.delete(t),l.has(t)&&(r.splice(l.get(t),1),o.splice(l.get(t),1),l.delete(t),r.forEach((n,m)=>{l.set(n,m)})),!0),first:()=>o[0]??null,last:()=>o.slice(-1)[0]??null,firstKey:()=>r[0]??null,lastKey:()=>r.slice(-1)[0]??null,has:t=>e.has(t),keys:()=>[...r],values:()=>[...o],empty:()=>o.length==0,reset:function(){e=new WeakMap,l=new WeakMap,r=[],o=[]},clone:()=>{let t=A();return r.forEach(n=>{t.set(n,s.get(n))}),t}};return Object.freeze(s)}var L="selection";var H=(e,r)=>{let o=new CustomEvent("antetype.cursor.calc",{detail:{values:r}});return e.dispatchSync(o),o.detail.values},G=e=>{let r=0,o=0,l=0,s=0;if((e.size||e.area?.size)&&({w:r,h:o}=e.area?.size??e.size),(e.start||e.area?.start)&&({x:l,y:s}=e.area?.start??e.start),e.hierarchy?.parent){let{start:t}=G(e.hierarchy.parent);l+=t.x,s+=t.y}return{size:{w:r,h:o},start:{x:l,y:s}}},se=(e,r,{x:o,y:l},{w:s,h:t})=>e>=o&&e<=s+o&&r>=l&&r<=t+l,X=(e,r,o,l=!0,s=!1)=>{for(let t=e.length-1;t>=0;t--){let n=e[t];if(l&&n.type===L)continue;let{size:m=null,start:f=null}=G(n);if(!(!m||!f)&&se(r,o,f,m)){if(s&&n.layout){let h=X(n.layout,r,o,l,!0);if(h)return h}return n}}return null},ae=(e,r,o,l=!0)=>{let s=[];for(let t=e.length-1;t>=0;t--){let n=e[t];if(l&&n.type===L)continue;let{size:m,start:f}=G(n);!m||!n||!(r>=f.x&&r<=m.w+f.x&&o>=f.y&&o<=m.h+f.y)||s.push(n)}return s},P=e=>typeof e=="number"&&isNaN(e)||typeof e>"u",R=(e,r,o,l)=>{r=e.core.clone.getClone(r),r.area&&(P(r.area.start.x)||(r.area.start.x+=o),P(r.area.start.y)||(r.area.start.y+=l)),r.start&&(P(r.start.x)||(r.start.x+=o),P(r.start.y)||(r.start.y+=l));let s=e.core.clone.getOriginal(r);if(e.workspace){let n=e.workspace;s.start&&(P(s.start.x)||(s.start.x=n.toRelative(r.start.x)),P(s.start.y)||(s.start.y=n.toRelative(r.start.y,"y")));return}let t=r.area?.start??r.start;t&&s.start&&(P(s.start.x)||(s.start.x=t.x),P(s.start.y)||(s.start.y=t.y)),t&&s.area?.start&&(P(s.area.start.x)||(s.area.start.x=t.x),P(s.area.start.y)||(s.area.start.y=t.y))};function Q(e){return e.type===L?e.selection.layer:e}function $({modules:e,herald:r},o){let l=A(),s={layers:[]},t=!1,n=!1,m=!1,f=0,h=0,I=A(),S=e.core,x={moveBuffer:5},M=()=>o.select?.disabled??!1,v=()=>{for(;!l.empty();)l.delete(l.firstKey())},E=()=>{I=A()},b=y=>{let C=S.clone.getOriginal(y);return l.has(C)?C:!1},D=y=>{for(let C of y){let w=S.clone.getOriginal(C);if(l.has(w))return w}return!1},O=()=>{let y=l.keys(),C=[];y.forEach(w=>{let a=e.core.clone.getClone(w);C.push({origin:"cursor.move",layer:w,data:{x:a.area.start.x,y:a.area.start.y,after:{x:0,y:0}},undo:(c,i)=>{let u=e.core.clone.getClone(c);i.after.x=u.area.start.x,i.after.y=u.area.start.y,R(e,c,i.x-u.area.start.x,i.y-u.area.start.y)},redo:(c,i)=>{R(e,c,i.after.x-i.x,i.after.y-i.y)}})}),C.length>0&&r.dispatch(new CustomEvent(N.SAVE,{detail:{state:C}}))},T=y=>{if(!m)return!1;let{origin:{movementX:C,movementY:w}}=y.detail;return f+=C,h+=w,Math.abs(f)>x.moveBuffer||Math.abs(h)>x.moveBuffer?(m=!1,!1):!0},z=y=>{if(y.defaultPrevented||!t||T(y))return;let C=!n;n=!0;let{target:{down:w,hover:{mY:a,mX:c,layer:i}}}=y.detail;if(w.layers.length===0){!w.shiftKey&&!w.ctrlKey&&(v(),F());return}!(i&&D([i]))&&!w.shiftKey&&!w.ctrlKey&&v();let d=S.clone.getOriginal(w.layers[0]);l.set(d,!0),C&&O(),l.keys().forEach(p=>{if(p.hierarchy?.parent!==e.core.meta.document)return;let g=e.workspace?e.workspace.getScale():1;R(e,p,c/g,a/g)}),F()},B=y=>{if(y.defaultPrevented||y.detail.origin.button!==0)return;if(f=0,h=0,m=!0,t=!1,n){n=!1;return}let{target:{down:C}}=y.detail,{shiftKey:w,ctrlKey:a}=C;!w&&!a&&v();let c=!0,i=!1;for(let u of C.layers){let d=e.core.clone.getOriginal(u);if(l.has(d)&&a){l.delete(d);break}if(!I.has(d)){l.set(d,!0),i=!0,c&&E(),I.set(d,!0);break}c=!1}i||(I=A()),F()},F=()=>{for(let y of s.layers)S.manage.removeVolatile(y);s.layers=[];for(let y of l.keys()){let{size:C,start:w}=G(S.clone.getClone(y)),a={type:L,size:C,start:w,selection:{layer:y}};s.layers.push(a),S.manage.addVolatile(a)}S.view.redraw()},j=y=>{y.defaultPrevented||y.detail.origin.button!==0||(t=!0,m=!1)},q=r.batch([{event:"antetype.cursor.on.down",subscription:y=>{M()||j(y)}},{event:"antetype.cursor.on.up",subscription:y=>{M()||B(y)}},{event:"antetype.cursor.on.move",subscription:y=>{M()||z(y)}},{event:k.CLOSE,subscription:{method:()=>{q()}}}]);return{selected:l,selection:s,isSelected:b,showSelected:F,resetSeeThroughStackMap:E}}function ee({herald:e,modules:{core:r},canvas:o},l,s){let t={selected:l,isDown:!1,wasMoved:!1,down:{layers:[],x:0,y:0,shiftKey:!1,ctrlKey:!1},hover:{layer:null,deep:null,x:0,y:0,mX:0,mY:0}},n=()=>s.detect?.disabled??!1,m=async(v,E)=>{let b=o.getBoundingClientRect();v-=b.left,E-=b.top;let D=new CustomEvent("antetype.cursor.position",{detail:{x:v,y:E}});return await e.dispatch(D),D.detail},f=async v=>{if(n())return;t.isDown=!0,t.wasMoved=!1;let{clientX:E,clientY:b}=v,{shiftKey:D,ctrlKey:O}=v,T=r.meta.document.layout;({x:E,y:b}=await m(E,b)),await S(v,T,E,b,0,0),t.down.x=E,t.down.y=b,t.down.shiftKey=D,t.down.ctrlKey=O,t.down.layers=ae(T,E,b),e.dispatch(new CustomEvent("antetype.cursor.on.down",{detail:{origin:v,target:t},cancelable:!0}))},h=async v=>{n()||(t.isDown=!1,await e.dispatch(new CustomEvent("antetype.cursor.on.up",{detail:{origin:v,target:t},cancelable:!0})),x(),await I(v))},I=async v=>{if(n())return;t.wasMoved=!0;let E=r.meta.document.layout,{clientX:b,clientY:D,movementX:O,movementY:T}=v;({x:b,y:D}=await m(b,D)),{movementX:O,movementY:T}=H(e,{movementX:O,movementY:T}),await S(v,E,b,D,O,T),await e.dispatch(new CustomEvent("antetype.cursor.on.move",{detail:{origin:v,target:t},cancelable:!0}))},S=async(v,E,b,D,O,T)=>{let z=X(E,b,D,!0),B=X(E,b,D,!0,!0);t.hover.x=b,t.hover.y=D,t.hover.mY=T,t.hover.mX=O,z!==t.hover.layer&&await e.dispatch(new CustomEvent("antetype.cursor.on.slip",{detail:{origin:v,target:t,from:t.hover.layer,to:z},cancelable:!0})),t.hover.layer=z,t.hover.deep=B},x=()=>{t.down.x=0,t.down.y=0,t.down.shiftKey=!1,t.down.ctrlKey=!1,t.down.layers=[]};return{onDown:f,onUp:h,onMove:I,onOut:async v=>{await e.dispatch(new CustomEvent("antetype.cursor.on.slip",{detail:{origin:v,target:t,from:t.hover.layer,to:null},cancelable:!0})),t.hover.layer=null,t.hover.deep=null}}}function te(e,r){let o=(s,t,n,m,f,h)=>{r.save(),r.beginPath(),r.moveTo(s,t),r.lineTo(s+n,t),r.lineTo(s+n,t+m),r.lineTo(s,t+m),r.closePath(),r.lineWidth=f,r.strokeStyle=h,r.stroke(),r.restore()};return{drawSelection:({start:{x:s,y:t},size:{w:n,h:m}})=>{let f=H(e,{unit:1}).unit;o(s-f*2,t-f*2,n+f*4,m+f*4,f,"#FFF"),o(s-f,t-f,n+f*2,m+f*2,f,"#1e272e")}}}function re({herald:e,canvas:r,modules:o},l,s,t){let n=8,m=!1,f=!1,h=!1,I={waiting:!1,layout:null,movement:null},S=a=>{if(!a.hover.layer)return null;let c=o.core.clone.getOriginal;for(let i of t.layers)if(c(a.hover.layer)===c(Q(i)))return i;return null},x=()=>s.resize?.disabled??!1,M=(a,c)=>{if(!a||a.selection.layer.hierarchy?.parent!==o.core.meta.document)return n=8,"default";let{start:{x:i,y:u},size:{h:d,w:p}}=a,{x:g,y:W}=c.hover,_=H(e,{bufferTop:s.resize?.buffer??10}).bufferTop,U=0,K=W<=u+_&&W>=u-U,Y=g<=i+U+p&&g>=i-_+p,Z=W<=u+U+d&&W>=u-_+d,V=g<=i+_&&g>=i-U;return K&&V||Z&&Y?(n=K&&V?6:5,"nwse-resize"):K&&Y||Z&&V?(n=K&&Y?4:7,"nesw-resize"):K||Z?(n=K?0:1,"ns-resize"):V||Y?(n=V?3:2,"ew-resize"):(v(),"pointer")},v=()=>{n=8},E=a=>{if(m)return;let c=S(a.detail.target);if(c){let i=Q(o.core.clone.getClone(c));if(!o.core.clone.getOriginal(i)?.size)return}F(a),b(a)},b=a=>{let{target:c}=a.detail,i=c.selected.keys();if(i.length===0||n===8||!c.isDown)return;let{hover:{mX:u,mY:d}}=c;(n===3||n===2)&&(d=0),(n===0||n===1)&&(u=0);let p=o.workspace?o.workspace.getScale():1;if(u/=p,d/=p,f){I.waiting=!0,I.movement={x:u,y:d},I.layout=i;return}T(i),D(i,u,d)},D=(a,c,i)=>{let u=p=>{if(f=!1,I.waiting){let{layout:g,movement:W}=I,{x:_,y:U}=W;B(),D(g,_,U)}else e.dispatch(new CustomEvent("antetype.cursor.on.resized",{detail:{layout:a,success:p}}))};f=!0;let d=[];try{for(let g of a)d.push(O(g,c,i));let p=Promise.all(d);return p.then(()=>{u(!0)}).catch(()=>{u(!1)}),p}catch(p){throw u(!1),p}},O=(a,c,i)=>{let u=o.core.clone.getClone(a);if(u.hierarchy?.parent===o.core.meta.document)return n!==5&&n!==2&&n!==1&&R(o,u,n===4?0:c,n===7?0:i),(n===0||n===6||n===4)&&(i*=-1),(n===3||n===6||n===7)&&(c*=-1),z(u,c,i)},T=a=>{if(h)return;h=!0;let c=[];a.forEach(i=>{let u=o.core.clone.getClone(i);c.push({origin:"cursor.move",layer:i,data:{x:u.start.x,y:u.start.y,w:u.size.w,h:u.size.h,after:{w:0,h:0,x:0,y:0}},undo:async(d,p)=>{let g=o.core.clone.getClone(d);p.after.x=g.start.x,p.after.y=g.start.y,R(o,d,p.x-g.start.x,p.y-g.start.y),p.after.w=g.size.w,p.after.h=g.size.h,await z(d,p.w-g.size.w,p.h-g.size.h)},redo:async(d,p)=>{R(o,d,p.after.x-p.x,p.after.y-p.y),await z(d,p.after.w-p.w,p.after.h-p.h)}})}),c.length>0&&e.dispatch(new CustomEvent(N.SAVE,{detail:{state:c}}))},z=async(a,c,i)=>{if(!a.size)return;let u=o.core.clone.getClone(a);if(P(u.size.w)||(u.size.w+=c),P(u.size.h)||(u.size.h+=i),u.area&&(P(u.area.size.w)||(u.area.size.w+=c),P(u.area.size.h)||(u.area.size.h+=i)),a=o.core.clone.getOriginal(u),o.workspace){let d=o.workspace;a.size.w=d.toRelative(u.area.size.w),a.size.h=d.toRelative(u.area.size.h,"y")}else{let d=u.area?.size??u.size;a.size.w=d.w,a.size.h=d.h,a.area&&(a.area.size.w=d.w,a.area.size.h=d.h)}await o.core.view.resize(a,a.size),l(),o.core.view.redraw()},B=()=>{I.waiting=!1,I.movement=null,I.layout=null},F=a=>{let{target:c}=a.detail;if(n!==8&&(a.preventDefault(),c.isDown))return;let i=S(c);i?.type===L?r.style.cursor=M(i,c):(j(),v())},j=()=>{r.style.cursor="default"},q=a=>{let{from:c,target:{isDown:i}}=a.detail;i&&n!==8||(v(),c?.type===L&&j())},y=a=>{let{target:c}=a.detail,i=S(c);if(i?.type===L?r.style.cursor=M(i,c):v(),n===8){m=!0;return}a.preventDefault()},C=a=>{h=!1,m=!1;let{target:c}=a.detail,i=S(c);n!==8&&a.preventDefault(),v(),i?.type===L?r.style.cursor=M(i,c):j()},w=e.batch([{event:"antetype.cursor.on.move",subscription:{method:a=>{x()||E(a)},priority:-10}},{event:"antetype.cursor.on.slip",subscription:{method:a=>{x()||q(a)}}},{event:"antetype.cursor.on.down",subscription:{method:a=>{x()||y(a)},priority:-10}},{event:"antetype.cursor.on.up",subscription:{method:a=>{x()||C(a)},priority:-10}},{event:k.CLOSE,subscription:{method:()=>{w()}}}])}function ne({modules:e,herald:r,canvas:o},l,s){o.setAttribute("tabindex","0");let t=()=>s.delete?.disabled??!1,n=async h=>{h.forEach(I=>{e.core.manage.remove(I),l.delete(I)}),f(h),await e.core.view.recalculate(),e.core.view.redraw()},m=async h=>{h.target!==o&&h.target!==document.body||t()||(h.code==="Delete"||h.code==="Backspace")&&await n(l.keys())},f=h=>{let I=[];h.forEach(S=>{let x=e.core.clone.getOriginal(S);I.push({origin:"cursor.delete",layer:x,data:{},undo:async M=>{e.core.manage.add(M,M.hierarchy?.parent??null,M.hierarchy?.position??null),await e.core.view.recalculate()},redo:async M=>{e.core.manage.remove(M),await e.core.view.recalculate()}})}),I.length>0&&r.dispatch(new CustomEvent(N.SAVE,{detail:{state:I}}))};return{onKeyUp:m,remove:n}}function ie(e){let{canvas:r,herald:o,modules:l}=e;if(!r)throw new Error("[Antetype Cursor] Canvas is empty!");let s=r.getContext("2d");l.core.setting.has("cursor")||l.core.setting.set("cursor",{});let t=new Proxy({},{get(O,T){return l.core.setting.get("cursor")[T]},set(O,T,z){let B=l.core.setting.get("cursor");return B[T]=z,!0}}),{drawSelection:n}=te(o,s),{selected:m,showSelected:f,isSelected:h,resetSeeThroughStackMap:I,selection:S}=$(e,t),{onDown:x,onUp:M,onMove:v,onOut:E}=ee(e,m,t);re(e,f,t,S);let{onKeyUp:b}=ne(e,m,t);r.addEventListener("mousedown",x,!1),r.addEventListener("mouseup",M,!1),r.addEventListener("mousemove",v,!1),r.addEventListener("mouseout",E,!1),r.addEventListener("keyup",b,!1);let D=o.batch([{event:k.CLOSE,subscription:()=>{r.removeEventListener("mousedown",x,!1),r.removeEventListener("mouseup",M,!1),r.removeEventListener("mousemove",v,!1),r.removeEventListener("mouseout",E,!1),r.removeEventListener("keyup",b,!1),D()}},{event:k.DRAW,subscription:O=>{let{element:T}=O.detail,B={selection:n}[T.type];typeof B=="function"&&B(T)}}]);return{drawSelection:n,selected:m,showSelected:f,isSelected:h,resetSeeThroughStackMap:I}}export{ie as default};
