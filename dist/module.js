var K=(e=>(e.STRUCTURE="antetype.structure",e.MIDDLE="antetype.structure.middle",e.BAR_BOTTOM="antetype.structure.bar.bottom",e.CENTER="antetype.structure.center",e.COLUMN_LEFT="antetype.structure.column.left",e.COLUMN_RIGHT="antetype.structure.column.right",e.BAR_TOP="antetype.structure.bar.top",e.MODULES="antetype.modules",e.ACTIONS="antetype.structure.column.left.actions",e))(K||{});var Y=(e=>(e.STRUCTURE="antetype.structure",e.MIDDLE="antetype.structure.middle",e.BAR_BOTTOM="antetype.structure.bar.bottom",e.CENTER="antetype.structure.center",e.COLUMN_LEFT="antetype.structure.column.left",e.COLUMN_RIGHT="antetype.structure.column.right",e.BAR_TOP="antetype.structure.bar.top",e.MODULES="antetype.modules",e.ACTIONS="antetype.structure.column.left.actions",e))(Y||{}),F=(e=>(e.INIT="antetype.init",e.DRAW="antetype.draw",e.CALC="antetype.calc",e))(F||{}),se=class{#t;#r=null;#e=null;static inject={minstrel:"boardmeister/minstrel",herald:"boardmeister/herald"};inject(e){this.#t=e}async#o(e,o){if(!this.#e){let r=this.#t.minstrel.getResourceUrl(this,"core.js");this.#r=(await import(r)).default,this.#e=this.#r({canvas:o,modules:e,injected:this.#t})}return this.#e}async register(e){let{modules:o,canvas:r}=e.detail;o.core=await this.#o(o,r)}async init(e){if(!this.#e)throw new Error("Instance not loaded, trigger registration event first");let{base:o,settings:r}=e.detail;for(let n in r)this.#e.setting.set(n,r[n]);let t=this.#e.meta.document;t.base=o;let a=[];return(this.#e.setting.get("fonts")??[]).forEach(n=>{a.push(this.#e.font.load(n))}),await Promise.all(a),t.layout=await this.#e.view.recalculate(t,t.base),await this.#e.view.redraw(t.layout),t}async cloneDefinitions(e){if(!this.#e)throw new Error("Instance not loaded, trigger registration event first");e.detail.element!==null&&(e.detail.element=await this.#e.clone.definitions(e.detail.element))}static subscriptions={[Y.MODULES]:"register","antetype.init":"init","antetype.calc":[{method:"cloneDefinitions",priority:-255}]}};var J=class{#t;#r=null;#e=null;static inject={minstrel:"boardmeister/minstrel",herald:"boardmeister/herald"};inject(o){this.#t=o}async register(o){let{modules:r,canvas:t}=o.detail;if(!this.#r){let a=this.#t.minstrel.getResourceUrl(this,"module.js");this.#r=(await import(a)).default}this.#e=r.transform=this.#r({canvas:t,modules:r,injected:this.#t})}draw(o){if(!this.#e)return;let{element:r}=o.detail,a={selection:this.#e.drawSelection}[r.type];typeof a=="function"&&a(r)}static subscriptions={[K.MODULES]:"register",[F.DRAW]:"draw"}};var Q=(e=>(e.STRUCTURE="antetype.structure",e.MIDDLE="antetype.structure.middle",e.BAR_BOTTOM="antetype.structure.bar.bottom",e.CENTER="antetype.structure.center",e.COLUMN_LEFT="antetype.structure.column.left",e.COLUMN_RIGHT="antetype.structure.column.right",e.BAR_TOP="antetype.structure.bar.top",e.MODULES="antetype.modules",e))(Q||{}),C=(e=>(e.SAVE="antetype.memento.save",e))(C||{}),fe=class{#t;#r=null;#e=null;static inject={minstrel:"boardmeister/minstrel",herald:"boardmeister/herald"};inject(e){this.#t=e}async register(e){let{modules:o,canvas:r}=e.detail;if(!this.#r){let t=this.#t.minstrel.getResourceUrl(this,"module.js");this.#r=(await import(t)).default}this.#e=o.transform=this.#r({canvas:r,modules:o,injected:this.#t})}save(e){this.#e&&this.#e.addToStack(e.detail.state)}static subscriptions={[Q.MODULES]:"register","antetype.memento.save":"save"}};function B(){let e=new WeakMap,o=[],r=[],t=new WeakMap,a={get[Symbol.toStringTag](){return"IterableWeakMap"},get:n=>e.get(n),set:(n,c)=>(e.has(n)||(e.set(n,c),t.set(n,o.length),o.push(n),r.push(c)),a),delete:n=>!e.has(n)&&t.has(n)?!1:(e.has(n)&&e.delete(n),t.has(n)&&(o.splice(t.get(n),1),r.splice(t.get(n),1),t.delete(n),o.forEach((c,u)=>{t.set(c,u)})),!0),first:()=>r[0]??null,last:()=>r.slice(-1)[0]??null,firstKey:()=>o[0]??null,lastKey:()=>o.slice(-1)[0]??null,has:n=>e.has(n),keys:()=>[...o],values:()=>[...r],empty:()=>!!r.length,clone:()=>{let n=B();return o.forEach(c=>{n.set(c,a.get(c))}),n}};return Object.freeze(a)}var A=e=>{let o=e.area?.size??e.size,r=e.area?.start??e.start;return{size:o,start:r}},re=(e,o,{x:r,y:t},{w:a,h:n})=>e>=r&&e<=a+r&&o>=t&&o<=n+t,Z=(e,o,r,t=!0)=>{for(let a=e.length-1;a>=0;a--){let n=e[a];if(t&&n.type===M)continue;let{size:c=null,start:u=null}=A(n);if(!(!c||!u)&&re(o,r,u,c))return n}return null},$=(e,o,r,t=!0)=>{let a=[];for(let n=e.length-1;n>=0;n--){let c=e[n];if(t&&c.type===M)continue;let{size:u,start:I}=A(c);!u||!c||!(o>=I.x&&o<=u.w+I.x&&r>=I.y&&r<=u.h+I.y)||a.push(c)}return a},b=e=>typeof e=="number"&&isNaN(e)||typeof e>"u",x=(e,o,r,t)=>{o=e.core.clone.getClone(o),o.area&&(b(o.area.start.x)||(o.area.start.x+=r),b(o.area.start.y)||(o.area.start.y+=t)),o.start&&(b(o.start.x)||(o.start.x+=r),b(o.start.y)||(o.start.y+=t));let a=e.core.clone.getOriginal(o);if(e.workspace){let c=e.workspace;a.start&&(b(a.start.x)||(a.start.x=c.toRelative(o.start.x)),b(a.start.y)||(a.start.y=c.toRelative(o.start.y,"y")));return}let n=o.area?.start??o.start;n&&a.start&&(b(a.start.x)||(a.start.x=n.x+r),b(a.start.y)||(a.start.y=n.y+t))};function te(e){return e.type===M?e.selection.layer:e}function H({modules:e,injected:{herald:o}}){let r=B(),t=[],a=!1,n=!1,c=B(),u=e.core,I=()=>{for(;r.empty();)r.delete(r.firstKey())},f=()=>{c=B()},D=d=>{for(let y of r.keys())if(d===y)return d;return!1},E=d=>{for(let y of r.keys())if(d.includes(y))return y;return!1},T=()=>{let d=r.keys(),y=[];d.forEach(h=>{let g=e.core.clone.getOriginal(h);y.push({origin:"cursor.move",layer:g,data:{x:h.area.start.x,y:h.area.start.y,after:{x:0,y:0}},undo:(S,s)=>{let i=e.core.clone.getClone(S);s.after.x=i.area.start.x,s.after.y=i.area.start.y,x(e,S,s.x-i.area.start.x,s.y-i.area.start.y)},redo:(S,s)=>{x(e,S,s.after.x-s.x,s.after.y-s.y)}})}),y.length>0&&o.dispatch(new CustomEvent(C.SAVE,{detail:{state:y}}))},O=d=>{if(d.defaultPrevented||!a)return;let y=!n;n=!0;let{target:{down:h},origin:{movementX:g,movementY:S}}=d.detail;if(h.layers.length===0){!h.shiftKey&&!h.ctrlKey&&(I(),P());return}let s=h.layers[0],i=E(h.layers);!c.has(s)&&!i?(!h.shiftKey&&!h.ctrlKey&&I(),r.set(s,!0)):i&&r.set(i,!0),y&&T(),r.keys().forEach(l=>{x(e,l,g,S)}),P()},L=d=>{if(d.defaultPrevented)return;if(a=!1,n){n=!1;return}let{target:{down:y}}=d.detail,{shiftKey:h,ctrlKey:g}=y;!h&&!g&&I();let S=!0,s=!1;for(let i of y.layers){if(r.has(i)&&g){r.delete(i);break}if(!c.has(i)){r.set(i,!0),s=!0,S&&f(),c.set(i,!0);break}S=!1}s||(c=B()),P()},P=()=>{for(let d of t)u.manage.removeVolatile(d);t=[];for(let d of r.keys()){let{size:y,start:h}=A(d),g={type:M,size:y,start:h,selection:{layer:d}};t.push(g),u.manage.addVolatile(g)}u.view.redraw()},_=d=>{d.defaultPrevented||(a=!0)};return o.register("antetype.cursor.on.down",_),o.register("antetype.cursor.on.up",L),o.register("antetype.cursor.on.move",O),{selected:r,isSelected:D,showSelected:P}}function G({injected:{herald:e},modules:{core:o}},r){let t={selected:r,isDown:!1,down:{layers:[],x:0,y:0,shiftKey:!1,ctrlKey:!1},hover:{layer:null,x:0,y:0}},a=async(f,D)=>{let E=new CustomEvent("antetype.cursor.position",{detail:{x:f,y:D}});return await e.dispatch(E),E.detail},n=async f=>{t.isDown=!0;let{layerX:D,layerY:E}=f,{shiftKey:T,ctrlKey:O}=f,L=o.meta.document.layout;({x:D,y:E}=await a(D,E)),t.down.x=D,t.down.y=E,t.down.shiftKey=T,t.down.ctrlKey=O,t.down.layers=$(L,D,E),e.dispatch(new CustomEvent("antetype.cursor.on.down",{detail:{origin:f,target:t},cancelable:!0}))},c=async f=>{t.isDown=!1,await e.dispatch(new CustomEvent("antetype.cursor.on.up",{detail:{origin:f,target:t},cancelable:!0})),I(),await u(f)},u=async f=>{let D=o.meta.document.layout,{layerX:E,layerY:T}=f;({x:E,y:T}=await a(E,T));let O=Z(D,E,T,!1);t.hover.x=E,t.hover.y=T,O!==t.hover.layer&&await e.dispatch(new CustomEvent("antetype.cursor.on.slip",{detail:{origin:f,target:t,from:t.hover.layer,to:O},cancelable:!0})),t.hover.layer=O,await e.dispatch(new CustomEvent("antetype.cursor.on.move",{detail:{origin:f,target:t},cancelable:!0}))},I=()=>{t.down.x=0,t.down.y=0,t.down.shiftKey=!1,t.down.ctrlKey=!1,t.down.layers=[]};return{onDown:n,onUp:c,onMove:u}}function V(e){return{drawSelection:({start:{x:r,y:t},size:{w:a,h:n}})=>{e.save(),e.beginPath(),e.moveTo(r,t),e.lineTo(r+a,t),e.lineTo(r+a,t+n),e.lineTo(r,t+n),e.closePath(),e.strokeStyle="#1e272e",e.stroke(),e.restore()}}}function q({injected:{herald:e},canvas:o,modules:r}){let t=8,a=!1,n=!1,c=!1,u={waiting:!1,layout:null,movement:null},I=(s,i)=>{let{start:{x:l,y:p},size:{h:v,w:m}}=s,{x:w,y:z}=i.hover,N=10,U=0,R=z<=p+N&&z>=p-U,j=w<=l+U+m&&w>=l-N+m,W=z<=p+U+v&&z>=p-N+v,k=w<=l+N&&w>=l-U;return R&&k||W&&j?(t=R&&k?6:5,"nwse-resize"):R&&j||W&&k?(t=R&&j?4:7,"nesw-resize"):R||W?(t=R?0:1,"ns-resize"):k||j?(t=k?3:2,"ew-resize"):(f(),"pointer")},f=()=>{t=8},D=s=>{if(a)return;let{target:{hover:{layer:i}}}=s.detail;i&&(i=te(i),!r.core.clone.getOriginal(i)?.size)||(d(s),E(s))},E=s=>{let{target:i,origin:l}=s.detail,p=i.selected.keys();if(p.length===0||t===8||!i.isDown)return;let{movementY:v,movementX:m}=l;if((t===3||t===2)&&(v=0),(t===0||t===1)&&(m=0),n){u.waiting=!0,u.movement={x:m,y:v},u.layout=p;return}L(p),T(p,m,v)},T=(s,i,l)=>{for(let p of s)O(p,i,l)},O=(s,i,l)=>{t!==5&&t!==2&&t!==1&&x(r,s,t===4?0:i,t===7?0:l),(t===0||t===6||t===4)&&(l*=-1),(t===3||t===6||t===7)&&(i*=-1),P(s,i,l)},L=s=>{if(c)return;c=!0;let i=[];s.forEach(l=>{let p=r.core.clone.getOriginal(l);i.push({origin:"cursor.move",layer:p,data:{x:l.start.x,y:l.start.y,w:l.size.w,h:l.size.h,after:{w:0,h:0,x:0,y:0}},undo:async(v,m)=>{let w=r.core.clone.getClone(v);m.after.x=w.start.x,m.after.y=w.start.y,x(r,v,m.x-w.start.x,m.y-w.start.y),m.after.w=w.size.w,m.after.h=w.size.h,await P(v,m.w-w.size.w,m.h-w.size.h)},redo:async(v,m)=>{x(r,v,m.after.x-m.x,m.after.y-m.y),await P(v,m.after.w-m.w,m.after.h-m.h)}})}),i.length>0&&e.dispatch(new CustomEvent(C.SAVE,{detail:{state:i}}))},P=async(s,i,l)=>{if(!s.size)return;s=r.core.clone.getClone(s),s.area&&(b(s.area.size.w)||(s.area.size.w+=i),b(s.area.size.h)||(s.area.size.h+=l));let p=r.core.clone.getOriginal(s);if(r.workspace){let v=r.workspace;b(p.size.w)||(p.size.w=v.toRelative(s.area.size.w)),b(p.size.h)||(p.size.h=v.toRelative(s.area.size.h,"y"))}else{let v=s.area?.size??s.size;b(p.size?.w)||(p.size.w=v.w+i),b(p.size?.h)||(p.size.h=v.h+l)}if(n=!0,await r.core.manage.resize(p,s,p.size),r.core.view.redraw(),n=!1,u.waiting){let{layout:v,movement:m}=u,{x:w,y:z}=m;_(),T(v,w,z)}},_=()=>{u.waiting=!1,u.movement=null,u.layout=null},d=s=>{let{target:i}=s.detail;if(t!==8&&(s.preventDefault(),i.isDown))return;let l=i.hover.layer;l?.type===M?o.style.cursor=I(l,i):f()},y=()=>{o.style.cursor="default"},h=s=>{let{from:i,target:{isDown:l}}=s.detail;l&&t!==8||(f(),i?.type===M&&y())},g=s=>{if(t===8){a=!0;return}s.preventDefault()},S=s=>{c=!1,a=!1;let{target:i}=s.detail,l=i.hover.layer;t!==8&&s.preventDefault(),f(),l?.type===M?o.style.cursor=I(l,i):y()};e.register("antetype.cursor.on.move",{method:D,priority:-10}),e.register("antetype.cursor.on.slip",h),e.register("antetype.cursor.on.down",{method:g,priority:-10}),e.register("antetype.cursor.on.up",{method:S,priority:-10})}function X({modules:e,injected:{herald:o}},r){let t=async n=>{if(n.code==="Delete"||n.code==="Backspace"){let c=r.keys();c.forEach(u=>{e.core.manage.remove(u),r.delete(u)}),a(c),await e.core.view.recalculate(),e.core.view.redraw()}},a=n=>{let c=[];n.forEach(u=>{let I=e.core.clone.getOriginal(u);c.push({origin:"cursor.move",layer:I,data:{},undo:async f=>{e.core.manage.add(f,f.hierarchy?.parent??null,f.hierarchy?.position??null),await e.core.view.recalculate()},redo:async f=>{e.core.manage.remove(f),await e.core.view.recalculate()}})}),c.length>0&&o.dispatch(new CustomEvent(C.SAVE,{detail:{state:c}}))};return document.addEventListener("keyup",t,!1),{}}var M="selection";function oe(e){let{canvas:o}=e;if(!o)throw new Error("[Antetype Cursor] Canvas is empty!");let r=o.getContext("2d"),{drawSelection:t}=V(r),{selected:a,showSelected:n,isSelected:c}=H(e),{onDown:u,onUp:I,onMove:f}=G(e,a);return q(e),X(e,a),o.addEventListener("mousedown",u,!1),o.addEventListener("mouseup",I,!1),o.addEventListener("mousemove",f,!1),{drawSelection:t,selected:a,showSelected:n,isSelected:c}}export{oe as default,M as selectionType};
