var R={INIT:"antetype.init",CLOSE:"antetype.close",DRAW:"antetype.draw",CALC:"antetype.calc",RECALC_FINISHED:"antetype.recalc.finished",MODULES:"antetype.modules",SETTINGS:"antetype.settings.definition",TYPE_DEFINITION:"antetype.layer.type.definition",FONTS_LOADED:"antetype.font.loaded"},ce=class{#e;#t=null;static inject={minstrel:"boardmeister/minstrel",herald:"boardmeister/herald"};inject(e){this.#e=e}async#r(e,t){let o=this.#e.minstrel.getResourceUrl(this,"core.js");return this.#t=(await import(o)).default,this.#t({canvas:t,modules:e,herald:this.#e.herald})}async register(e){let{modules:t,canvas:o}=e.detail;t.core=await this.#r(t,o)}static subscriptions={[R.MODULES]:"register"}};var ne=class{#e;#t=null;static inject={minstrel:"boardmeister/minstrel",herald:"boardmeister/herald"};inject(t){this.#e=t}async register(t){let{modules:o,canvas:i}=t.detail;if(!this.#t){let a=this.#e.minstrel.getResourceUrl(this,"module.js");this.#t=(await import(a)).default}o.cursor=this.#t({canvas:i,modules:o,herald:this.#e.herald})}static subscriptions={[R.MODULES]:"register"}};var se={INIT:"antetype.init",CLOSE:"antetype.close",DRAW:"antetype.draw",CALC:"antetype.calc",RECALC_FINISHED:"antetype.recalc.finished",MODULES:"antetype.modules",SETTINGS:"antetype.settings.definition",TYPE_DEFINITION:"antetype.layer.type.definition",FONTS_LOADED:"antetype.font.loaded"},ve=class{#e;#t=null;static inject={minstrel:"boardmeister/minstrel",herald:"boardmeister/herald"};inject(e){this.#e=e}async#r(e,t){let o=this.#e.minstrel.getResourceUrl(this,"core.js");return this.#t=(await import(o)).default,this.#t({canvas:t,modules:e,herald:this.#e.herald})}async register(e){let{modules:t,canvas:o}=e.detail;t.core=await this.#r(t,o)}static subscriptions={[se.MODULES]:"register"}},N=(e=>(e.SAVE="antetype.memento.save",e))(N||{}),pe=class{#e;#t=null;static inject={minstrel:"boardmeister/minstrel",herald:"boardmeister/herald"};inject(e){this.#e=e}async register(e){let{modules:t,canvas:o}=e.detail;if(!this.#t){let i=this.#e.minstrel.getResourceUrl(this,"module.js");this.#t=(await import(i)).default}t.memento=this.#t({canvas:o,modules:t,herald:this.#e.herald})}static subscriptions={[se.MODULES]:"register"}};function W(){let e=new WeakMap,t=[],o=[],i=new WeakMap,a={get[Symbol.toStringTag](){return"IterableWeakMap"},get:r=>e.get(r),set:(r,n)=>(e.has(r)||(e.set(r,n),i.set(r,t.length),t.push(r),o.push(n)),a),delete:r=>!e.has(r)&&i.has(r)?!1:(e.has(r)&&e.delete(r),i.has(r)&&(t.splice(i.get(r),1),o.splice(i.get(r),1),i.delete(r),t.forEach((n,v)=>{i.set(n,v)})),!0),first:()=>o[0]??null,last:()=>o.slice(-1)[0]??null,firstKey:()=>t[0]??null,lastKey:()=>t.slice(-1)[0]??null,has:r=>e.has(r),keys:()=>[...t],values:()=>[...o],empty:()=>o.length==0,reset:function(){e=new WeakMap,i=new WeakMap,t=[],o=[]},clone:()=>{let r=W();return t.forEach(n=>{r.set(n,a.get(n))}),r}};return Object.freeze(a)}var j=(e,t)=>{let o=new CustomEvent("antetype.cursor.calc",{detail:{values:t}});return e.dispatchSync(o),o.detail.values},G=e=>{let t=0,o=0,i=0,a=0;if((e.size||e.area?.size)&&({w:t,h:o}=e.area?.size??e.size),(e.start||e.area?.start)&&({x:i,y:a}=e.area?.start??e.start),e.hierarchy?.parent){let{start:r}=G(e.hierarchy.parent);i+=r.x,a+=r.y}return{size:{w:t,h:o},start:{x:i,y:a}}},ie=(e,t,{x:o,y:i},{w:a,h:r})=>e>=o&&e<=a+o&&t>=i&&t<=r+i,X=(e,t,o,i=!0,a=!1)=>{for(let r=e.length-1;r>=0;r--){let n=e[r];if(i&&n.type===L)continue;let{size:v=null,start:f=null}=G(n);if(!(!v||!f)&&ie(t,o,f,v)){if(a&&n.layout){let I=X(n.layout,t,o,i,!0);if(I)return I}return n}}return null},ae=(e,t,o,i=!0)=>{let a=[];for(let r=e.length-1;r>=0;r--){let n=e[r];if(i&&n.type===L)continue;let{size:v,start:f}=G(n);!v||!n||!(t>=f.x&&t<=v.w+f.x&&o>=f.y&&o<=v.h+f.y)||a.push(n)}return a},x=e=>typeof e=="number"&&isNaN(e)||typeof e>"u",k=(e,t,o,i)=>{t=e.core.clone.getClone(t),t.area&&(x(t.area.start.x)||(t.area.start.x+=o),x(t.area.start.y)||(t.area.start.y+=i)),t.start&&(x(t.start.x)||(t.start.x+=o),x(t.start.y)||(t.start.y+=i));let a=e.core.clone.getOriginal(t);if(e.workspace){let n=e.workspace;a.start&&(x(a.start.x)||(a.start.x=n.toRelative(t.start.x)),x(a.start.y)||(a.start.y=n.toRelative(t.start.y,"y")));return}let r=t.area?.start??t.start;r&&a.start&&(x(a.start.x)||(a.start.x=r.x),x(a.start.y)||(a.start.y=r.y)),r&&a.area?.start&&(x(a.area.start.x)||(a.area.start.x=r.x),x(a.area.start.y)||(a.area.start.y=r.y))};function Q(e){return e.type===L?e.selection.layer:e}function $({modules:e,herald:t},o){let i=W(),a={layers:[]},r=!1,n=!1,v=!1,f=0,I=0,E=W(),g=e.core,C={moveBuffer:5},z=()=>o.select?.disabled??!1,p=()=>{for(;!i.empty();)i.delete(i.firstKey())},h=()=>{E=W()},b=y=>{let T=g.clone.getOriginal(y);return i.has(T)?T:!1},D=y=>{for(let T of y){let w=g.clone.getOriginal(T);if(i.has(w))return w}return!1},P=()=>{let y=i.keys(),T=[];y.forEach(w=>{let s=e.core.clone.getClone(w);T.push({origin:"cursor.move",layer:w,data:{x:s.area.start.x,y:s.area.start.y,after:{x:0,y:0}},undo:(c,l)=>{let u=e.core.clone.getClone(c);l.after.x=u.area.start.x,l.after.y=u.area.start.y,k(e,c,l.x-u.area.start.x,l.y-u.area.start.y)},redo:(c,l)=>{k(e,c,l.after.x-l.x,l.after.y-l.y)}})}),T.length>0&&t.dispatch(new CustomEvent(N.SAVE,{detail:{state:T}}))},M=y=>{if(!v)return!1;let{origin:{movementX:T,movementY:w}}=y.detail;return f+=T,I+=w,Math.abs(f)>C.moveBuffer||Math.abs(I)>C.moveBuffer?(v=!1,!1):!0},O=y=>{if(y.defaultPrevented||!r||M(y))return;let T=!n;n=!0;let{target:{down:w,hover:{mY:s,mX:c,layer:l}}}=y.detail;if(w.layers.length===0){!w.shiftKey&&!w.ctrlKey&&(p(),U());return}!(l&&D([l]))&&!w.shiftKey&&!w.ctrlKey&&p();let d=g.clone.getOriginal(w.layers[0]);i.set(d,!0),T&&P(),i.keys().forEach(m=>{if(m.hierarchy?.parent!==e.core.meta.document)return;let S=e.workspace?e.workspace.getScale():1;k(e,m,c/S,s/S)}),U()},B=y=>{if(y.defaultPrevented||y.detail.origin.button!==0)return;if(f=0,I=0,v=!0,r=!1,n){n=!1;return}let{target:{down:T}}=y.detail,{shiftKey:w,ctrlKey:s}=T;!w&&!s&&p();let c=!0,l=!1;for(let u of T.layers){let d=e.core.clone.getOriginal(u);if(i.has(d)&&s){i.delete(d);break}if(!E.has(d)){i.set(d,!0),l=!0,c&&h(),E.set(d,!0);break}c=!1}l||(E=W()),U()},U=()=>{for(let y of a.layers)g.manage.removeVolatile(y);a.layers=[];for(let y of i.keys()){let{size:T,start:w}=G(g.clone.getClone(y)),s={type:L,size:T,start:w,selection:{layer:y}};a.layers.push(s),g.manage.addVolatile(s)}g.view.redraw()},_=y=>{y.defaultPrevented||y.detail.origin.button!==0||(r=!0,v=!1)},q=t.batch([{event:"antetype.cursor.on.down",subscription:y=>{z()||_(y)}},{event:"antetype.cursor.on.up",subscription:y=>{z()||B(y)}},{event:"antetype.cursor.on.move",subscription:y=>{z()||O(y)}},{event:R.CLOSE,subscription:{method:()=>{q()}}}]);return{selected:i,selection:a,isSelected:b,showSelected:U,resetSeeThroughStackMap:h}}function ee({herald:e,modules:{core:t},canvas:o},i,a){let r={selected:i,isDown:!1,wasMoved:!1,down:{layers:[],x:0,y:0,shiftKey:!1,ctrlKey:!1},hover:{layer:null,deep:null,x:0,y:0,mX:0,mY:0}},n=()=>a.detect?.disabled??!1,v=async(p,h)=>{let b=o.getBoundingClientRect();p-=b.left,h-=b.top;let D=new CustomEvent("antetype.cursor.position",{detail:{x:p,y:h}});return await e.dispatch(D),D.detail},f=async p=>{if(n())return;r.isDown=!0,r.wasMoved=!1;let{clientX:h,clientY:b}=p,{shiftKey:D,ctrlKey:P}=p,M=t.meta.document.layout;({x:h,y:b}=await v(h,b)),await g(p,M,h,b,0,0),r.down.x=h,r.down.y=b,r.down.shiftKey=D,r.down.ctrlKey=P,r.down.layers=ae(M,h,b),e.dispatch(new CustomEvent("antetype.cursor.on.down",{detail:{origin:p,target:r},cancelable:!0}))},I=async p=>{n()||(r.isDown=!1,await e.dispatch(new CustomEvent("antetype.cursor.on.up",{detail:{origin:p,target:r},cancelable:!0})),C(),await E(p))},E=async p=>{if(n())return;r.wasMoved=!0;let h=t.meta.document.layout,{clientX:b,clientY:D,movementX:P,movementY:M}=p;({x:b,y:D}=await v(b,D)),{movementX:P,movementY:M}=j(e,{movementX:P,movementY:M}),await g(p,h,b,D,P,M),await e.dispatch(new CustomEvent("antetype.cursor.on.move",{detail:{origin:p,target:r},cancelable:!0}))},g=async(p,h,b,D,P,M)=>{let O=X(h,b,D,!0),B=X(h,b,D,!0,!0);r.hover.x=b,r.hover.y=D,r.hover.mY=M,r.hover.mX=P,O!==r.hover.layer&&await e.dispatch(new CustomEvent("antetype.cursor.on.slip",{detail:{origin:p,target:r,from:r.hover.layer,to:O},cancelable:!0})),r.hover.layer=O,r.hover.deep=B},C=()=>{r.down.x=0,r.down.y=0,r.down.shiftKey=!1,r.down.ctrlKey=!1,r.down.layers=[]};return{onDown:f,onUp:I,onMove:E,onOut:async p=>{await e.dispatch(new CustomEvent("antetype.cursor.on.slip",{detail:{origin:p,target:r,from:r.hover.layer,to:null},cancelable:!0})),r.hover.layer=null,r.hover.deep=null}}}function te(e,t){let o=(a,r,n,v,f,I)=>{t.save(),t.beginPath(),t.moveTo(a,r),t.lineTo(a+n,r),t.lineTo(a+n,r+v),t.lineTo(a,r+v),t.closePath(),t.lineWidth=f,t.strokeStyle=I,t.stroke(),t.restore()};return{drawSelection:({start:{x:a,y:r},size:{w:n,h:v}})=>{let f=j(e,{unit:1}).unit;o(a-f*2,r-f*2,n+f*4,v+f*4,f,"#FFF"),o(a-f,r-f,n+f*2,v+f*2,f,"#1e272e")}}}function re({herald:e,canvas:t,modules:o},i,a,r){let n=8,v=!1,f=!1,I=!1,E={waiting:!1,layout:null,movement:null},g=s=>{if(!s.hover.layer)return null;let c=o.core.clone.getOriginal;for(let l of r.layers)if(c(s.hover.layer)===c(Q(l)))return l;return null},C=()=>a.resize?.disabled??!1,z=(s,c)=>{if(!s||s.selection.layer.hierarchy?.parent!==o.core.meta.document)return n=8,"default";let{start:{x:l,y:u},size:{h:d,w:m}}=s,{x:S,y:A}=c.hover,F=j(e,{bufferTop:a.resize?.buffer??10}).bufferTop,K=0,H=A<=u+F&&A>=u-K,Y=S<=l+K+m&&S>=l-F+m,Z=A<=u+K+d&&A>=u-F+d,V=S<=l+F&&S>=l-K;return H&&V||Z&&Y?(n=H&&V?6:5,"nwse-resize"):H&&Y||Z&&V?(n=H&&Y?4:7,"nesw-resize"):H||Z?(n=H?0:1,"ns-resize"):V||Y?(n=V?3:2,"ew-resize"):(p(),"pointer")},p=()=>{n=8},h=s=>{if(v)return;let c=g(s.detail.target);if(c){let l=Q(o.core.clone.getClone(c));if(!o.core.clone.getOriginal(l)?.size)return}U(s),b(s)},b=s=>{let{target:c}=s.detail,l=c.selected.keys();if(l.length===0||n===8||!c.isDown)return;let{hover:{mX:u,mY:d}}=c;(n===3||n===2)&&(d=0),(n===0||n===1)&&(u=0);let m=o.workspace?o.workspace.getScale():1;if(u/=m,d/=m,f){E.waiting=!0,E.movement={x:u,y:d},E.layout=l;return}M(l),D(l,u,d)},D=(s,c,l)=>{let u=m=>{if(f=!1,E.waiting){let{layout:S,movement:A}=E,{x:F,y:K}=A;B(),D(S,F,K)}else e.dispatch(new CustomEvent("antetype.cursor.on.resized",{detail:{layout:s,success:m}}))};f=!0;let d=[];try{for(let S of s)d.push(P(S,c,l));let m=Promise.all(d);return m.then(()=>{u(!0)}).catch(()=>{u(!1)}),m}catch(m){throw u(!1),m}},P=(s,c,l)=>{let u=o.core.clone.getClone(s);if(u.hierarchy?.parent===o.core.meta.document)return n!==5&&n!==2&&n!==1&&k(o,u,n===4?0:c,n===7?0:l),(n===0||n===6||n===4)&&(l*=-1),(n===3||n===6||n===7)&&(c*=-1),O(u,c,l)},M=s=>{if(I)return;I=!0;let c=[];s.forEach(l=>{let u=o.core.clone.getClone(l);c.push({origin:"cursor.move",layer:l,data:{x:u.start.x,y:u.start.y,w:u.size.w,h:u.size.h,after:{w:0,h:0,x:0,y:0}},undo:async(d,m)=>{let S=o.core.clone.getClone(d);m.after.x=S.start.x,m.after.y=S.start.y,k(o,d,m.x-S.start.x,m.y-S.start.y),m.after.w=S.size.w,m.after.h=S.size.h,await O(d,m.w-S.size.w,m.h-S.size.h)},redo:async(d,m)=>{k(o,d,m.after.x-m.x,m.after.y-m.y),await O(d,m.after.w-m.w,m.after.h-m.h)}})}),c.length>0&&e.dispatch(new CustomEvent(N.SAVE,{detail:{state:c}}))},O=async(s,c,l)=>{if(!s.size)return;let u=o.core.clone.getClone(s);if(x(u.size.w)||(u.size.w+=c),x(u.size.h)||(u.size.h+=l),u.area&&(x(u.area.size.w)||(u.area.size.w+=c),x(u.area.size.h)||(u.area.size.h+=l)),s=o.core.clone.getOriginal(u),o.workspace){let d=o.workspace;s.size.w=d.toRelative(u.area.size.w),s.size.h=d.toRelative(u.area.size.h,"y")}else{let d=u.area?.size??u.size;s.size.w=d.w,s.size.h=d.h,s.area&&(s.area.size.w=d.w,s.area.size.h=d.h)}await o.core.view.resize(s,s.size),i(),o.core.view.redraw()},B=()=>{E.waiting=!1,E.movement=null,E.layout=null},U=s=>{let{target:c}=s.detail;if(n!==8&&(s.preventDefault(),c.isDown))return;let l=g(c);l?.type===L?t.style.cursor=z(l,c):(_(),p())},_=()=>{t.style.cursor="default"},q=s=>{let{from:c,target:{isDown:l}}=s.detail;l&&n!==8||(p(),c?.type===L&&_())},y=s=>{let{target:c}=s.detail,l=g(c);if(l?.type===L?t.style.cursor=z(l,c):p(),n===8){v=!0;return}s.preventDefault()},T=s=>{I=!1,v=!1;let{target:c}=s.detail,l=g(c);n!==8&&s.preventDefault(),p(),l?.type===L?t.style.cursor=z(l,c):_()},w=e.batch([{event:"antetype.cursor.on.move",subscription:{method:s=>{C()||h(s)},priority:-10}},{event:"antetype.cursor.on.slip",subscription:{method:s=>{C()||q(s)}}},{event:"antetype.cursor.on.down",subscription:{method:s=>{C()||y(s)},priority:-10}},{event:"antetype.cursor.on.up",subscription:{method:s=>{C()||T(s)},priority:-10}},{event:R.CLOSE,subscription:{method:()=>{w()}}}])}function oe({modules:e,herald:t,canvas:o},i,a){o.setAttribute("tabindex","0");let r=()=>a.delete?.disabled??!1,n=async f=>{if(!(f.target!==o&&f.target!==document.body||r())&&(f.code==="Delete"||f.code==="Backspace")){let I=i.keys();I.forEach(E=>{e.core.manage.remove(E),i.delete(E)}),v(I),await e.core.view.recalculate(),e.core.view.redraw()}},v=f=>{let I=[];f.forEach(E=>{let g=e.core.clone.getOriginal(E);I.push({origin:"cursor.delete",layer:g,data:{},undo:async C=>{e.core.manage.add(C,C.hierarchy?.parent??null,C.hierarchy?.position??null),await e.core.view.recalculate()},redo:async C=>{e.core.manage.remove(C),await e.core.view.recalculate()}})}),I.length>0&&t.dispatch(new CustomEvent(N.SAVE,{detail:{state:I}}))};return{onKeyUp:n}}var L="selection";function le(e){let{canvas:t,herald:o,modules:i}=e;if(!t)throw new Error("[Antetype Cursor] Canvas is empty!");let a=t.getContext("2d");i.core.setting.has("cursor")||i.core.setting.set("cursor",{});let r=new Proxy({},{get(P,M){return i.core.setting.get("cursor")[M]},set(P,M,O){let B=i.core.setting.get("cursor");return B[M]=O,!0}}),{drawSelection:n}=te(o,a),{selected:v,showSelected:f,isSelected:I,resetSeeThroughStackMap:E,selection:g}=$(e,r),{onDown:C,onUp:z,onMove:p,onOut:h}=ee(e,v,r);re(e,f,r,g);let{onKeyUp:b}=oe(e,v,r);t.addEventListener("mousedown",C,!1),t.addEventListener("mouseup",z,!1),t.addEventListener("mousemove",p,!1),t.addEventListener("mouseout",h,!1),t.addEventListener("keyup",b,!1);let D=o.batch([{event:R.CLOSE,subscription:()=>{t.removeEventListener("mousedown",C,!1),t.removeEventListener("mouseup",z,!1),t.removeEventListener("mousemove",p,!1),t.removeEventListener("mouseout",h,!1),t.removeEventListener("keyup",b,!1),D()}},{event:R.DRAW,subscription:P=>{let{element:M}=P.detail,B={selection:n}[M.type];typeof B=="function"&&B(M)}}]);return{drawSelection:n,selected:v,showSelected:f,isSelected:I,resetSeeThroughStackMap:E}}export{le as default,L as selectionType};
