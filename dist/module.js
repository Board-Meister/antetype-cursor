var B={INIT:"antetype.init",CLOSE:"antetype.close",DRAW:"antetype.draw",CALC:"antetype.calc",RECALC_FINISHED:"antetype.recalc.finished",MODULES:"antetype.modules",SETTINGS:"antetype.settings.definition",TYPE_DEFINITION:"antetype.layer.type.definition",FONTS_LOADED:"antetype.font.loaded",CANVAS_CHANGE:"antetype.canvas.change"};var se="core",ie="0.0.5",pe=class{#e;#t=null;#r=null;static inject={marshal:"boardmeister/marshal",herald:"boardmeister/herald"};inject(e){this.#e=e}async loadModules(e){return(await this.#a()).loadModules(e)}register(e){let{registration:t}=e.detail;t[se]={load:async()=>(this.#t??=(await this.#n("core.js")).default,c=>this.#t({modules:c,herald:this.#e.herald})),version:ie}}static subscriptions={[B.MODULES]:"register"};#n(e){return import(this.#e.marshal.getResourceUrl(this,e))}async#a(){return this.#r??=(await this.#n("helper.js")).default,new this.#r(this.#e.herald)}};var A=(e=>(e.SAVE="antetype.memento.save",e))(A||{}),ae={INIT:"antetype.init",CLOSE:"antetype.close",DRAW:"antetype.draw",CALC:"antetype.calc",RECALC_FINISHED:"antetype.recalc.finished",MODULES:"antetype.modules",SETTINGS:"antetype.settings.definition",TYPE_DEFINITION:"antetype.layer.type.definition",FONTS_LOADED:"antetype.font.loaded"},le="core",ce="0.0.5",he=class{#e;#t=null;#r=null;static inject={marshal:"boardmeister/marshal",herald:"boardmeister/herald"};inject(e){this.#e=e}async loadModules(e,t){return(await this.#a()).loadModules(e,t)}register(e){let{registration:t}=e.detail;t[le]={load:async()=>(this.#t??=(await this.#n("core.js")).default,(c,i)=>this.#t({canvas:i,modules:c,herald:this.#e.herald})),version:ce}}static subscriptions={[ae.MODULES]:"register"};#n(e){return import(this.#e.marshal.getResourceUrl(this,e))}async#a(){return this.#r??=(await this.#n("helper.js")).default,new this.#r(this.#e.herald)}};var ue="memento",fe="0.0.4",Ee=class{#e;#t=null;static inject={marshal:"boardmeister/marshal",herald:"boardmeister/herald"};inject(e){this.#e=e}register(e){let{registration:t}=e.detail;t[ue]={load:async()=>{if(!this.#t){let c=this.#e.marshal.getResourceUrl(this,"module.js");this.#t=(await import(c)).default}return(c,i)=>this.#t({canvas:i,modules:c,herald:this.#e.herald})},version:fe}}static subscriptions={[ae.MODULES]:"register"}};function F(){let e=new WeakMap,t=[],c=[],i=new WeakMap,r={get[Symbol.toStringTag](){return"IterableWeakMap"},get:a=>e.get(a),set:(a,n)=>(e.has(a)||(e.set(a,n),i.set(a,t.length),t.push(a),c.push(n)),r),delete:a=>!e.has(a)&&i.has(a)?!1:(e.has(a)&&e.delete(a),i.has(a)&&(t.splice(i.get(a),1),c.splice(i.get(a),1),i.delete(a),t.forEach((n,E)=>{i.set(n,E)})),!0),first:()=>c[0]??null,last:()=>c.slice(-1)[0]??null,firstKey:()=>t[0]??null,lastKey:()=>t.slice(-1)[0]??null,has:a=>e.has(a),keys:()=>[...t],values:()=>[...c],empty:()=>c.length==0,reset:function(){e=new WeakMap,i=new WeakMap,t=[],c=[]},clone:()=>{let a=F();return t.forEach(n=>{a.set(n,r.get(n))}),a}};return Object.freeze(r)}var k="selection";var K=(e,t)=>{let c=new CustomEvent("antetype.cursor.calc",{detail:{values:t}});return e.dispatchSync(c),c.detail.values},G=e=>{let t=0,c=0,i=0,r=0;if((e.size||e.area?.size)&&({w:t,h:c}=e.area?.size??e.size),(e.start||e.area?.start)&&({x:i,y:r}=e.area?.start??e.start),e.hierarchy?.parent){let{start:a}=G(e.hierarchy.parent);i+=a.x,r+=a.y}return{size:{w:t,h:c},start:{x:i,y:r}}},de=(e,t,{x:c,y:i},{w:r,h:a})=>e>=c&&e<=r+c&&t>=i&&t<=a+i,X=(e,t,c,i=!0,r=!1)=>{for(let a=e.length-1;a>=0;a--){let n=e[a];if(i&&n.type===k)continue;let{size:E=null,start:f=null}=G(n);if(!(!E||!f)&&de(t,c,f,E)){if(r&&n.layout){let I=X(n.layout,t,c,i,!0);if(I)return I}return n}}return null},oe=(e,t,c,i=!0)=>{let r=[];for(let a=e.length-1;a>=0;a--){let n=e[a];if(i&&n.type===k)continue;let{size:E,start:f}=G(n);!E||!n||!(t>=f.x&&t<=E.w+f.x&&c>=f.y&&c<=E.h+f.y)||r.push(n)}return r},x=e=>typeof e=="number"&&isNaN(e)||typeof e>"u",N=(e,t,c,i)=>{t=e.core.clone.getClone(t),t.area&&(x(t.area.start.x)||(t.area.start.x+=c),x(t.area.start.y)||(t.area.start.y+=i)),t.start&&(x(t.start.x)||(t.start.x+=c),x(t.start.y)||(t.start.y+=i));let r=e.core.clone.getOriginal(t);if(e.workspace){let n=e.workspace;r.start&&(x(r.start.x)||(r.start.x=n.toRelative(t.start.x)),x(r.start.y)||(r.start.y=n.toRelative(t.start.y,"y")));return}let a=t.area?.start??t.start;a&&r.start&&(x(r.start.x)||(r.start.x=a.x),x(r.start.y)||(r.start.y=a.y)),a&&r.area?.start&&(x(r.area.start.x)||(r.area.start.x=a.x),x(r.area.start.y)||(r.area.start.y=a.y))};function Q(e){return e.type===k?e.selection.layer:e}function $({modules:e,herald:t},c){let i=F(),r={layers:[]},a=!1,n=!1,E=!1,f=0,I=0,b=F(),p=e.core,M={moveBuffer:5},L=()=>c.select?.disabled??!1,y=()=>{for(;!i.empty();)i.delete(i.firstKey())},w=()=>{b=F()},g=h=>{let T=p.clone.getOriginal(h);return i.has(T)?T:!1},C=h=>{for(let T of h){let S=p.clone.getOriginal(T);if(i.has(S))return S}return!1},P=()=>{let h=i.keys(),T=[];h.forEach(S=>{let o=e.core.clone.getClone(S);T.push({origin:"cursor.move",layer:S,data:{x:o.area.start.x,y:o.area.start.y,after:{x:0,y:0}},undo:(u,l)=>{let s=e.core.clone.getClone(u);l.after.x=s.area.start.x,l.after.y=s.area.start.y,N(e,u,l.x-s.area.start.x,l.y-s.area.start.y)},redo:(u,l)=>{N(e,u,l.after.x-l.x,l.after.y-l.y)}})}),T.length>0&&t.dispatch(new CustomEvent(A.SAVE,{detail:{state:T}}))},m=h=>{if(!E)return!1;let{origin:{movementX:T,movementY:S}}=h.detail;return f+=T,I+=S,Math.abs(f)>M.moveBuffer||Math.abs(I)>M.moveBuffer?(E=!1,!1):!0},O=h=>{if(h.defaultPrevented||!a||m(h))return;let T=!n;n=!0;let{target:{down:S,hover:{mY:o,mX:u,layer:l}}}=h.detail;if(S.layers.length===0){!S.shiftKey&&!S.ctrlKey&&(y(),z());return}!(l&&C([l]))&&!S.shiftKey&&!S.ctrlKey&&y();let d=p.clone.getOriginal(S.layers[0]);i.set(d,!0),T&&P(),i.keys().forEach(v=>{if(v.hierarchy?.parent!==e.core.meta.document)return;let D=e.workspace?e.workspace.getScale():1;N(e,v,u/D,o/D)}),z()},R=h=>{if(h.defaultPrevented||h.detail.origin.button!==0)return;if(f=0,I=0,E=!0,a=!1,n){n=!1;return}let{target:{down:T}}=h.detail,{shiftKey:S,ctrlKey:o}=T;!S&&!o&&y();let u=!0,l=!1;for(let s of T.layers){let d=e.core.clone.getOriginal(s);if(i.has(d)&&o){i.delete(d);break}if(!b.has(d)){i.set(d,!0),l=!0,u&&w(),b.set(d,!0);break}u=!1}l||(b=F()),z()},z=()=>{for(let h of r.layers)p.manage.removeVolatile(h);r.layers=[];for(let h of i.keys()){let{size:T,start:S}=G(p.clone.getClone(h)),o={type:k,size:T,start:S,selection:{layer:h}};r.layers.push(o),p.manage.addVolatile(o)}p.view.redraw()},j=h=>{h.defaultPrevented||h.detail.origin.button!==0||(a=!0,E=!1)},q=t.batch([{event:"antetype.cursor.on.down",subscription:h=>{L()||j(h)}},{event:"antetype.cursor.on.up",subscription:h=>{L()||R(h)}},{event:"antetype.cursor.on.move",subscription:h=>{L()||O(h)}},{event:B.CLOSE,subscription:{method:()=>{q()}}}]);return{selected:i,selection:r,isSelected:g,showSelected:z,resetSeeThroughStackMap:w}}function ee({herald:e,modules:{core:t}},c,i){let r={selected:c,isDown:!1,wasMoved:!1,down:{layers:[],x:0,y:0,shiftKey:!1,ctrlKey:!1},hover:{layer:null,deep:null,x:0,y:0,mX:0,mY:0}},a=()=>t.meta.getCanvas(),n=()=>i.detect?.disabled??!1,E=async(y,w)=>{let g=a();if(g instanceof HTMLCanvasElement){let P=g.getBoundingClientRect();y-=P.left,w-=P.top}let C=new CustomEvent("antetype.cursor.position",{detail:{x:y,y:w}});return await e.dispatch(C),C.detail},f=async y=>{if(n())return;r.isDown=!0,r.wasMoved=!1;let{clientX:w,clientY:g}=y,{shiftKey:C,ctrlKey:P}=y,m=t.meta.document.layout;({x:w,y:g}=await E(w,g)),await p(y,m,w,g,0,0),r.down.x=w,r.down.y=g,r.down.shiftKey=C,r.down.ctrlKey=P,r.down.layers=oe(m,w,g),e.dispatch(new CustomEvent("antetype.cursor.on.down",{detail:{origin:y,target:r},cancelable:!0}))},I=async y=>{n()||(r.isDown=!1,await e.dispatch(new CustomEvent("antetype.cursor.on.up",{detail:{origin:y,target:r},cancelable:!0})),M(),await b(y))},b=async y=>{if(n())return;r.wasMoved=!0;let w=t.meta.document.layout,{clientX:g,clientY:C,movementX:P,movementY:m}=y;({x:g,y:C}=await E(g,C)),{movementX:P,movementY:m}=K(e,{movementX:P,movementY:m}),await p(y,w,g,C,P,m),await e.dispatch(new CustomEvent("antetype.cursor.on.move",{detail:{origin:y,target:r},cancelable:!0}))},p=async(y,w,g,C,P,m)=>{let O=X(w,g,C,!0),R=X(w,g,C,!0,!0);r.hover.x=g,r.hover.y=C,r.hover.mY=m,r.hover.mX=P,O!==r.hover.layer&&await e.dispatch(new CustomEvent("antetype.cursor.on.slip",{detail:{origin:y,target:r,from:r.hover.layer,to:O},cancelable:!0})),r.hover.layer=O,r.hover.deep=R},M=()=>{r.down.x=0,r.down.y=0,r.down.shiftKey=!1,r.down.ctrlKey=!1,r.down.layers=[]};return{onDown:f,onUp:I,onMove:b,onOut:async y=>{await e.dispatch(new CustomEvent("antetype.cursor.on.slip",{detail:{origin:y,target:r,from:r.hover.layer,to:null},cancelable:!0})),r.hover.layer=null,r.hover.deep=null}}}function te(e,t){let c=(r,a,n,E,f,I)=>{let b=t.meta.getCanvas();if(!b)return;let p=b.getContext("2d");p.save(),p.beginPath(),p.moveTo(r,a),p.lineTo(r+n,a),p.lineTo(r+n,a+E),p.lineTo(r,a+E),p.closePath(),p.lineWidth=f,p.strokeStyle=I,p.stroke(),p.restore()};return{drawSelection:({start:{x:r,y:a},size:{w:n,h:E}})=>{let f=K(e,{unit:1}).unit;c(r-f*2,a-f*2,n+f*4,E+f*4,f,"#FFF"),c(r-f,a-f,n+f*2,E+f*2,f,"#1e272e")}}}function re({herald:e,modules:t},c,i,r){let a=()=>t.core.meta.getCanvas(),n=8,E=!1,f=!1,I=!1,b={waiting:!1,layout:null,movement:null},p=o=>{if(!o.hover.layer)return null;let u=t.core.clone.getOriginal;for(let l of r.layers)if(u(o.hover.layer)===u(Q(l)))return l;return null},M=()=>i.resize?.disabled??!1,L=(o,u)=>{if(!o||o.selection.layer.hierarchy?.parent!==t.core.meta.document)return n=8,"default";let{start:{x:l,y:s},size:{h:d,w:v}}=o,{x:D,y:H}=u.hover,W=K(e,{bufferTop:i.resize?.buffer??10}).bufferTop,_=0,U=H<=s+W&&H>=s-_,Y=D<=l+_+v&&D>=l-W+v,Z=H<=s+_+d&&H>=s-W+d,V=D<=l+W&&D>=l-_;return U&&V||Z&&Y?(n=U&&V?6:5,"nwse-resize"):U&&Y||Z&&V?(n=U&&Y?4:7,"nesw-resize"):U||Z?(n=U?0:1,"ns-resize"):V||Y?(n=V?3:2,"ew-resize"):(y(),"pointer")},y=()=>{n=8},w=o=>{if(E)return;let u=p(o.detail.target);if(u){let l=Q(t.core.clone.getClone(u));if(!t.core.clone.getOriginal(l)?.size)return}z(o),g(o)},g=o=>{let{target:u}=o.detail,l=u.selected.keys();if(l.length===0||n===8||!u.isDown)return;let{hover:{mX:s,mY:d}}=u;(n===3||n===2)&&(d=0),(n===0||n===1)&&(s=0);let v=t.workspace?t.workspace.getScale():1;if(s/=v,d/=v,f){b.waiting=!0,b.movement={x:s,y:d},b.layout=l;return}m(l),C(l,s,d)},C=(o,u,l)=>{let s=v=>{if(f=!1,b.waiting){let{layout:D,movement:H}=b,{x:W,y:_}=H;R(),C(D,W,_)}else e.dispatch(new CustomEvent("antetype.cursor.on.resized",{detail:{layout:o,success:v}}))};f=!0;let d=[];try{for(let D of o)d.push(P(D,u,l));let v=Promise.all(d);return v.then(()=>{s(!0)}).catch(()=>{s(!1)}),v}catch(v){throw s(!1),v}},P=(o,u,l)=>{let s=t.core.clone.getClone(o);if(s.hierarchy?.parent===t.core.meta.document)return n!==5&&n!==2&&n!==1&&N(t,s,n===4?0:u,n===7?0:l),(n===0||n===6||n===4)&&(l*=-1),(n===3||n===6||n===7)&&(u*=-1),O(s,u,l)},m=o=>{if(I)return;I=!0;let u=[];o.forEach(l=>{let s=t.core.clone.getClone(l);u.push({origin:"cursor.move",layer:l,data:{x:s.start.x,y:s.start.y,w:s.size.w,h:s.size.h,after:{w:0,h:0,x:0,y:0}},undo:async(d,v)=>{let D=t.core.clone.getClone(d);v.after.x=D.start.x,v.after.y=D.start.y,N(t,d,v.x-D.start.x,v.y-D.start.y),v.after.w=D.size.w,v.after.h=D.size.h,await O(d,v.w-D.size.w,v.h-D.size.h)},redo:async(d,v)=>{N(t,d,v.after.x-v.x,v.after.y-v.y),await O(d,v.after.w-v.w,v.after.h-v.h)}})}),u.length>0&&e.dispatch(new CustomEvent(A.SAVE,{detail:{state:u}}))},O=async(o,u,l)=>{if(!o.size)return;let s=t.core.clone.getClone(o);if(x(s.size.w)||(s.size.w+=u),x(s.size.h)||(s.size.h+=l),s.area&&(x(s.area.size.w)||(s.area.size.w+=u),x(s.area.size.h)||(s.area.size.h+=l)),o=t.core.clone.getOriginal(s),t.workspace){let d=t.workspace;o.size.w=d.toRelative(s.area.size.w),o.size.h=d.toRelative(s.area.size.h,"y")}else{let d=s.area?.size??s.size;o.size.w=d.w,o.size.h=d.h,o.area&&(o.area.size.w=d.w,o.area.size.h=d.h)}await t.core.view.resize(o,o.size),c(),t.core.view.redraw()},R=()=>{b.waiting=!1,b.movement=null,b.layout=null},z=o=>{let{target:u}=o.detail;if(n!==8&&(o.preventDefault(),u.isDown))return;let l=p(u);if(l?.type===k){let s=a();s instanceof HTMLCanvasElement&&(s.style.cursor=L(l,u))}else j(),y()},j=()=>{let o=a();o instanceof HTMLCanvasElement&&(o.style.cursor="default")},q=o=>{let{from:u,target:{isDown:l}}=o.detail;l&&n!==8||(y(),u?.type===k&&j())},h=o=>{let{target:u}=o.detail,l=p(u);if(l?.type===k){let s=a();s instanceof HTMLCanvasElement&&(s.style.cursor=L(l,u))}else y();if(n===8){E=!0;return}o.preventDefault()},T=o=>{I=!1,E=!1;let{target:u}=o.detail,l=p(u);if(n!==8&&o.preventDefault(),y(),l?.type===k){let s=a();s instanceof HTMLCanvasElement&&(s.style.cursor=L(l,u))}else j()},S=e.batch([{event:"antetype.cursor.on.move",subscription:{method:o=>{M()||w(o)},priority:-10}},{event:"antetype.cursor.on.slip",subscription:{method:o=>{M()||q(o)}}},{event:"antetype.cursor.on.down",subscription:{method:o=>{M()||h(o)},priority:-10}},{event:"antetype.cursor.on.up",subscription:{method:o=>{M()||T(o)},priority:-10}},{event:B.CLOSE,subscription:{method:()=>{S()}}}])}function ne({modules:e,herald:t},c,i){let r=()=>i.delete?.disabled??!1,a=async f=>{f.forEach(I=>{e.core.manage.remove(I),c.delete(I)}),E(f),await e.core.view.recalculate(),e.core.view.redraw()},n=async f=>{let I=e.core.meta.getCanvas();f.target!==I&&f.target!==document.body||r()||(f.code==="Delete"||f.code==="Backspace")&&await a(c.keys())},E=f=>{let I=[];f.forEach(b=>{let p=e.core.clone.getOriginal(b);I.push({origin:"cursor.delete",layer:p,data:{},undo:async M=>{e.core.manage.add(M,M.hierarchy?.parent??null,M.hierarchy?.position??null),await e.core.view.recalculate()},redo:async M=>{e.core.manage.remove(M),await e.core.view.recalculate()}})}),I.length>0&&t.dispatch(new CustomEvent(A.SAVE,{detail:{state:I}}))};return{onKeyUp:n,remove:a,events:[{event:B.CANVAS_CHANGE,subscription:({detail:{current:f}})=>{f instanceof HTMLCanvasElement&&f.setAttribute("tabindex","0")}}]}}function ve(e){let{herald:t,modules:c}=e;c.core.setting.has("cursor")||c.core.setting.set("cursor",{});let i=new Proxy({},{get(m,O){return c.core.setting.get("cursor")[O]},set(m,O,R){let z=c.core.setting.get("cursor");return z[O]=R,!0}}),{drawSelection:r}=te(t,c.core),{selected:a,showSelected:n,isSelected:E,resetSeeThroughStackMap:f,selection:I}=$(e,i),{onDown:b,onUp:p,onMove:M,onOut:L}=ee(e,a,i);re(e,n,i,I);let{onKeyUp:y,events:w}=ne(e,a,i),g=m=>{m instanceof HTMLCanvasElement&&(m.addEventListener("mousedown",b,!1),m.addEventListener("mouseup",p,!1),m.addEventListener("mousemove",M,!1),m.addEventListener("mouseout",L,!1),m.addEventListener("keyup",y,!1))},C=m=>{m instanceof HTMLCanvasElement&&(m.removeEventListener("mousedown",b,!1),m.removeEventListener("mouseup",p,!1),m.removeEventListener("mousemove",M,!1),m.removeEventListener("mouseout",L,!1),m.removeEventListener("keyup",y,!1))},P=t.batch([{event:B.CANVAS_CHANGE,subscription:({detail:{previous:m,current:O}})=>{C(m),g(O)}},{event:B.CLOSE,subscription:()=>{C(c.core.meta.getCanvas()),P()}},{event:B.DRAW,subscription:m=>{let{element:O}=m.detail,z={selection:r}[O.type];typeof z=="function"&&z(O)}},...w]);return{drawSelection:r,selected:a,showSelected:n,isSelected:E,resetSeeThroughStackMap:f}}export{ve as default};
