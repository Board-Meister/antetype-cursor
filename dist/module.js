var A={INIT:"antetype.init",CLOSE:"antetype.close",DRAW:"antetype.draw",CALC:"antetype.calc",RECALC_FINISHED:"antetype.recalc.finished",MODULES:"antetype.modules",SETTINGS:"antetype.settings.definition",TYPE_DEFINITION:"antetype.layer.type.definition",FONTS_LOADED:"antetype.font.loaded",CANVAS_CHANGE:"antetype.canvas.change"},de=Symbol("original"),pe=Symbol("clone");var me=Symbol("layer");var oe="core",se="0.0.5",ye=class{#e;#t=null;#n=!1;#r=null;static inject={marshal:"boardmeister/marshal",herald:"boardmeister/herald"};inject(e){this.#e=e}async loadModules(e){return(await this.#o()).loadModules(e)}register(e){let{registration:r}=e.detail;r[oe]={load:async()=>(!this.#t&&!this.#n&&(this.#n=new Promise(i=>{this.#a("core.js").then(s=>{this.#t=s.default,this.#n=!1,i()})})),this.#n&&await this.#n,console.log("load module3",this.#t),i=>this.#t({modules:i,herald:this.#e.herald})),version:se}}static subscriptions={[A.MODULES]:"register"};#a(e){return import(this.#e.marshal.getResourceUrl(this,e))}async#o(){return this.#r??=(await this.#a("helper.js")).default,new this.#r(this.#e.herald)}};var F=(e=>(e.SAVE="antetype.memento.save",e))(F||{}),re={INIT:"antetype.init",CLOSE:"antetype.close",DRAW:"antetype.draw",CALC:"antetype.calc",RECALC_FINISHED:"antetype.recalc.finished",MODULES:"antetype.modules",SETTINGS:"antetype.settings.definition",TYPE_DEFINITION:"antetype.layer.type.definition",FONTS_LOADED:"antetype.font.loaded"},ie="core",le="0.0.5",Ie=class{#e;#t=null;#n=null;static inject={marshal:"boardmeister/marshal",herald:"boardmeister/herald"};inject(e){this.#e=e}async loadModules(e,r){return(await this.#a()).loadModules(e,r)}register(e){let{registration:r}=e.detail;r[ie]={load:async()=>(this.#t??=(await this.#r("core.js")).default,(i,s)=>this.#t({canvas:s,modules:i,herald:this.#e.herald})),version:le}}static subscriptions={[re.MODULES]:"register"};#r(e){return import(this.#e.marshal.getResourceUrl(this,e))}async#a(){return this.#n??=(await this.#r("helper.js")).default,new this.#n(this.#e.herald)}};var ce="memento",ue="0.0.4",ge=class{#e;#t=null;static inject={marshal:"boardmeister/marshal",herald:"boardmeister/herald"};inject(e){this.#e=e}register(e){let{registration:r}=e.detail;r[ce]={load:async()=>{if(!this.#t){let i=this.#e.marshal.getResourceUrl(this,"module.js");this.#t=(await import(i)).default}return(i,s)=>this.#t({canvas:s,modules:i,herald:this.#e.herald})},version:ue}}static subscriptions={[re.MODULES]:"register"}};function H(){let e=new WeakMap,r=[],i=[],s=new WeakMap,t={get[Symbol.toStringTag](){return"IterableWeakMap"},get:a=>e.get(a),set:(a,n)=>(e.has(a)||(e.set(a,n),s.set(a,r.length),r.push(a),i.push(n)),t),delete:a=>!e.has(a)&&s.has(a)?!1:(e.has(a)&&e.delete(a),s.has(a)&&(r.splice(s.get(a),1),i.splice(s.get(a),1),s.delete(a),r.forEach((n,h)=>{s.set(n,h)})),!0),first:()=>i[0]??null,last:()=>i.slice(-1)[0]??null,firstKey:()=>r[0]??null,lastKey:()=>r.slice(-1)[0]??null,has:a=>e.has(a),keys:()=>[...r],values:()=>[...i],empty:()=>i.length==0,reset:function(){e=new WeakMap,s=new WeakMap,r=[],i=[]},clone:()=>{let a=H();return r.forEach(n=>{a.set(n,t.get(n))}),a}};return Object.freeze(t)}var B="selection";var j=(e,r)=>{let i=new CustomEvent("antetype.cursor.calc",{detail:{values:r}});return e.dispatchSync(i),i.detail.values},G=e=>{let r=0,i=0,s=0,t=0;if((e.size||e.area?.size)&&({w:r,h:i}=e.area?.size??e.size),(e.start||e.area?.start)&&({x:s,y:t}=e.area?.start??e.start),e.hierarchy?.parent){let{start:a}=G(e.hierarchy.parent);s+=a.x,t+=a.y}return{size:{w:r,h:i},start:{x:s,y:t}}},fe=(e,r,{x:i,y:s},{w:t,h:a})=>e>=i&&e<=t+i&&r>=s&&r<=a+s,X=(e,r,i,s=!0,t=!1)=>{for(let a=e.length-1;a>=0;a--){let n=e[a];if(s&&n.type===B)continue;let{size:h=null,start:f=null}=G(n);if(!(!h||!f)&&fe(r,i,f,h)){if(t&&n.layout){let g=X(n.layout,r,i,s,!0);if(g)return g}return n}}return null},ae=(e,r,i,s=!0)=>{let t=[];for(let a=e.length-1;a>=0;a--){let n=e[a];if(s&&n.type===B)continue;let{size:h,start:f}=G(n);!h||!n||!(r>=f.x&&r<=h.w+f.x&&i>=f.y&&i<=h.h+f.y)||t.push(n)}return t},x=e=>typeof e=="number"&&isNaN(e)||typeof e>"u",N=(e,r,i,s)=>{r=e.core.clone.getClone(r),r.area&&(x(r.area.start.x)||(r.area.start.x+=i),x(r.area.start.y)||(r.area.start.y+=s)),r.start&&(x(r.start.x)||(r.start.x+=i),x(r.start.y)||(r.start.y+=s));let t=e.core.clone.getOriginal(r);if(e.workspace){let n=e.workspace;t.start&&(x(t.start.x)||(t.start.x=n.toRelative(r.start.x)),x(t.start.y)||(t.start.y=n.toRelative(r.start.y,"y")));return}let a=r.area?.start??r.start;a&&t.start&&(x(t.start.x)||(t.start.x=a.x),x(t.start.y)||(t.start.y=a.y)),a&&t.area?.start&&(x(t.area.start.x)||(t.area.start.x=a.x),x(t.area.start.y)||(t.area.start.y=a.y))};function J(e){return e.type===B?e.selection.layer:e}function Q({modules:e},r,i){let s=H(),t={layers:[]},a=!1,n=!1,h=!1,f=0,g=0,b=H(),E=e.core,M={moveBuffer:5},R=()=>r.select?.disabled??!1,I=()=>{for(;!s.empty();)s.delete(s.firstKey())},C=()=>{b=H()},w=v=>{let p=E.clone.getOriginal(v);return s.has(p)?p:!1},D=v=>{for(let p of v){let S=E.clone.getOriginal(p);if(s.has(S))return S}return!1},O=()=>{let v=s.keys(),p=[];v.forEach(S=>{let o=e.core.clone.getClone(S);p.push({origin:"cursor.move",layer:S,data:{x:o.area.start.x,y:o.area.start.y,after:{x:0,y:0}},undo:(c,u)=>{let l=e.core.clone.getClone(c);u.after.x=l.area.start.x,u.after.y=l.area.start.y,N(e,c,u.x-l.area.start.x,u.y-l.area.start.y)},redo:(c,u)=>{N(e,c,u.after.x-u.x,u.after.y-u.y)}})}),p.length>0&&i.dispatch(new CustomEvent(F.SAVE,{detail:{state:p}}))},L=v=>{if(!h)return!1;let{origin:{movementX:p,movementY:S}}=v.detail;return f+=p,g+=S,Math.abs(f)>M.moveBuffer||Math.abs(g)>M.moveBuffer?(h=!1,!1):!0},z=v=>{if(v.defaultPrevented||!a||L(v))return;let p=!n;n=!0;let{target:{down:S,hover:{mY:o,mX:c,layer:u}}}=v.detail;if(S.layers.length===0){!S.shiftKey&&!S.ctrlKey&&(I(),d());return}!(u&&D([u]))&&!S.shiftKey&&!S.ctrlKey&&I();let m=E.clone.getOriginal(S.layers[0]);s.set(m,!0),p&&O(),s.keys().forEach(y=>{if(y.hierarchy?.parent!==e.core.meta.document)return;let T=e.workspace?e.workspace.getScale():1;N(e,y,c/T,o/T)}),d()},k=v=>{if(v.defaultPrevented||v.detail.origin.button!==0)return;if(f=0,g=0,h=!0,a=!1,n){n=!1;return}let{target:{down:p}}=v.detail,{shiftKey:S,ctrlKey:o}=p;!S&&!o&&I();let c=!0,u=!1;for(let l of p.layers){let m=e.core.clone.getOriginal(l);if(s.has(m)&&o){s.delete(m);break}if(!b.has(m)){s.set(m,!0),u=!0,c&&C(),b.set(m,!0);break}c=!1}u||(b=H()),d()},d=()=>{for(let v of t.layers)E.manage.removeVolatile(v);t.layers=[];for(let v of s.keys()){let{size:p,start:S}=G(E.clone.getClone(v)),o={type:B,size:p,start:S,selection:{layer:v}};t.layers.push(o),E.manage.addVolatile(o)}E.view.redraw()},P=v=>{v.defaultPrevented||v.detail.origin.button!==0||(a=!0,h=!1)};return{selected:s,selection:t,isSelected:w,showSelected:d,resetSeeThroughStackMap:C,events:(v=null)=>[{event:"antetype.cursor.on.down",subscription:p=>{R()||P(p)},anchor:v},{event:"antetype.cursor.on.up",subscription:p=>{R()||k(p)},anchor:v},{event:"antetype.cursor.on.move",subscription:p=>{R()||z(p)},anchor:v}]}}function $({modules:{core:e}},r,i,s){let t={selected:r,isDown:!1,wasMoved:!1,down:{layers:[],x:0,y:0,shiftKey:!1,ctrlKey:!1},hover:{layer:null,deep:null,x:0,y:0,mX:0,mY:0}},a=()=>e.meta.getCanvas(),n=()=>i.detect?.disabled??!1,h=async(I,C)=>{let w=a();if(w instanceof HTMLCanvasElement){let O=w.getBoundingClientRect();I-=O.left,C-=O.top}let D=new CustomEvent("antetype.cursor.position",{detail:{x:I,y:C}});return await s.dispatch(D),D.detail},f=async I=>{if(n())return;t.isDown=!0,t.wasMoved=!1;let{clientX:C,clientY:w}=I,{shiftKey:D,ctrlKey:O}=I,L=e.meta.document.layout;({x:C,y:w}=await h(C,w)),await E(I,L,C,w,0,0),t.down.x=C,t.down.y=w,t.down.shiftKey=D,t.down.ctrlKey=O,t.down.layers=ae(L,C,w),s.dispatch(new CustomEvent("antetype.cursor.on.down",{detail:{origin:I,target:t},cancelable:!0}))},g=async I=>{n()||(t.isDown=!1,await s.dispatch(new CustomEvent("antetype.cursor.on.up",{detail:{origin:I,target:t},cancelable:!0})),M(),await b(I))},b=async I=>{if(n())return;t.wasMoved=!0;let C=e.meta.document.layout,{clientX:w,clientY:D,movementX:O,movementY:L}=I;({x:w,y:D}=await h(w,D)),{movementX:O,movementY:L}=j(s,{movementX:O,movementY:L}),await E(I,C,w,D,O,L),await s.dispatch(new CustomEvent("antetype.cursor.on.move",{detail:{origin:I,target:t},cancelable:!0}))},E=async(I,C,w,D,O,L)=>{let z=X(C,w,D,!0),k=X(C,w,D,!0,!0);t.hover.x=w,t.hover.y=D,t.hover.mY=L,t.hover.mX=O,z!==t.hover.layer&&await s.dispatch(new CustomEvent("antetype.cursor.on.slip",{detail:{origin:I,target:t,from:t.hover.layer,to:z},cancelable:!0})),t.hover.layer=z,t.hover.deep=k},M=()=>{t.down.x=0,t.down.y=0,t.down.shiftKey=!1,t.down.ctrlKey=!1,t.down.layers=[]};return{onDown:f,onUp:g,onMove:b,onOut:async I=>{await s.dispatch(new CustomEvent("antetype.cursor.on.slip",{detail:{origin:I,target:t,from:t.hover.layer,to:null},cancelable:!0})),t.hover.layer=null,t.hover.deep=null}}}function ee(e,r){let i=(t,a,n,h,f,g)=>{let b=r.meta.getCanvas();if(!b)return;let E=b.getContext("2d");E.save(),E.beginPath(),E.moveTo(t,a),E.lineTo(t+n,a),E.lineTo(t+n,a+h),E.lineTo(t,a+h),E.closePath(),E.lineWidth=f,E.strokeStyle=g,E.stroke(),E.restore()};return{drawSelection:({start:{x:t,y:a},size:{w:n,h}})=>{let f=j(e,{unit:1}).unit;i(t-f*2,a-f*2,n+f*4,h+f*4,f,"#FFF"),i(t-f,a-f,n+f*2,h+f*2,f,"#1e272e")}}}function te({modules:e},r,i,s,t){let a=()=>e.core.meta.getCanvas(),n=8,h=!1,f=!1,g=!1,b={waiting:!1,layout:null,movement:null},E=o=>{if(!o.hover.layer)return null;let c=e.core.clone.getOriginal;for(let u of s.layers)if(c(o.hover.layer)===c(J(u)))return u;return null},M=()=>i.resize?.disabled??!1,R=(o,c)=>{if(!o||o.selection.layer.hierarchy?.parent!==e.core.meta.document)return n=8,"default";let{start:{x:u,y:l},size:{h:m,w:y}}=o,{x:T,y:_}=c.hover,W=j(t,{bufferTop:i.resize?.buffer??10}).bufferTop,U=0,K=_<=l+W&&_>=l-U,Y=T<=u+U+y&&T>=u-W+y,q=_<=l+U+m&&_>=l-W+m,V=T<=u+W&&T>=u-U;return K&&V||q&&Y?(n=K&&V?6:5,"nwse-resize"):K&&Y||q&&V?(n=K&&Y?4:7,"nesw-resize"):K||q?(n=K?0:1,"ns-resize"):V||Y?(n=V?3:2,"ew-resize"):(I(),"pointer")},I=()=>{n=8},C=o=>{if(h)return;let c=E(o.detail.target);if(c){let u=J(e.core.clone.getClone(c));if(!e.core.clone.getOriginal(u)?.size)return}d(o),w(o)},w=o=>{let{target:c}=o.detail,u=c.selected.keys();if(u.length===0||n===8||!c.isDown)return;let{hover:{mX:l,mY:m}}=c;(n===3||n===2)&&(m=0),(n===0||n===1)&&(l=0);let y=e.workspace?e.workspace.getScale():1;if(l/=y,m/=y,f){b.waiting=!0,b.movement={x:l,y:m},b.layout=u;return}L(u),D(u,l,m)},D=(o,c,u)=>{let l=y=>{if(f=!1,b.waiting){let{layout:T,movement:_}=b,{x:W,y:U}=_;k(),D(T,W,U)}else t.dispatch(new CustomEvent("antetype.cursor.on.resized",{detail:{layout:o,success:y}}))};f=!0;let m=[];try{for(let T of o)m.push(O(T,c,u));let y=Promise.all(m);return y.then(()=>{l(!0)}).catch(()=>{l(!1)}),y}catch(y){throw l(!1),y}},O=(o,c,u)=>{let l=e.core.clone.getClone(o);if(l.hierarchy?.parent===e.core.meta.document)return n!==5&&n!==2&&n!==1&&N(e,l,n===4?0:c,n===7?0:u),(n===0||n===6||n===4)&&(u*=-1),(n===3||n===6||n===7)&&(c*=-1),z(l,c,u)},L=o=>{if(g)return;g=!0;let c=[];o.forEach(u=>{let l=e.core.clone.getClone(u);c.push({origin:"cursor.move",layer:u,data:{x:l.start.x,y:l.start.y,w:l.size.w,h:l.size.h,after:{w:0,h:0,x:0,y:0}},undo:async(m,y)=>{let T=e.core.clone.getClone(m);y.after.x=T.start.x,y.after.y=T.start.y,N(e,m,y.x-T.start.x,y.y-T.start.y),y.after.w=T.size.w,y.after.h=T.size.h,await z(m,y.w-T.size.w,y.h-T.size.h)},redo:async(m,y)=>{N(e,m,y.after.x-y.x,y.after.y-y.y),await z(m,y.after.w-y.w,y.after.h-y.h)}})}),c.length>0&&t.dispatch(new CustomEvent(F.SAVE,{detail:{state:c}}))},z=async(o,c,u)=>{if(!o.size)return;let l=e.core.clone.getClone(o);if(x(l.size.w)||(l.size.w+=c),x(l.size.h)||(l.size.h+=u),l.area&&(x(l.area.size.w)||(l.area.size.w+=c),x(l.area.size.h)||(l.area.size.h+=u)),o=e.core.clone.getOriginal(l),e.workspace){let m=e.workspace;o.size.w=m.toRelative(l.area.size.w),o.size.h=m.toRelative(l.area.size.h,"y")}else{let m=l.area?.size??l.size;o.size.w=m.w,o.size.h=m.h,o.area&&(o.area.size.w=m.w,o.area.size.h=m.h)}await e.core.view.resize(o,o.size),r(),e.core.view.redraw()},k=()=>{b.waiting=!1,b.movement=null,b.layout=null},d=o=>{let{target:c}=o.detail;if(n!==8&&(o.preventDefault(),c.isDown))return;let u=E(c);if(u?.type===B){let l=a();l instanceof HTMLCanvasElement&&(l.style.cursor=R(u,c))}else P(),I()},P=()=>{let o=a();o instanceof HTMLCanvasElement&&(o.style.cursor="default")},v=o=>{let{from:c,target:{isDown:u}}=o.detail;u&&n!==8||(I(),c?.type===B&&P())},p=o=>{let{target:c}=o.detail,u=E(c);if(u?.type===B){let l=a();l instanceof HTMLCanvasElement&&(l.style.cursor=R(u,c))}else I();if(n===8){h=!0;return}o.preventDefault()},S=o=>{g=!1,h=!1;let{target:c}=o.detail,u=E(c);if(n!==8&&o.preventDefault(),I(),u?.type===B){let l=a();l instanceof HTMLCanvasElement&&(l.style.cursor=R(u,c))}else P()};return{events:(o=null)=>[{event:"antetype.cursor.on.move",subscription:{method:c=>{M()||C(c)},priority:-10},anchor:o},{event:"antetype.cursor.on.slip",subscription:{method:c=>{M()||v(c)}},anchor:o},{event:"antetype.cursor.on.down",subscription:{method:c=>{M()||p(c)},priority:-10},anchor:o},{event:"antetype.cursor.on.up",subscription:{method:c=>{M()||S(c)},priority:-10},anchor:o}]}}function ne({modules:e},r,i,s){let t=()=>i.delete?.disabled??!1,a=async f=>{f.forEach(g=>{e.core.manage.remove(g),r.delete(g)}),h(f),await e.core.view.recalculate(),e.core.view.redraw()},n=async f=>{let g=e.core.meta.getCanvas();f.target!==g&&f.target!==document.body||t()||(f.code==="Delete"||f.code==="Backspace")&&await a(r.keys())},h=f=>{let g=[];f.forEach(b=>{let E=e.core.clone.getOriginal(b);g.push({origin:"cursor.delete",layer:E,data:{},undo:async M=>{e.core.manage.add(M,M.hierarchy?.parent??null,M.hierarchy?.position??null),await e.core.view.recalculate()},redo:async M=>{e.core.manage.remove(M),await e.core.view.recalculate()}})}),g.length>0&&s.dispatch(new CustomEvent(F.SAVE,{detail:{state:g}}))};return{onKeyUp:n,remove:a,events:(f=null)=>[{event:A.CANVAS_CHANGE,subscription:({detail:{current:g}})=>{g instanceof HTMLCanvasElement&&g.setAttribute("tabindex","0")},anchor:f}]}}function ve(e){let{herald:r,modules:i}=e,s={_canvas:()=>i.core.meta.getCanvas(),dispatch:(d,P={})=>r.dispatch(d,{origin:s._canvas(),...P}),dispatchSync:(d,P={})=>{r.dispatchSync(d,{origin:s._canvas(),...P})}};i.core.setting.has("cursor")||i.core.setting.set("cursor",{});let t=new Proxy({},{get(d,P){return i.core.setting.get("cursor")[P]},set(d,P,v){let p=i.core.setting.get("cursor");return p[P]=v,!0}}),{drawSelection:a}=ee(r,i.core),{selected:n,showSelected:h,isSelected:f,resetSeeThroughStackMap:g,selection:b,events:E}=Q(e,t,s),{onDown:M,onUp:R,onMove:I,onOut:C}=$(e,n,t,s),{events:w}=te(e,h,t,b,s),{onKeyUp:D,events:O}=ne(e,n,t,s),L=d=>{d instanceof HTMLCanvasElement&&(d.addEventListener("mousedown",M,!1),d.addEventListener("mouseup",R,!1),d.addEventListener("mousemove",I,!1),d.addEventListener("mouseout",C,!1),d.addEventListener("keyup",D,!1))},z=d=>{d instanceof HTMLCanvasElement&&(d.removeEventListener("mousedown",M,!1),d.removeEventListener("mouseup",R,!1),d.removeEventListener("mousemove",I,!1),d.removeEventListener("mouseout",C,!1),d.removeEventListener("keyup",D,!1))},k=(d=null)=>{d??=i.core.meta.getCanvas();let P=r.batch([{event:A.CANVAS_CHANGE,subscription:({detail:{previous:v,current:p}})=>{z(v),L(p),P(),k(p)},anchor:d},{event:A.CLOSE,subscription:()=>{z(i.core.meta.getCanvas()),P()},anchor:d},{event:A.DRAW,subscription:v=>{let{element:p}=v.detail,o={selection:a}[p.type];typeof o=="function"&&o(p)},anchor:d},...O(d),...E(d),...w(d)])};return k(),{drawSelection:a,selected:n,showSelected:h,isSelected:f,resetSeeThroughStackMap:g}}export{ve as default};
